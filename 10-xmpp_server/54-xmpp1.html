<meta http-equiv="content-type" content="text/html;charset=utf-8" />


<h1>Správa linuxového serveru: XMPP (Jabber) server Prosody</h1>

<p>Instant messaging, tedy komunikace prostřednictvím „okamžitých zpráv“, se stala velmi populární. Existuje celá řada protokolů, služeb i klientů sloužící k realizaci tohoto typu komunikace. Jedním z protokolů je i Jabber/XMPP, který je populární nejenom ve sféře uživatelů Linuxu a svobodného softwaru. Jakým způsobem je možné postavit si vlastní XMPP server, je předmětem tohoto dílu.</p>

<h3>Obecně o Jabberu a XMPP</h3>
<p>Jak už bylo řečeno, existuje řada protokolů pro výměnu „okamžitých zpráv“. Řada z nich je však uzavřená, centralizovaná a podléhá restriktivním licenčním podmínkám či ještě navíc nutnosti instalovat proprietární software, který komunikaci zajišťuje (v některých případech nemusí být takový software pro Linux ani dostupný). XMPP je protokol, který je decentralizovaný a otevřený. Jednou z jeho stěžejních vlastností je i rozšiřitelnost, která umožňuje na Jabberu stavět další služby a činit jej tak pro uživatele atraktivnější.</p>
<p>Otevřenost protokolu a související možnost jej použít volně, dle libosti, dala vzniknout řadě implementací XMPP serverů i klientů. Oproti řadě jiných protokolů a podobných služeb má Jabber ještě jednu zásadní odlišnost – je decentralizovaný. To znamená, že nemá žádný centrální bod, na kterém by komunikační síť závisela a bez kterého by nikdo s nikým nemohl komunikovat. Jabber se z tohoto pohledu podobá e-mailu - serverů je celá řada, mohou spolu navzájem komunikovat, přičemž uživatelé se mohou rozhodnout, jaký server si zvolí, popřípadě mají možnost si založit vlastní Jabber server (viz dále), a stále mají možnost komunikovat s uživateli ostatních serverů.</p>
<p class="box">Jabber nebo XMPP? Dříve se protokol XMPP jmenoval Jabber. Nyní se toto označení používá spíše pro službu, zatímco novější XMPP se používá pro samotný protokol. Vztah mezi výrazy Jabber a XMPP je tak podobný jako mezi výrazy e-mail a SMTP.</p>
<p>Uživatelé Jabberu jsou identifikováni pomocí JID (Jabber ID), které má totožný tvar jako e-mailová adresa: <code><span class="eaddress">jmeno@domena<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />cz</span></code>.</p>
<h3>Klienty</h3>
<p>Klientů pro Jabber existuje ohromné množství. Na tomto serveru byly mj. představeny multiplatformní klienty <a href="http://www.linuxexpres.cz/software/jabber-instant-messaging-bez-omezeni-1">Psi</a>, <a href="http://www.linuxexpres.cz/duel/klienti-pro-jabber-coccinella-vs-gajim">Coccinella a Gajim</a>. Známým klientem je i multiplatformní a multiprotokolový <a href="http://www.pidgin.im/">Pidgin</a> nebo rovněž multiprotokolový klient pro prostředí KDE, <a href="http://www.linuxexpres.cz/blog/kopete-za-kde-ja-ano">Kopete</a>. Existují také klienty pro konzoli určené pro milovníky příkazové řádky, jedná se např. o klient <a href="http://www.linuxexpres.cz/software/mcabber-im-klient-pre-konzolu-zvladajuci-nielen-jabber">Mcabber</a> či s Pidginem distribuovaný <a href="http://developer.pidgin.im/wiki/Using%20Finch">Finch</a>. Jsou rovněž dostupné klienty pro webový prohlížeč i mobilní zařízení. Podrobnější seznam klientů naleznete jednak <a href="http://en.wikipedia.org/wiki/Comparison_of_instant_messaging_clients#XMPP_clients">na Wikipedii</a>, na <a href="http://www.jabber.cz/wiki/Kategorie:Klienti">wiki</a> českého Jabber portálu a také na <a href="http://xmpp.org/xmpp-software/clients/">webu XMPP nadace</a>.</p>
<h3>Servery</h3>
<p>Jabber serverů existuje také celá řada. Existují v C napsané servery jabber14 a jabber2, v Erlangu napsaný ejabberd, v Javě napsané Openfire a Tigase a v neposlední řadě i odlehčený server Prosody napsaný v Lua (ten bude představen v tomto dílu). Tento soupis rovněž není úplný, obsáhlý seznam jsem nalezl na <a href="http://xmpp.org/xmpp-software/servers/">webu XMPP nadace</a>.</p>
<h3>Prosody</h3>
<p>Prosody je lehký XMPP server napsaný v jazyce Lua a vydaný pod MIT/X11 licencí. Snaží se o jednoduchost konfigurace (to budete moci posoudit níže) a nenáročnost na zdroje (to mohu potvrdit, jelikož mi běží na dvou serverech a na obou si alokuje kolem 10 MB virtuální paměti). Díky tomu se výborně hodí na osobní VPS nebo servery s omezenými zdroji.</p>
<h4>Instalace</h4>
<p>Ve vámi používané distribuci byste mohli najít balíček Prosody přímo v repozitářích (pokud ne, nezbude vám nic jiného než Prosody nainstalovat ze zdrojových kódů). Distribuce založené na Debianu by měly mít Prosody v repozitářích k dispozici, nicméně vývojářský tým tohoto serveru nabízí ještě svůj vlastní <a href="http://prosody.im/download/package_repository">repozitář</a>, kde byste měli najít vždy aktuální verzi. Tak či onak, pro instalaci by měl postačit příkaz:</p>
<pre>aptitude install prosody</pre>
<h4>Konfigurace</h4>
<p>Pokud sledujete tento seriál pravidelně, určitě tušíte, že po vzoru konfigurace webových serverů bude distribuce Debian strukturu konfiguračních souborů pro Prosody upravovat podobným stylem. Konfiguraci naleznete v adresáři <code>/etc/prosody</code>. Hlavním konfiguračním souborem je <code>prosody.cfg.lua</code>, pro konfigurační soubory jednotlivých virtuálních hostů je určen adresář <code>conf.avail</code>, přičemž aktivní konfigurační soubory je třeba nalinkovat symbolickým odkazem do <code>conf.d</code>.</p>
<p>Jako první asi budete chtít vytvořit nastavení pro vámi používanou doménu, tedy vytvořit příslušný virtual host, který umístíte do <code>/etc/prosody/conf.avail</code> a vytvoříte symbolický odkaz na něj do <code>/etc/prosody/conf.d</code>. Nejjednodušší záznam vypadá takto:</p>
<pre>VirtualHost "example.cz"</pre>
<p>Nastavení v <code>prosody.cfg.lua</code> jsou nastavení globální. Nastavení pod jednotlivými direktivami <code>VirtualHost</code> by měla být specifická pro daný virtual host. Můžete tak specifikovat odlišná nastavení pro různé domény, zejména pak nastavení jednotlivých komponent, např. modulu pro konference (kde pak můžete specifikovat konkrétní doménu):</p>
<pre>Component "conference.example.cz" "muc"</pre>
<p>Výchozí nastavení v Debianu má zakázané registrace uživatelů a jedinou funkční doménou je localhost. Po nastavení jedné nebo více domén můžete uvažovat o úpravě hlavního konfiguračního souboru a přizpůsobit si globální nastavení. Mezi podstatné volby patří:</p>
<ul>
<li>
<p>specifikace správců: <code>admins 	= { "<span class="eaddress">admin@example<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />cz</span>", "<span class="eaddress">admin@example<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />net</span>" }</code></p>
</li>
<li>
<p>seznam aktivovaných modulů: 	<code>modules_enabled</code></p>
</li>
<li>
<p>povolení či zakázání 	registrace uživatelů: <code>allow_registration</code></p>
</li>
<li>
<p>uvítací zpráva zaslaná právě 	registrovaným uživatelům: <code>welcome_message</code></p>
</li>
<li>
<p>seznam uživatelů, kterým budou zasílány informace o 	registracích uživatelů: <code>registration_watchers</code></p>
</li>
</ul>
<p>Obecně lze doporučit projít si tento soubor a jeho komentáře a upravit si nastavení podle svých představ.</p>
<h4>Vytváření a rušení uživatelských účtů</h4>
<p>Prosody má k dispozici nástroj pro řízení jeho chodu, a sice <code>prosodyctl</code>. Tímto nástrojem můžete provádět změny za běhu, zejména pak přidání uživatele, odebrání uživatele a změna hesla uživatele:</p>
<ul>
<li>
<p>přidání uživatele: <code>prosodyctl 	adduser <span class="eaddress">uzivatel@domena<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />cz</span></code></p>
</li>
<li>
<p>odebrání uživatele: <code>prosodyctl 	deluser <span class="eaddress">uzivatel@domena<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />cz</span></code></p>
</li>
<li>
<p>změna hesla uživatele: <code>prosodyctl 	passwd <span class="eaddress">uzivatel@domena<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />cz</span></code></p>
</li>
</ul>
<h4>SRV záznamy DNS</h4>
<p>Preferovaným způsobem navazování spojení v rámci XMPP klientů i serverů je využívání SRV DNS záznamů, které udávají, kde konkrétně běží příslušné služby (viz <a href="http://xmpp.org/rfcs/rfc6120.html#tcp-resolution-prefer">příslušné RFC</a>). V případě XMPP se jedná o dvě služby, resp. dva porty, port pro připojení klientů (5222) a port určený pro komunikaci mezi servery 5269. Z tohoto hlediska je velmi vhodné pro XMPP server příslušné SRV záznamy nastavit. Tyto záznamy mají následující podobu:</p>
<pre>_xmpp-server._tcp.example.cz.  IN SRV   0 0 5269   hostname.
_xmpp-client._tcp.example.cz.  IN SRV   0 0 5222   hostname.</pre>
<p>Zde nahraďte <code>example.cz</code> za název domény, kde chcete nasadit Jabber server (toto je doménové jméno v JID); <code>hostname</code> pak nahraďte za jméno serveru, kde váš Jabber server běží. Pokud chcete, můžete upravit i čísla portů. Dvě nuly zde udávají prioritu a váhu (v tomto pořadí).</p>
<p>Následující SRV záznam sice již ze specifikace XMPP protokolu zmizel a jakýkoliv software pracující s XMPP aktualizovaný během posledních několika let by jej neměl vyžadovat, nicméně z důvodu zpětné kompatibility může být vhodné zvážit přidání i tohoto záznamu. Přinejmenším je to jedna z věcí, kterou byste měli vést v patrnosti při řešení případných problémů, pokud tento SRV záznam nepoužijete.</p>
<pre>_jabber._tcp.example.cz.       IN SRV   0 0 5269   hostname.</pre>
<h4>SSL/TLS nastavení</h4>
<p>Jabber komunikaci je velmi vhodné šifrovat, nejlépe platným certifikátem, kterému budou vaši klienti věřit. Problematika certifikátů a možnosti získání důvěryhodného certifikátu zdarma byly <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-uvod-do-konfigurace-apache-1">probrány dříve v seriálu</a>. Zde už předpokládám, že certifikát k dispozici máte. Specifikace certifikátu by měla přijít do nastavení příslušného virtual hostu, konkrétně do sekce <code>ssl</code>:</p>
<pre>VirtualHost "example.cz"

  ssl = { 
    key = "/etc/certs/example.key";
    certificate = "/etc/certs/example.crt";
  }</pre>
<p>Podstatné volby ovlivňující nastavení SSL/TLS jsou především tyto:</p>
<ul>
<li>
<p><code>c2s_require_encryption</code> - komunikace klienta se serverem (c2s) vyžaduje šifrování</p>
</li>
<li>
<p><code>s2s_require_encryption</code> - 	komunikace mezi servery (s2s) vyžaduje šifrování</p>
</li>
</ul>
<p>Více o pokročilém nastavení SSL/TLS v Prosody se dozvíte <a href="http://prosody.im/doc/advanced_ssl_tls">v dokumentaci</a>.</p>
<h3>Jabber a transporty</h3>
<p>Na závěr zmíním možnost komunikace s ostatními sítěmi pomocí transportů. Chcete-li propojit svůj Jabber/XMPP server se sítěmi jako ICQ, AIM, MSN apod., můžete použít některý z projektů jako např. <a href="http://spectrum.im/">spectrum</a>. Na jeho <a href="http://spectrum.im/projects/spectrum/wiki">wiki</a> naleznete prakticky veškeré potřebné informace, jak tuto komponentu nastavit a integrovat s Prosody. Spectrum není součástí Debianu Squeeze, ale projekt má k dispozici repozitáře pro Debian, tudíž použitím tohoto nástroje nepřijdete o snadnou aktualizaci.</p>

<pre id="links">http://prosody.im/ Prosody (Web projektu)
http://cs.wikipedia.org/wiki/Extensible_Messaging_and_Presence_Protocol XMPP (Popis protokolu na české Wikipedii)
http://www.jabber.cz/wiki/Hlavn%C3%AD_strana Česká Jabber wiki
http://spectrum.im/projects/spectrum/wiki Spectrum Wiki (Jabber transport/gateway)</pre>
