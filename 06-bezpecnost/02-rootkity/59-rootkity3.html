<meta http-equiv="content-type" content="text/html;charset=utf-8" />


<h1>Správa linuxového serveru: Sledování změn v souborech pomocí AIDE</h1>

<p>V minulém díle jsem probral detektory rootkitů a obecné rady, jak postupovat v případě průniku útočníka do systému. Zajímavými nástroji, které mohou částečně pomoci při detekci, ale hlavně po případném průniku, jsou nástroje sledující změny v souborech. Jedním z těchto nástrojů je AIDE, kterým se bude zabývat tento díl.</p>

<h3>Úvod</h3>
<p>Nástroje pro sledování změn v souborech pracují obvykle velmi jednoduše. Vytvoří si databázi hashí jednotlivých souborů (které to jsou, to se obvykle dá nastavit) a s tou pak porovnávají současný stav. Pokud tedy útočník změní některé soubory, změní se i jejich hash, což by mělo vyvolat poplach.</p>
<p>Zde je ovšem třeba jednoznačně zdůraznit, že kompromitovanému systému (tj. nástrojům a datům na něm) nelze věřit. Měl-li útočník možnost pozměnit systémové nástroje jako <code>ls</code>, <code>ps</code>, <code>netstat</code> apod., měl i příležitost pozměnit libovolné jiné nástroje a jejich data, včetně těch určených ke sledování změn v souborech.</p>
<p>V ideálním případě by databáze měla být pořízena před vypuštěním serveru na síť a bezpečně uložena, přičemž kontroly by měly běžet offline, tj. např. z live CD. V praxi je to obtížně proveditelné, zejména pak vzhledem k tomu, že po aplikování nutných aktualizací dochází ke změnám v souborech, čímž databáze zastarává. Jde to samozřejmě řešit provedením kontroly před aktualizací, provedením aktualizace a následně aktualizací či vygenerováním nové databáze hashí. To je ale samozřejmě nepraktické.</p>
<p>AIDE v Debianu je zkompilováno staticky, což znamená, že samotné binárky nevyužívají systémové knihovny. To sice útočníkovi zkomplikuje život, jelikož změnou příslušných knihoven nedojde k ovlivnění AIDE, ale není to nic, co by se nedalo překonat (rootkit upravující funkčnost jádra, úprava AIDE samotného). Budete-li tedy AIDE používat jiným než výše naznačeným ideálním způsobem, musíte počítat s tím, že chytrý útočník obejde i tento nástroj a vy se o změnách nedozvíte.</p>
<p>Jelikož AIDE používá celou řadu hashovacích algoritmů pro jednotlivé soubory, jeho běh je náročný na procesor i čas. Budete-li jej pouštět ručně na běžícím serveru, zvažte úpravu jeho priority (nástroj <code>nice</code>, popř. ještě <code>ionice</code>).</p>
<h3>Instalace</h3>
<p>Instalace AIDE je jednoduchá, stačí využít správce balíčků, v Debianu je možné použít následující příkaz:</p>
<pre>aptitude install aide</pre>
<p>Upozorňuji, že pokud byste chtěli dynamicky sestavenou binárku AIDE místo statické, budete muset nainstalovat balíček <code>aide-dynamic</code>. To ale s největší pravděpodobností asi chtít nebudete.</p>
<h3>Konfigurace</h3>
<p>Sledujete-li tento seriál pravidelně, popřípadě znáte-li Debian, asi už tušíte, že Debian si konfiguraci AIDE upravuje po svém. V případě AIDE je konfigurace přizpůsobena poměrně značně. Jde to tak daleko, že konfigurační soubor je sestavován skriptem <code>update-aide.conf</code>, který sesbírá všechna nastavení ze souborů uložených v <code>/etc/aide/aide.conf.d</code> a zapíše je do jediného konfiguračního souboru, který pak využívá „obalovač“ (wrapper) AIDE, tedy <code>aide.wrapper</code>.</p>
<p>Za základ konfigurace je třeba považovat soubor <code>/etc/default/aide</code>, který obsahuje nastavení pro příslušnou úlohu cronu, jež provádí denní kontroly. Tento soubor je dobře zdokumentovaný, takže si jej projděte a nastavte podle svých potřeb.</p>
<p>Za volby hodné zvláštní pozornosti považuji následující:</p>
<ul>
<li>
<p><code>MAILSUBJ</code> - předmět zasílaných e-mailů</p>
</li>
<li>
<p><code>MAILTO</code> - komu posílat e-maily</p>
</li>
<li>
<p><code>QUIETREPORTS</code> - potlačení zaslání e-mailu, pokud nedošlo ke změně (je-li tato proměnná nastavena na <code>yes</code>)</p>
</li>
<li>
<p><code>TRUNCATEDETAILS</code> - zkrácení detailních informací o změnách</p>
</li>
<li>
<p><code>FILTERUPDATES</code> - potlačení informování o změnách způsobených aktualizacemi (předpokládá <code>TRUNCATEDETAILS</code> nastaveno na <code>yes)</code></p>
</li>
</ul>
<p>AIDE je v Debianu nastaveno tak, že prohledává poměrně velkou část souborového systému, včetně adresáře <code>/home</code>, což může působit řadu zbytečných „poplachů“, máte-li aktivní uživatele. Nechcete-li, aby AIDE prohledávalo <code>/home</code>, můžete využít ukázkového skriptu v <code>/usr/share/doc/aide-common/examples</code> a zařadit jej do konfigurace, takto:</p>
<pre>cp /usr/share/doc/aide-common/examples/31_example_exclude-homes /etc/aide/aide.conf.d/
chmod a+x /usr/share/doc/aide-common/examples/31_example_exclude-homes</pre>
<p>AIDE také prohledává cache správce balíčků Apt, což rovněž nemusí být zrovna to, co chcete. Nechcete-li, aby AIDE brala v úvahu uložené balíčky ve <code>/var/cache/apt/archives</code>, upravte soubor <code>/etc/aide/aide.settings.d/31_aide_apt_settings</code>, ve kterém nastavte proměnnou <code>IGNORE_ARCHIVES</code> na <code>"yes"</code>:</p>
<h3>Inicializace databáze</h3>
<p>Až budete hotovi s nastavováním (ne dříve!), můžete inicializovat databázi AIDE:</p>
<pre>aideinit</pre>
<p>Po případných úpravách konfigurace je vhodné znovu inicializovat databázi AIDE, takto:</p>
<pre>update-aide.conf &amp;&amp; aideinit -y -f</pre>
<h3>Manuální spuštění AIDE</h3>
<p>Chcete-li zkontrolovat integritu databáze, nejjednodušší je pustit samotnou úlohu pro cron:</p>
<pre>/etc/cron.daily/aide</pre>
<p>Chcete-li použít samotný nástroj <code>aide</code>, použijte příslušný „obalovač“, který zajistí, že se použijí správně sestavené konfigurační soubory. Tento „obalovač“ je k dispozici jako <code>aide.wrapper</code>.</p>
<h3>Úprava konfigurace</h3>
<p>Nepochybně zjistíte, že AIDE v Debianu prohledává kdeco a budete tedy chtít některé soubory či adresáře z prohledávání vyřadit. Rovnou předešlu, že úprava nastavení není úplně triviální, jelikož Debian nabízí opravdu značné množství konfiguračních souborů i skriptů v <code>/etc/aide/aide.conf.d</code>, které se pak spouští, spojují a kompletují do jediného velkého konfiguračního souboru.</p>
<p>Zde doporučuji prostudovat <a href="http://aide.sourceforge.net/stable/manual.html">manuál</a> k AIDE (a ještě manuál k aide.conf: <code>man aide.conf</code>), jelikož obsahuje příslušnou syntax a potřebné informace. Zásadní informace je, že jednotlivá pravidla jsou de facto regulární výrazy, čemuž byste měli přizpůsobit psaní pravidel, zejména si dejte pozor na tečky (tečka odpovídá jednomu libovolnému znaku), které raději escapujte (umístěním zpětného lomítka před tečku, takto: <code>\.</code>). Regulárními výrazy se zde zabývat nebudu, avšak pod článkem jsem vám připravil odkazy na česky psané materiály, ze kterých se příslušnou syntaxi můžete snadno a rychle naučit.</p>
<p>Co se týká pořadí pravidel (opět odkazuji na manuál), je vhodné obecnější pravidla umisťovat níže a specifičtější pravidla výše. Asi nejčastější úpravou konfigurace bude specifikace souborů, které nechcete, aby se do databáze zařadily. V takovém případě si vytvořte vhodný soubor v <code>/etc/aide/aide.conf.d</code>, ale jelikož záleží na pořadí, zařaďte jej do struktury pomocí úvodního čísla, tzn. např. <code>50_aide_moje-pravidla</code>. Do tohoto souboru pak přidejte příslušná pravidla - pro ignorování určitého souboru zapište příslušný regulární výraz z vykřičníkem na začátku, např. takto:</p>
<pre>!/var/cache/munin/www</pre>
<p>AIDE pak bude takový soubor či adresář ignorovat. AIDE v zásadě podporuje tři typy pravidel, a sice regulární výrazy (začínají lomítkem), přesné specifikace konkrétního souboru či adresáře ("equal matching", začínají znakem <code>=</code>) a vylučovací regulární výrazy (začínají vykřičníkem). U pravidel, která zařazují soubory či adresáře do databáze, je třeba specifikovat parametr, který odpovídá operacím, jež se mají s daným souborem provést. Zde opět odkazuji na manuál, kde jsou všechny popsány. Můžete si ušetřit práci tím, že si sadu operací pojmenujete, a pak se na ni budete odkazovat, takto:</p>
<pre>MojeAkce = p+i+MojeJineAkce</pre>
<p>Jak si můžete všimnout, ve specifikaci vlastních operací se můžete odkazovat na jiné vlastní operace. Konfigurace Debianu používá řadu vlastních pojmenovaných operací, které naleznete v <code>/etc/aide/aide.conf</code>. Jedno z pravidel je např. <code>Full</code>, které kdybyste chtěli aplikovat na konkrétní soubor či adresář, zapíšete:</p>
<pre>/home/secret$ Full</pre>
<p>Pokud by v tomto případě byl <code>secret</code> adresář, zaznamenaly by se jen jeho parametry, ale soubory v něm obsažené by se ignorovaly. Pokud byste chtěli přidat i jeho obsah, stačí vynechat znak konce řádky v regulárním výrazu (tedy znak dolaru), takto:</p>
<pre>/home/secret Full</pre>
<p>Tolik k běžným úpravám nastavení AIDE. Nezapomeňte, že po úpravě konfigurace musíte znovu inicializovat databázi, viz sekce <em>Inicializace databáze</em> výše.﻿</p>

<pre id="links">http://aide.sourceforge.net/stable/manual.html Manuálová stránka AIDE on-line
http://www.debuntu.org/intrusion-detection-with-aide AIDE: Advanced Intrusion Detection Environment (návod pro Debian a Ubuntu)
http://www.mail-archive.com/aide@cs.tut.fi/msg01303.html My personal guide to AIDE (e-mail z archívu)
http://www.regularnivyrazy.info/regularni-vyrazy-zaklady.html Miroslav Pecka, Základy regulárních výrazů
http://www.regularnivyrazy.info/shrnuti-syntaxe.html Miroslav Pecka, Shrnutí syntaxe regulárních výrazů
http://cs.wikipedia.org/wiki/Regul%C3%A1rn%C3%AD_v%C3%BDraz Wikipedie, Regulární výraz
http://www.ducea.com/2006/07/17/how-to-restore-a-hacked-linux-server/ How to restore a hacked Linux server
http://www.sans.org/reading_room/whitepapers/linux/linux-rootkits-beginners-prevention-removal_901 Linux RootKits For Beginners - From Prevention to Removal (PDF)
http://www.sans.org/reading_room/whitepapers/honors/linux-kernel-rootkits-protecting-systems_1500 Linux kernel rootkits: protecting the system's (PDF)</pre>
