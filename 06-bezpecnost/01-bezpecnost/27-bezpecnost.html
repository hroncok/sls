<h1>Bezpečnost</h1>

<h2>Úvod do bezpečnosti</h2>

<p>Každý správce serveru by určitě rád zajistil, aby jeho server zůstal co nejlépe zabezpečený, aby nad ním nezískal vládu nějaký útočník, ale také aby server korektně fungoval, byl dostupný a v případě nějaké havárie nebyl velký problém činnost serveru rychle obnovit. Já osobně řadím do oblasti bezpečnosti vše výše uvedené, nikoliv pouze bezpečnost ve smyslu ochrany či prevence proti průniku nějakým útočníkem. Je samozřejmě důležité mít server v bezpečí před nenechavci nebo dokonce před cíleným útokem, ale bezpečnostní strategie by zde neměla končit. Je důležité zabezpečit i samotný běh serveru a připravit se na případné havárie serveru nebo jeho komponenty či chyby softwaru nebo samotného správce.</p>

<h3>Pohledy na bezpečnost</h3>

<p>Na bezpečnost lze nahlížet z mnoha hledisek. Já se omezím na dvě, která považuji za klíčová. Především, bezpečnost je vždy kompromisem mezi náklady a úrovní zabezpečení. Čím vyšší úroveň zabezpečení, tím více prostředků, času, práce a peněz je třeba vynaložit. Přitom nikdy není možné dosáhnout stoprocentní bezpečnosti. Té je nanejvýš možné se hodně přiblížit, avšak za cenu astronomických nákladů (a také vedlejších účinků – snížení produktivity firmy kvůli bezpečnostní administrativě, odmítnutí přístupu uživatelům ke službám serveru kvůli příliš agresivním bezpečnostním opatřením atd). Jako správci vlastních serverů si budete požadovanou úroveň zabezpečení volit sami, s tím, že u každého opatření budete zvažovat jeho přínos v porovnání k nákladům na jeho implementaci a údržbu.</p>

<p>Druhý náhled na bezpečnost je jako na proces se čtyřmi fázemi – analýza, implementace, monitorování, změna (či krize). Na počátku probíhá analýza, jejímž výstupem je bezpečnostní strategie, resp. sada konkrétních opatření, politik, úkolů, procesů, odpovědností atd.; uvedení této strategie do provozu představuje druhá fáze, tedy implementace. Následuje patrně ta nejdůležitější fáze vůbec, a sice fáze monitorování a kontroly. V této fázi se prověřuje samotná implementace, zdali byla úspěšná, zdali bylo všechno nastaveno správně, ale také to, zdali jednotlivá pravidla a opatření skutečně fungují a jsou účinná (např. agresivní politika práce s hesly může snížit bezpečnost, pokud si uživatelé budou hesla psát na papírky a lepit na monitor). Druhou věcí, která probíhá v této fázi, je sledování serveru, tzn. sledování logů, sledování vytížení zdrojů serveru, zálohování, kontrola záloh, atd.</p>

<p>Poslední fází je změna nebo také krize, kdy dojde k něčemu, co vás dostane zpět k první fázi – analýze – a celý proces se opakuje. Možná zjistíte, že nějaké opatření bylo příliš agresivní a ve finále odradilo uživatele či zákazníky, nebo je donutilo k něčemu, co bezpečnost ve finále snížilo, takže musíte dané opatření změnit. Nebo vám na server úspěšně pronikne útočník, a na vás je zjistit, jak se mu to povedlo, obnovit činnost serveru a zajistit, aby se útočník na váš server už neproboural.</p>

<p>Bezpečnost je tedy něčím, nad čím je nutno neustále bdít. To je asi to nejdůležitější, co byste si z této knihy měli odnést. Představa, že si postavíte a nakonfigurujete server, a poté na něj zapomenete a nebudete se mu již nadále věnovat, je z pohledu bezpečnosti časovaná bomba. A to i v případě, že se jedná o váš soukromý server. I kdyby vám nezáleželo na datech, která na něm máte uložená, stále je tu možnost úspěšného průniku útočníkem, který pak může váš server využít k rozesílání spamu nebo k útoku na jiné počítače v internetu (nebo ještě hůř – váš server pak může začít sloužit jako skladiště a distribuční uzel pro různé vysoce nelegální materiály).</p>

<h3>Bezpečnost jako proces</h3>

<p>Dovolte mi projít jednotlivé fáze procesu zabezpečení a trošku je rozvést. Zatím nebudu příliš konkrétní, jednotlivé techniky a opatření proberu v dalších kapitolách. V souvislosti s tím si dovolím upozornit na předchozí kapitoly, kde se již probíralo něco málo z toho, co může tvořit část vaší bezpečnosti (jmenovitě: <em>Šifrování s dm-crypt/LUKS</em>{link:“Správa disků“:“Šifrování s dm-crypt/LUKS“} a <em>Zabezpečení SSH: praktické rady</em>{link:“Bezpečnost“:“Zabezpečení SSH: praktické rady“}.</p>

<h3>Analýza</h3>

<p>Východiskem pro analýzu by měla být požadovaná úroveň zabezpečení, tzn. zvolený bod na křivce tvořící poměr mezi úrovní zabezpečení a vynaloženými náklady. Asi budete postupovat jinak, bude-li se jednat o váš soukromý server, kde budete mít třeba svůj osobní blog, a jinak v situaci, bude-li se jednat o kritický server pro fungování vaší firmy. S tím bude souviset i to, jaké prostředky máte k dispozici a co jste ochotni do zabezpečení investovat.</p>

<p>Z hlediska opatření proti škodám způsobeným útočníky je třeba uvažovat o dvojím typu útočníka – vnějšího a vnitřního. Vnější útočník je ten, který má přístup pouze k veřejným službám serveru (webové stránky apod.). Vnitřní útočník je ten, který má přístup k některému z uživatelských účtů (nemusí to být nutně zrovna daný uživatel, ale třeba někdo, kdo získal jeho přihlašovací údaje). Zabezpečení vůči vnitřnímu útočníkovi bývá obtížnější (zejména, pokud má daný uživatel přístup k shellu – takový útočník má podstatně více možností, jak škodit nebo jak proniknout hlouběji). Existuje samozřejmě řada zranitelností, které mají za následek „privilege escalation“, tedy povýšení oprávnění. Ty pak mohou z vnějšího útočníka učinit útočníka vnitřního. Může to být třeba díra ve webovém serveru, která umožní útočníkovi přístup k shellu pod uživatelem, pod kterým webový server běží. Uvážit je třeba také to, že škodu nepůsobí pouze lidé s úmyslem škodit (útočníci), ale i chybující uživatelé či samotný správce (aneb i mistr tesař se někdy utne). Stačí pouhý překlep při použití známého nástroje <code>rm</code>.</p>

<p>Uvážit je samozřejmě třeba i ostatní oblasti bezpečnosti jako zajištění fungování serveru (redundance, vysoká dostupnost atd.), bezpečnost dat (tzn. jednak strategii pro zálohování a jednak strategii vůči fyzickým útokům na server), aktualizace softwaru, bezpečnostní aktualizace atd. Pokud se na správě serveru podílí více osob, je třeba zajistit jejich koordinaci, popřípadě pravidla bezpečnosti práce atd.</p>

<p>Výstupem této fáze nejsou tedy pouze opatření týkající se daného serveru, ale i příslušných osob, ať již uživatelů, tak správců. V případě firem a produkčních serverů bude analýza podstatně podrobnější a bude obsahovat mj. i scénáře a postupy pro řešení krizových situací.</p>

<h3>Implementace</h3>

<p>Tuto fázi asi není třeba příliš rozebírat. Snad jen pokud se jedná o produkční server, který právě běží, vyplatí se maximální opatrnost při konfiguraci služeb (otestovat syntaxi konfiguračních souborů pomocí nějakého nástroje, je-li to možné) či firewallu (aby správce neodstřihl sebe a případné zákazníky). U produkčních serverů nebývá na škodu vyzkoušet si změny nejprve někde nanečisto (virtuální server, testovací server atd.).</p>

<h3>Monitorování</h3>

<p>Pokud byste si měli z tohoto dílu něco odnést, pak je to důležitost této fáze. Zde je nejprve třeba otestovat, zdali implementace proběhla správně a zdali všechna bezpečnostní opatření fungují tak, jak mají. To znamená, že byste měli použít příslušné nástroje a přesvědčit se, ať už pokusem o průnik zvenčí nebo zevnitř. Pro firmy je určitě vhodné doporučit bezpečnostní audit nějakým vnějším subjektem. Stejně tak je třeba otestovat systém zálohování, zdali je možné provést obnovu dat (není nic horšího než zjištění, že kvůli nějaké chybě došlo ke znehodnocení záloh třeba za poslední půlrok, nejlépe v situaci, kdy došlo ke krizi a vy zálohu akutně potřebujete). Funkčnost zálohování, ale i jednotlivých bezpečnostních opatření, je třeba prověřovat pravidelně. Prověřit to jednou rozhodně nestačí.</p>

<p>Součástí této fáze je i běžné sledování serveru, čtení logů a zpráv, zaznamenávání vytížení jednotlivých systémových zdrojů serveru (paměť, disk apod.), sledování výkonu serveru (zdali stíhá v přijatelném čase reagovat na požadavky klientů) atd.</p>

<h3>Změna / krize</h3>

<p>Pokud dojde k pouhé změně, resp. nedojde k žádné krizi, pak není příliš o čem hovořit. Zkrátka se vrátíte zpět k analýze, provedete patřičné změny, implementujete je, zkontrolujete a dostanete se zpět do fáze monitorování. Pokud dojde k nějaké krizi, asi tím nejdůležitějším je nepanikařit. Panika má tendenci působit řadu dodatečných škod a problém spíše prohloubit než optimálně vyřešit či alespoň minimalizovat škody. Zachovejte tedy chladnou hlavu a jednejte s rozvahou. Nikde není řečeno, že po zjištění problému musíte problém začít řešit ještě tu danou minutu. Mnohdy se vyplatí chvilku počkat, uklidnit se, popřemýšlet o možných způsobech řešení, popřípadě se podívat do firemní či bezpečnostní dokumentace, jak postupovat v dané situaci.</p>

<p>V případě průniku se může vyplatit věnovat nějaký čas analýze útoku nebo i chování útočníka ještě před samotným odstavením serveru a obnovou ze zálohy – pokud nepřijdete na to, kudy se vám útočník na server dostal, obnova ze zálohy a opětovné rozběhnutí serveru bude mít nejspíše za následek opětovné napadení. Pokud je útočník z České republiky, může se vyplatit sesbírat všechny možné informace kvůli případné žalobě či podání trestního oznámení. V souvislosti s tím nemusí být od věci udělat si kopii napadeného systému a analyzovat ji po vyčištění a obnovení činnosti serveru.</p>

<h2>Bezpečnost linuxového serveru</h2>

<p>Bezpečností serveru je myšlena fyzická bezpečnost, tedy místo, kde je server uložen, kdo má k němu přístup, jak je úložiště serveru zabezpečeno proti vniknutí nežádoucích osob atd. Jelikož v dnešní době začínají být velmi populární virtuální servery, je třeba brát ohled i na tyto typy serverů a jejich úskalí. K serveru má přístup obvykle poskytovatel dané služby, přičemž není vždy jasné, jaké poměry v rámci správy daného serveru panují – kde jsou vaše data, jsou-li zálohována, co se děje se záložními médii, jakým způsobem jsou na nich likvidována data před jejich vyřazením, pokud vůbec, atd.</p>

<p>Kromě toho, fyzický server provozující virtualizaci (hypervizor) používá více uživatelů. Ačkoliv virtualizační technologie poskytují mechanismy k velmi dobré izolaci jednotlivých virtuálních strojů, bezpečnostní díry se najdou všude a nelze vyloučit možnost, že se útočníkovi podaří z napadeného virtuálního stroje probourat do systému hypervizoru, pod kterým vše běží.</p>

<p>K této oblasti nemám příliš mnoho komentářů, spíše jen řadu otázek, na které si musíte sami najít odpověď. Ostatně, bezpečnost je vždy kompromisem mezi časem a prostředky, které do jejího zajištění vložíte, a mezi úrovní bezpečnosti, kterou prostřednictvím této investice dosáhnete. Jinými slovy: v případě osobního serveru, na kterém běží vaše osobní webové stránky, popřípadě nějaký SCM hosting se zdrojovými kódy vašich FOSS projektů, je asi zbytečné investovat do vlastního serveru ve vlastním datacentru a s vlastní ostrahou. A naopak: pokud realizujete prostřednictvím svých serverů své podnikání, a server obsahuje třeba osobní údaje vašich klientů, pak by vám rozhodně nemělo být jedno, v jakém prostředí a v jakých poměrech se server nachází.</p>

<h3>Bezpečnost systému a služeb</h3>

<p>Bezpečnost systému a služeb je bezpečnost týkající se náhodných či cílených útoků, ale i omylů uživatele či správce. Kupříkladu, pokud má uživatel přístup k Shellu a zadá obávané <code>rm -rf /*</code> (pro jistotu dodávám, že tento příkaz maže celý adresářový strom, a proto byste jej rozhodně neměli spouštět, a už vůbec ne s právy roota!), neměl by ohrozit ani systém, ale ani data jiného uživatele.</p>

<h3>Dostupnost</h3>

<p>Jak už jsem nakousl výše, bezpečnost by neměla končit pouze u bezpečnosti serveru, systému, služeb a dat, ale měla by zohlednit i dostupnost. Pokud bude server delší dobu mimo provoz, pak sice bude v bezpečí proti vzdáleným útočníkům, ale jeho nedostupnost bude přesto působit problém, dokonce možná stejně závažný problém, jako kdyby byl napaden.</p>

<p>Velká část dostupnosti je spojena se samotným hardwarem. Asi tím nejlevnějším řešením je kromě záložního zdroje (UPS), který bude server schopen napájet, i když dojde k výpadku napájení, také nějaká forma RAIDu s redundancí, která zajistí, že výpadek disku nenaruší dostupnost, a dá vám možnost potenciální krizi zažehnat v zárodku. Ostatní možnosti zvýšení dostupnosti zahrnují kvalitnější (a o dost dražší) hardware s redundancí třeba na úrovni zdrojů napájení, připojení k síti, I/O modulů či modulů pro vzdálenou správu serveru (management modulů).</p>

<p>Dalším stupněm mohou být řešení s vysokou dostupností (high availibility), zahrnující obvykle více než jeden server a redundanci na úrovni služeb (vypadne jeden server, požadavky se budou předávat druhému) atd. V této oblasti je mnoho možností, které jsou ovšem vyváženy vysokou cenou, a kromě toho jsou také mimo zaměření této knihy.</p>

<p>U fyzických serverů nezapomeňte na propojení serveru se záložním zdrojem, aby se váš systém v případě kritického stavu baterie sám bezpečně vypnul.</p>

<h3>Bezpečnost dat</h3>

<p>Bezpečnost zahrnuje jak bezpečnost dat vůči zcizení či zneužití nějakým útočníkem, tak bezpečnost dat vůči jejich ztrátě. Se zajištěním bezpečnosti dat vůči zcizení souvisí bezpečnost služeb a systému (útočník, který pronikne do systému, se dostane i k datům, které může zneužít). Stejně tak souvisí s bezpečností serveru (útočník by neměl mít možnost získat fyzický přístup k serveru a třeba si odnést pevný disk). Pokud používáte virtuální server a nemáte pod kontrolou hypervizor, musíte počítat i s únikem dat touto cestou (poskytovatel si může vaše data odnést, nebo hodí pevný disk se starými zálohami do popelnice, kde bude někým objeven atd.).</p>

<p>S bezpečností dat vůči zcizení/zneužití vám může pomoci diskové šifrování (viz související kapitola{link:“Správa disků“:“Šifrování s dm-crypt/LUKS“}). Připomínám také, že šifrování je vám samozřejmě k ničemu, pokud máte k dispozici virtuální server, jehož hypervizor má útočník pod kontrolou. V takovém případě má přímý přístup k paměti vašeho virtuálního stroje, může si z ní vytáhnout šifrovací klíče a data dešifrovat. Pokud máte k dispozici fyzický server, a útočník k němu získá přístup, když server běží, je vám šifrování opět k ničemu (tzv. cold boot attack, klíč lze získat díky tomu, že data se po výpadku napájení z operační paměti neztratí hned, ale až za nějakou dobu – při podchlazení modulů i za delší dobu). Pro bezpečnost dat je tedy klíčové mít zajištěnu fyzickou bezpečnost serveru, ale také bezpečnost systému a běžících služeb (pokud se útočník probourá třeba přes děravou službu a dostane se k Shellu, získá přístup k datům „zevnitř“ systému, kterému jsou data samozřejmě přístupná v nešifrované podobě).</p>

<p>Pokud data nešifrujete, musíte si dávat pozor na uniklé pevné disky, ať již funkční či porouchané – vyhazovat disky do popelnice bez jejich důkladného výmazu není dobrý nápad, dávat je do bazaru je ještě horší, ale stejně tak není úplně ideální vrátit disk výrobci a uplatnit reklamaci (nevíte, kdo dostane disk do ruky, a jak vážná závada to je, tj. v jakém stavu jsou data na porouchaném disku). Výrobci serverů obvykle umožňují, aby si majitelé serverů porouchané disky za určitý poplatek ponechali, takže se nemusí vrátit výrobci na výměnu za nové. Zvažte také, že ačkoliv není možné obnovit všechna data z jednoho disku v diskovém poli (není-li to RAID 1), stále je možné dostat se ke kouskům dat (u RAIDů s prokládáním jako RAID 0, 5 a 6 se data zapisují po blocích, které mají určitou velikost). Dodám, že k důkladnému výmazu dat z pevného disku vám poslouží nástroj <code>shred</code>. Výmaz ovšem nelze provést, pokud se disk porouchá – v takovém případě sice může dojít k částečné likvidaci dat, ale také může odejít pouze kus elektroniky, zatímco data na plotnách zůstanou (i to je třeba důvodem, proč je rozumné citlivá data šifrovat).</p>

<h4>Zálohování</h4>

<p>Mít data v bezpečí před zcizením či zneužitím je samozřejmě důležité, ale neméně důležité je mít data v bezpečí před jejich ztrátou. Z tohoto důvodu je nutné data zálohovat. K tomuto účelu existuje v GNU/Linuxu nepřeberné množství nástrojů, od těch nejobyčejnějších nástrojů jako <code>rsync</code>, <code>ssh</code>, <code>tar</code>, <code>dd</code> apod., až po speciální zálohovací nástroje jako například <code>rdiff-backup</code>, <code>duplicity</code> atd. Zálohováním jsme se zabývali v kapitole {link:"Údržba systému":"Zálohování"}</p>

<h2>Pár slov o útocích na server</h2>

<p>Ještě před tím, než se pustím do bezpečnosti systému a služeb, osvětlím, před čím vlastně server chráníte, tedy jaké jsou typy útoků na server, jejich charakter, cíle a motivy útočníků, ale také kudy a jak mohou útočníci na server proniknout a jak mohou škodit.</p>

<h3>Pár slov o útocích na server</h3>

<p>Z hlediska směru vedeného útoku uvažujeme o dvou typech útoků – vnějším a vnitřním. Většina potenciálních útočníků bude na server přistupovat z vnějšku, tedy nikoliv jako uživatel daného systému, ale pouze k veřejným, běžícím službám, ke kterým existuje z jejich IP adresy na daný server přístup, tedy např. k webovému serveru, poštovnímu serveru, ale také třeba <code>SSH</code> serveru, pokud je na něj přístup odkudkoliv. Druhým typem útoků je vnitřní, který zahrnuje ostatní případy, tj. situaci, kdy útočník získá přístup třeba k Shellu nebo se probourá přes nějakou běžící službu.</p>

<h4>Vnější útoky</h4>

<p>V ideálním případě by k zamezení vnějších útoků měly stačit bezpečnostní mechanismy jednotlivých služeb, ovšem za dvou předpokladů, které jsou nesplnitelné. Prvním předpokladem by byl dokonalý administrátor s kompletní znalostí všech služeb a bez možnosti něco opomenout či udělat chybu, a druhým předpokladem je bezchybné fungování daných služeb. I kdybychom předpokládali neomylnost a stoprocentní znalosti správce, stále tu zůstane fakt, že v každém programu jsou chyby, a řada chyb v serverových službách je využitelná útočníky. Navíc některé služby využívají dalších aplikací či dodatečných modulů, ve kterých mohou být také chyby. Tohle je třeba případ webového serveru, který může být mistrně zabezpečen, ale sám o sobě většinou funguje spíše jako proxy, tj. zachytí požadavek a předá jej interpretu příslušného programovacího jazyka (PHP, Perl, Python, Java apod.), ve kterém běží vlastní webová aplikace, která příslušný požadavek zpracovává.</p>

<p>Řada vnějších útoků je tedy vedena nejenom na služby ve smyslu běžících démonů jako Apache, Postfix, OpenSSH apod., ale i na aplikace, ke kterým některé z daných služeb zprostředkovávají přístup. Tyto aplikace mohou být nakonfigurované buď samotnými správci (lepší případ), nebo také samotnými uživateli (případ webhostingu). To může působit problém – správce obvykle dohlíží na aktuálnost softwaru a záplatování bezpečnostních trhlin (je to v jeho zájmu), ale uživatelé webhostingu jsou různí – někteří na bezpečnost svých aplikací dbají, jiní nainstalují aplikaci a už se o ni nestarají. Vznikají tak nezáplatované, neaktualizované aplikace, které jsou pro daný server potenciální hrozbou.</p>

<h4>Vnitřní útoky</h4>

<p>Vnitřní útok je útok útočníka, který má k serveru jiný než vnější přístup. Může získat nebo uhodnout přihlašovací údaje některého uživatele, může to v některých případech být i samotný uživatel (nespokojený zákazník či zaměstnanec), může získat přístup využitím bezpečnostní trhliny v některé z veřejně přístupných aplikací atd. Vnitřní útoky se liší podle toho, kam se útočník dostal. Asi úplně nejhorší je, pokud využije zranitelnost v některé službě, která běží s právy roota, a získá root Shell. To je konec – v takovém případě si může útočník se serverem dělat, co se mu zlíbí. Má navíc široké možnosti svou přítomnost maskovat – nahráním speciálního jaderného modulu či podvržením nástrojů jako <code>ls</code>, <code>netstat</code>, <code>ps</code>, <code>top</code>, ale i <code>bash</code> apod., zajistí, že některé procesy, soubory či uživatele neuvidí ani root.</p>

<p>Druhý nehorší případ nastane, pokud se útočník dostane k uživatelskému Shellu. Nemá sice práva roota, ale to mu obvykle vůbec nebrání škodit jinak nebo se pokoušet dostat dál. Může využít nějaké vnitřní zranitelnosti (nenastavené heslo pro správce databáze atd.) a získat přístup k citlivým datům nebo chráněné vnitřní službě, která není zvnějšku přístupná. Může zkoušet různé zranitelnosti jádra či pod rootem běžících démonů, aby získal root Shell. I uživatelský účet ovšem většině útočníků stačí – mohou na server nainstalovat software, který jim umožní začlenit server do botnetu – častý je v takové situaci upravený IRC bot, který se připojí na specifikovaný IRC kanál a čeká na příkazy od útočníka, ale stejně tak může „robot“ hledat příkazy od útočníka prostřednictvím protokolu HTTP a některých veřejných služeb jako Twitter apod.</p>

<p>Třetí možností je omezený přístup třeba k interpretu programovacího jazyka apod. – i to někdy stačí k začlenění serveru do botnetu nebo k možnosti postoupit dál k některému z horších scénářů. V této situaci se útočník patrně také dostane, byť třeba pouze omezeně, k datům (přístup k databázi apod.). Útočník samozřejmě může také získat přístup do administračního rozhraní webové aplikace apod. – to sice není až tak kritické z pohledu bezpečnosti serveru, ale z pohledu bezpečnosti služby, kterou server poskytuje, to problém samozřejmě je.</p>

<p>Obecně, vnitřní útoky jsou mnohem závažnější, protože uchránit vnitřek systému bývá obecně mnohem složitější než ochránit systém zvnějšku. Řada služeb nemusí být zvnějšku přístupná, ale zevnitř dané služby přístupné jsou – např. databázový server. Stejně tak má útočník přístup k podrobným informacím o systému, k řadě nástrojů, které jsou na serveru nainstalované, a co je horší, má možnost nainstalovat si na server své nástroje.</p>

<h4>Automatizované a cílené útoky</h4>

<p>Většina útoků, se kterými se na serverech potkáte, budou automatizované. Jsou to roboti, kteří na povel útočníka skenují síť a hledají počítače s běžícími službami, přes které se pak snaží získat přístup k Shellu nebo takový přístup, který jim obvykle umožní nainstalovat program, pomocí kterého začlení daný počítač do botnetu. To se dá realizovat i bez přístupu k Shellu, třeba prostřednictvím zranitelnosti ve webové aplikaci. V rámci botnetu pak server rozesílá spam, skenuje nebo útočí na jiné počítače v síti, v horším případě skladuje nějaký ilegální materiál (popř. slouží jako prostředník pro distribuci takového materiálu).</p>

<p>Automatizované útoky jsou sice časté, ale představují relativně menší hrozbu – většina z nich se pokusí najít nějakou triviální zranitelnost, a pokud ji robot nenajde, jde „o dům dál“. Pravidelně aktualizovaný software a dobrá politika volby přístupových hesel jako obrana postačí. Horší jsou cílené útoky, kde sice může, ale také nemusí docházet k proniknutí útočníka do systému – pro tuto oblast jsou pak charakteristické DoS a DDoS útoky, a to buď na úrovni služby, kterou jeden nebo více počítačů zahltí požadavky, nebo na úrovni sítě (cílová IP adresa je zahlcena pakety). Cílený útok je nebezpečnější v tom, že za ním obvykle stojí konkrétní útočník nebo útočníci, tedy lidé, a ne automatizované nástroje. V případě napadení serveru zevnitř dokáže šikovný útočník buď získat roota (využitím nějaké zranitelnosti), nebo provést DoS útok na server zevnitř, třeba tzv. fork bombou.</p>

<h4>Motivy a cíle útoků</h4>

<p>Motivy útoků mohou být samozřejmě různé. Nejčastější je snaha začlenit server do botnetu, a prostřednictvím něj pak páchat různou činnost (rozesílání spamu, DDoS útoky na jiné počítače apod.). V některých případech jsou počítače napadány s cílem jejich „prodeje“, resp. prodeje získaného přístupu k danému počítači. Ostatní motivy mohou zahrnovat osobní důvody (msta bývalého zaměstnance či nespokojeného zákazníka, ale i útok nějakého nezúčastněného, kterému se váš server jen tak znelíbil), konkurenční boj, vydírání apod.</p>

<p>Cíle útoků mohou zahrnovat kromě zahlcení serveru (DoS) a začlenění serveru do botnetu i získání cenných dat, které server obsahuje, tzn. databáze zákazníků, osobních údajů, čísel kreditních karet apod. Destruktivní cíle (zničení serveru, smazání určitých dat apod.) jsou méně časté, ale mohou být součástí třeba konkurenčního boje nebo msty. Předpokládám nicméně, že většina čtenářů této knihy se bude potýkat výhradně s automatizovanými útoky.</p>

<h2>Bezpečnost a monitorování systému</h2>

<h3>Optimální zabezpečení serveru</h3>

<p>Na úvod opět zdůrazním, že bezpečnostní opatření jsou kompromisem mezi vynaloženými prostředky a dosažením požadované úrovně zabezpečení. Jinými slovy, opatření je třeba volit s ohledem na to, co chcete chránit, před čím a jaké máte dostupné prostředky. Optimální zabezpečení serveru je tedy takové, které si zvolíte s ohledem na situaci.</p>

<p>Jedním z důležitých předpokladů pro bezpečnost serveru je rozumět systému jako takovému, dále službám, které na serveru provozujete, stejně jako všem bezpečnostním opatřením, které se rozhodnete nasadit. Nasazovat něco, o čem netušíte, jak to vlastně funguje, představuje potenciální riziko. Dostupnost nejrůznějších návodů pro konfiguraci té či oné služby je v tomto případě částečně kontraproduktivní, protože vás nevede k tomu, abyste nejprve nahlédli do oficiální dokumentace.</p>

<p>Ideální je, pokud máte možnost server nakonfigurovat od začátku, tj. pokud dostanete čistý server, na který je třeba systém teprve nainstalovat. V takovém případě doporučuji začít s minimální možnou instalací a instalovat pouze to, co potřebujete. Pokud se dostanete k fungujícímu serveru, proberte jako první krok všechny služby, a ty, které nepotřebujete, ze systému odstraňte.</p>

<h3>Ochrana systému</h3>

<p>Prvním předpokladem pro bezpečný systém je jeho pravidelná aktualizace. V případě Debianu můžete použít nástroje jako <code>apticron</code> či <code>apt-listchanges</code>, které vás informují o dostupných aktualizacích, jakmile se objeví, a vy pak můžete systém včas aktualizovat. Samozřejmě je možné zajistit i automatickou aktualizaci, ale bývá dobré aktualizace provádět spíše ručně (v některých případech mohou vyžadovat interakci, což automatický skript nezajistí).</p>

<h4>Ochrana proti síťovým útokům</h4>

<p>Síťové útoky směřující na server je možné detekovat pomocí nástrojů, které se schovávají pod zkratkou IDS (Intrusion Detection System). Tyto nástroje buď pasivně naslouchají na síti a hledají typické znaky útoků (např. <code>snort</code>), nebo si sami zaberou porty služeb, které nejsou v systému nainstalované, a monitorují přístupy na tyto porty (nástroj <code>portsentry</code>). Tyto nástroje nicméně umí provádět nejenom pasivní monitorování, ale také aktivní, tzn. umí reagovat na události (a třeba zablokovat IP adresu, která provádí port scan). V souvislosti s tím je třeba poukázat na možné otevření okna pro DoS útok, budete-li používat automatizovanou obranu – vždy zvažte, co se stane, pokud útočník bude na server útočit, ale s falešnou zdrojovou IP adresou. Upozorňuji, že nastavení těchto nástrojů (např. konfigurace vlastních pravidel pro <code>snort</code>) může být poměrně komplikované i pro pokročilejšího správce.</p>

<h4>Ochrana souborů</h4>

<p>Pokud se útočník dostane do systému a třeba získá oprávnění uživatele root, bude se nejspíše snažit upravit klíčové nástroje (Shell, <code>ls</code>, <code>ps</code>, jádro apod.). V takovém případě se hodí nástroje pro ověřování integrity souborů, tedy nástroje jako <code>Tripwire</code>, <code>stealth</code>, <code>aide</code> apod., které umožňují vytvářet databázi zabezpečených kontrolních součtů vybraných souborů, a ty pak ověřovat. K zabezpečení se obvykle používá asymetrického šifrování. V případě použití těchto nástrojů je třeba dbát na správný postup a na možnosti útočníka (útočník může kompromitovat i samotný nástroj, popřípadě jeho databázi).</p>

<h4>Ochrana vůči rootkitům</h4>

<p>Rootkit je typický nástroj útočníka, který získá oprávnění uživatele root – je to sada nástrojů sloužící jednak k zajištění pohodlného vzdáleného přístupu ke kompromitovanému systému, ale také k ukrytí útočníkovi přítomnosti. Některé typické znaky rootkitů mohou odhalit nástroje jako <code>chkrootkit</code> nebo <code>rkhunter</code>. Opět zde však platí to, co bylo řečeno výše – v případě kompromitovaného systému je třeba počítat i s tím, že útočník kompromituje i samotný nástroj pro jeho odhalení.</p>

<h4>Zálohování</h4>

<p>Nepředpokládám, že vám musím připomínat, že je třeba provádět pravidelné zálohy. Viz kapitola {link:"Údržba systému":"Zálohování"}.</p>

<h3>Monitorování systému a služeb</h3>

<p>Každý server je třeba monitorovat, tzn. pročítat logy, sledovat různé údaje a jejich změny v čase, abyste včas odhalili případné problémy. Zásadní je sledování logů. To můžete dělat ručně, ale bývá dobré si je nechat zasílat zpracované mailem. Za tímto účelem existují nástroje jako <code>logwatch</code> či <code>logcheck</code>, řízené cronem, které vám jednou za určitou dobu zašlou e-mail se všemi podstatnými událostmi, popřípadě zkonstruují výtah, který se čte o poznání lépe (to zajišťuje třeba <code>logwatch</code>). Tyto nástroje je možné poměrně precizně řídit a filtrovat irelevantní informace, nebo naopak rozšiřovat množství sdělovaných informací. Viz kapitola {link:"Monitorování a logy":"Logování"}.</p>

<p>Sledovat základní údaje jako obsazení paměti, zátěž systému, průchodnost fronty poštovního serveru apod., vám umožní třeba <code>munin</code> ve spolupráci s <code>munin-node</code>. Výstupem je HTML stránka s grafy, které se generují z naměřených hodnot. Z nich můžete vyčíst zdroj nějakých potíží, popřípadě naplánovat, co je třeba na serveru upravit (více operační paměti atd.). Bývá dobré nenechávat výstup nástroje <code>munin</code> dostupný z webu alespoň bez nějakého ověření, neboť může obsahovat informace, které mohou být teoreticky využity útočníkem (i když zrovna neobsahuje vyloženě citlivé údaje). Viz kapitola {link:"Monitorování a logy":"Sledování systému pomocí nástroje Munin"}.</p>

<p>K monitorování teplot můžete použít nástroj <code>lm-sensors</code>, k monitorování teplot pevného disku pak <code>hddtemp</code>. K monitorování zdraví pevných disků můžete použít balíček <code>smartmontools</code> a k monitorování softwarového RAIDu můžete použít přímo <code>mdadm</code> démona. Viz kapitola {link:"Správa disků"}.</p>

<h2>Bezpečnost služeb</h2>

<h3>Ochrana služeb</h3>

<h4>Izolace služeb, chroot a virtualizace</h4>

<p>U jednotlivých služeb je především třeba si projít dokumentaci a nastavit je co nejbezpečněji. Nemusí být od věci pokusit se jim omezit přístup jen tam, kam opravdu potřebují. Za tímto účelem je používán nástroj (resp. systémové volání) <code>chroot</code>, kdy se pro službu změní kořenový adresář za nějaký adresář v hierarchii systému (např. adresář s daty). To znamená, pokud konfigurujete webový server s chrootem, pak pro běžící webový server nebude kořenový adresář systémový <code>/</code>, ale třeba <code>/var/www</code>. I kdyby útočník kompromitoval webový server a získal nad ním kontrolu, dostane se pouze k datům ve <code>/var/www</code>, nikoliv pak ke zbytku systému. Konfigurace chrootu nicméně bývá obtížná, zejména tam, kde má aplikace více komponent (např. Apache a PHP), protože do chrootu se pak musí umístit i příslušné binárky, knihovny a v některých případech i speciální zařízení (např. <code>/dev/null</code> apod.). A všechny tyto komponenty je pak samozřejmě třeba pravidelně aktualizovat. Navíc má chroot řadu reálných či potenciálních bezpečnostních problémů. Předně, proces běžící s právy roota se z chrootu může dostat a získat přístup k celému systému (to řeší např. projekt <code>grsecurity</code>, ale ten není oficiální součástí jádra).</p>

<p>Jiné možnosti izolace služeb představuje virtualizace – dnes není až takový problém izolovat služby do několika virtuálních strojů, které běží na jednom fyzickém serveru. Tato forma izolace sice zkomplikuje správu a údržbu takového řešení, ale zase zajistí, že případný útočník, který získá oprávnění roota, kompromituje virtuální server, na kterém běží třeba jen webový server, ale už ne databáze. Nebo, ještě lépe, útočník se probourá na virtuální server, kde běží pouze proxy, která zajišťuje předávání požadavků některému z dalších virtuálních serverů. Dlužno dodat, že i v rámci virtualizace může existovat nějaká zranitelnost, která může za jistých okolností útočníkovi umožnit získat přístup k hypervizoru, tedy mateřskému systému, který virtualizaci řídí a má přístup ke všem virtuálním strojům, i když tato šance je podstatně nižší.</p>

<h4>Přístup k síti a síťové útoky</h4>

<p>Pokud není třeba, aby daná služba poslouchala na síti (např. databáze), pak ji nastavte tak, aby naslouchala jen na místní smyčce (<code>127.0.0.1</code>). Někdy se stane, že služba otevírá kromě standardních portů i nějaký další, který třeba slouží pro synchronizaci v clusteru nebo pro správu dané služby, a vy nemůžete nastavit, aby v případě tohoto portu naslouchala jen na místní smyčce. V takovém případě můžete využít firewallu a zablokovat přístup k danému portu (tedy pokud se port při každém spuštění nemění, s čímž už jsem se také setkal – pak pomůže nastavit u firewallu výchozí politiku řetězce <code>INPUT</code> na <code>DROP</code> a naopak jen povolit, co je třeba – toto je ostatně z hlediska stavění firewallu vhodná strategie).</p>

<p>Vůči síťovým útokům vám mohou pomoci nástroje jako <code>fail2ban</code> (či <code>denyhosts</code> v případě SSH). Ty mohou zablokovat útočníka, pokud začne páchat brute force útok s různými jmény a hesly ve snaze získat někam přístup. Něco podobného je s jistými omezeními možné vytvořit i na úrovni firewallu. Více v kapitole o zabezpečení SSH{link:“Bezpečnost“:“Zabezpečení SSH: praktické rady“:“Aktivní zabezpečení SSH na úrovni firewallu“}. V některých případech lze použít aplikační proxy, ve které můžete precizněji filtrovat typy požadavků na samotnou aplikaci (pokud to jde, je lepší to dělat spíše na úrovni dané služby). Extrémnějším řešením může být skrývání služeb prostřednictvím port knockingu, který je probrán opět v kapitole o zabezpečení SSH{link:“Bezpečnost“:“Zabezpečení SSH: praktické rady“:“Port knocking“}. Samozřejmě, že port knocking lze uplatnit spíše u služeb jako právě SSH, kde není třeba, aby byla daná služba viditelná pro veřejnost.</p>

<p>V neposlední řadě může pomoci i výběr samotných aplikací – některé aplikace mají nepříjemnou historii mnoha bezpečnostních problémů, zatímco jiné byly postaveny s ohledem na bezpečnost, a bezpečnostní problémy u nich nejsou hlášeny tak často. Ze stejných důvodů bývá dobré volit zralé služby, které vyvíjí aktivní komunita, spíše než experimentální služby v rané vývojové fázi, které vyvíjí třeba jediný člověk.</p>

<h4>Bezpečnostní patche, SELinux, AppArmor</h4>

<p>Existuje řada oficiálních či méně oficiálních bezpečnostních patchů, které si kladou za cíl zjemnit systém oprávnění tak, aby ani služba běžící s právy roota v případě kompromitace neumožnila postup útočníka do zbytku systému. Zde je nejvíce známý v jádře obsažený SELinux, který je ovšem natolik komplexní, že se ho řada správců štítí, popřípadě ho rovnou vypínají, pokud jej distribuce ve výchozím stavu zapíná. Konkurencí pro SELinux je AppArmor, který je jednodušší, zejména pak na tvorbu nových pravidel (AppArmor to řeší tak, že aplikaci sleduje, zjišťuje, kam přistupuje, a podle toho sám tvoří pravidla přístupu). Dalším zajímavým bezpečnostním patchem je <code>grsecurity</code>, který mj. řeší i bezpečnost chrootu. Tyto mechanismy umožňují zvýšit bezpečnost provozu služeb, ale cenou za jejich použití je nutnost jim dobře porozumět. Jejich nevýhodou je, že špatně nastavená pravidla mohou vést k nefunkčnosti (v lepším případě), nebo k zvláštnímu až takřka „nevysvětlitelnému“ chování jednotlivých služeb (v horším případě). Např. SELinux závisí na značkování souborů, takže když jsem jednou přenášel soubory z <code>/var/lib/mysql</code> při přesunu dat z jednoho serveru na druhý, přepsal jsem označkované soubory novými, a pak jsem dlouho řešil, proč MySQL tvrdí, že nemá oprávnění přistupovat do tohoto adresáře, když všechna unixová práva jsou nastavena správně. Přirozeně, SELinux umožňuje provádět přeznačkování souborového systému, ale o tom vy musíte vědět a musí vás to napadnout.</p>

<h3>Ochrana sítě</h3>

<p>Pokud provozujete třeba domácí server, nebo naopak server v podnikové síti, pak se vás týká nejenom zabezpečení serveru, ale také sítě, ve které se server nachází, a to pokud možno tak, aby případná kompromitace serveru neohrozila jiné počítače v síti. S tím vám může pomoci samotná síťová architektura, respektive tzv. demilitarizovaná zóna. To je koncept, kde figuruje router/firewall se třemi síťovými rozhraními – k jednomu je připojen internet, ke druhému místní síť a ke třetímu samotný server. Firewall pak řídí přístup tak, aby server mohl přistupovat na internet (a internet naopak k němu), ale aby nemohl přistupovat do místní sítě, zatímco místní síť k serveru přistupovat může. Viz kapitola {link:"Bezpečnost":"Linuxový firewall"} nebo článek o linuxových DMZ v odkazech pod kapitolou. Další mechanismy pro ochranu sítě zahrnují IDS (Intrusion Detection System), které mohou síť sledovat a upozornit na případné útoky.</p>

<h3>Příliš mnoho bezpečnostních opatření může škodit</h3>

<p>Možností pro zvýšení bezpečnosti je mnoho. Já jsem nicméně zastáncem teorie, že příliš mnoho bezpečnostních opatření může ve výsledku buď narušit funkcionalitu či dostupnost, nebo vést paradoxně ke snížení bezpečnosti. Typický příklad snížení bezpečnosti je agresivní politika hesel, která u uživatelů vede k tomu, že si heslo napíší na papírek a nalepí na monitor. Jinou možností může být skutečnost, že každá další služba, kterou na server nasadíte, byť je určena k zajištění bezpečnosti, je místem, kde se může objevit zranitelnost. Pokud tato služba naslouchá přímo na síti nebo monitoruje jakýkoliv uživatelský vstup (viz parsery logů v kapitole o zabezpečení SSH{link:“Bezpečnost“:“Zabezpečení SSH: praktické rady“:“Denyhosts“}, je to potenciální problémové místo. Řada aktivních bezpečnostních opatření pak může vést k zablokování přístupu nebo omezení dostupnosti služby. Stejně tak vede příliš mnoho bezpečnostních opatření k tomu, že je lidé (nebo hůř – samotní správci) začnou obcházet či ignorovat a dané bezpečnostní opatření pak ztratí účinnost. Proto je třeba navrhovat bezpečnost rozumně.</p>

http://cs.wikipedia.org/wiki/Fork_bomba Wikipedie (česká), Fork bomba
http://www.abclinuxu.cz/clanky/bezpecnost/linuxove-dmz-i ABCLinuxu, Linuxové DMZ
