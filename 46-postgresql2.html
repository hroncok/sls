<meta http-equiv="content-type" content="text/html;charset=utf-8" />


<h1>Správa linuxového serveru: PostgreSQL: Klienti a zálohování</h1>

<p>Minulý díl se věnoval instalaci a zprovoznění PostgreSQL. Tento díl představí klienty pro správu a obsluhu Postgresu a zmíní zálohování a obnovu Postgresu.</p>

<h3>Řádkový klient psql a změna hesla uživatele</h3>
<p>Po instalaci Postgresu na server budete mít k dispozici řádkového klienta <code>psql</code>. Pokud při jeho spuštění nepoužijete žádné parametry, pokusí se připojit k místní databázi jako uživatel, pod kterým jste přihlášeni. Uživatelem s administrátorskými právy je v případě Postgresu uživatel <code>postgres</code>, nikoliv „obvyklý“ uživatel <code>root</code>. Pokud jste uživateli <code>postgres</code> nenastavili vlastní heslo, budete muset získat přístup k DBMS bez hesla, a sice jako unixový uživatel <code>postgres</code>:</p>
<pre>su postgres -</pre>
<p>Poté můžete spustit klienta <code>psql</code>:</p>
<pre>postgres@debian:/root$ psql
psql (8.4.7)
Pro získání nápovědy napište "help".

postgres=#</pre>
<p>Chcete-li nastavit uživateli <code>postgres</code> nějaké heslo, abyste mohli k DBMS přistupovat jako databázový uživatel <code>postgres</code> bez nutnosti měnit unixového uživatele pomocí <code>su</code>, použijte buď interaktivní příkaz <code>\password</code>, nebo SQL příkaz <code>ALTER ROLE</code>:</p>
<pre>postgres=# ALTER ROLE postgres WITH PASSWORD 'moje_dlouhe_a_bezpecne_heslo';</pre>
<p>Budete-li chtít provádět administrátorské úkony třeba ze skriptů spuštěných s právy roota, můžete samozřejmě použít <code>su</code> mechanismu pro změnu efektivního uživatele na <code>postgres</code>, jen je třeba si dát pozor na to, že uživatel <code>postgres</code> má na rozdíl od roota právo zápisu pouze do některých adresářů (zejména <code>/var/lib/postgres</code>, kde sídlí konfigurační i datové soubory DBMS). Jinou možností je nastavit databázovému uživateli <code>postgres</code> heslo a přistupovat k němu pohodlně pod jakýmkoliv uživatelem. Zde ovšem přichází na řadu drobný problém, a sice jakým způsobem nástroji <code>psql</code> předat heslo, aby nebylo nutné jej pokaždé zadávat interaktivně. Za tímto účelem můžete použít soubor <code>.pgpass</code>, který vytvořte ve svém domovském adresáři se obsahem podle následujícího <a href="http://wiki.postgresql.org/wiki/Pgpass">vzoru</a>:</p>
<pre>jmeno_pocitace:port:databaze:uzivatel:heslo</pre>
<p>Konkrétní příklad pro Postgres běžící na localhostu na standardním portu, uživatele <code>postgres</code> a libovolnou databázi by mohl vypadat třeba takto:</p>
<pre>localhost:5432:*:postgres:moje_dlouhe_a_bezpecne_heslo</pre>
<p>Samotné přihlášení k DBMS pomocí <code>psql</code> pak provedete takto:</p>
<pre>psql -U postgres -h localhost -p 5432</pre>
<p>Parametr <code>-U</code> značí uživatele, <code>-h</code> název počítače, na kterém běží DB, a <code>-p</code> udává port (Postgres standardně běží na portu 5432).</p>
<h4>Nouzový rychlokurz psql</h4>
<p>Jste-li zvyklí převážně na MySQL a na příkazy typu <code>SHOW DATABASES</code> či <code>SHOW TABLES</code>, které vám v <code>psql</code> určitě fungovat nebudou, hodí se vám tento nouzový rychlokurz klienta <code>psql</code>. Dodávám, že samotný nástroj <code>psql</code> má velmi dobrou <a href="http://www.postgresql.org/docs/8.4/interactive/app-psql.html">dokumentaci</a>, kterou určitě doporučuji prostudovat.</p>
<p><strong>Globální operace</strong></p>
<ul>
<li>
<p><code>\l</code> - 	vypíše seznam databází a základních informací o nich</p>
</li>
<li>
<p><code>\db</code> - 	vypíše seznam tablespaces</p>
</li>
<li>
<p><code>\dg</code> - 	vypíše seznam rolí</p>
</li>
<li>
<p><code>\dn</code> - 	vypíše seznam schémat</p>
</li>
<li>
<p><code>\password 	[uzivatel]</code> - interaktivní nastavení hesla uživatele 	<code>uzivatel</code>; pokud nebude zadán uživatel, 	změna se bude týkat aktuálně přihlášeného uživatele</p>
</li>
<li>
<p><code>\c [databaze] [uzivatel] [pocitac] 	[port]</code> - připojí se k databázi</p>
</li>
</ul>
<p><strong>Operace nad konkrétní databází</strong></p>
<ul>
<li>
<p><code>\di</code> - 	vypíše seznam indexů</p>
</li>
<li>
<p><code>\ds</code> - 	vypíše seznam sekvencí</p>
</li>
<li>
<p><code>\dt</code> - 	vypíše seznam tabulek</p>
</li>
<li>
<p><code>\dv</code> - vypíše seznam pohledů 	(views)</p>
</li>
</ul>
<h3>Webový klient phppgadmin</h3>
<p class="ph_center"><a href="http://www.linuxexpres.cz/uploads/gallery/original/4406.jpg" onclick="myPopImage('http://www.linuxexpres.cz/uploads/gallery/original/4406.jpg','phppgadmin: Uživatel postgres přihlášený ihned po instalaci','1678','918'); return false;"><img alt="phppgadmin: Uživatel postgres přihlášený ihned po instalaci" class="ph_detail" height="244" src="http://www.linuxexpres.cz/uploads/gallery/detail/4406.jpg" width="446" /></a> <span class="ph_title">phppgadmin: Uživatel postgres přihlášený ihned po instalaci</span></p>
<p>Znáte-li MySQL, znáte také určitě vynikajícího webového klienta/správce <a href="http://www.phpmyadmin.net/">phpMyAdmin</a>. Ten je ovšem stavěn pouze pro MySQL a pro Postgres jej není možné použít. Existuje však jiný projekt, a sice <a href="http://phppgadmin.sourceforge.net/">phpPgAdmin</a>, který se snaží kráčet ve stejných šlépějích jako phpMyAdmin, přičemž je stavěn pro Postgres. Jeho instalace v Debianu je velmi jednoduchá, stačí nainstalovat příslušný balíček:</p>
<pre>aptitude install phppgadmin</pre>
<p>Používáte-li webový server Apache, bude jeho konfigurace automaticky upravena při instalaci balíčku, a to přidáním symbolického odkazu <code>phppgadmin</code> do <code>/etc/apache2/conf.d</code>. Pro úplnost dodávám, že tento symbolický odkaz ukazuje na <code>/etc/phppgadmin/apache.conf</code>. Výchozí úprava konfigurace pro Apache je poměrně restriktivní, umožňuje pouze připojení z localhostu. Pokud budete chtít tento nástroj využívat k provádění správcovských činností, nemusí být od věci to tak nechat (a použít SSH tunel), popřípadě povolit přístup pouze z některých počítačů:</p>
<pre>allow from 1.2.3.4</pre>
<p class="ph_center"><a href="http://www.linuxexpres.cz/uploads/gallery/original/4407.jpg" onclick="myPopImage('http://www.linuxexpres.cz/uploads/gallery/original/4407.jpg','phppgadmin: Pohled na nově vytvořené databáze','1678','918'); return false;"><img alt="phppgadmin: Pohled na nově vytvořené databáze" class="ph_detail" height="244" src="http://www.linuxexpres.cz/uploads/gallery/detail/4407.jpg" width="446" /></a> <span class="ph_title">phppgadmin: Pohled na nově vytvořené databáze</span></p>
<p>Samotné přihlášení administrátora je v <code>phppgadmin</code> rovněž zakázáno. To má na svědomí volba <code>extra_login_security</code> v <code>/etc/phppgadmin/config.inc.php</code>:</p>
<pre>$conf['extra_login_security'] = true;</pre>
<p>Jste-li si jisti, že chcete přihlášení správců opravdu povolit, je třeba tuto volbu nastavit na <code>false</code>.</p>
<h3>Desktopový GUI klient pgAdmin III</h3>
<p><a href="http://www.pgadmin.org/">pgAdmin III</a> je patrně nejlepší dostupný FOSS nástroj určený pro správu Postgres DBMS. Jedná se o multiplatformní desktopovou aplikaci, která umožňuje připojení k místním i vzdáleným databázím, jejich pohodlnou správu i klasický SQL přístup. SQL dotazy je možné zadávat ručně nebo je sestavit graficky. Podporuje jak Postgres, tak některé jeho komerční a proprietární klony. Je schopen zobrazit a pracovat s veškerými Postgres objekty, ke kterým umí i zobrazit jejich SQL definice (což by mělo být vidět na screenshotu níže).</p>
<p class="ph_center"><a href="http://www.linuxexpres.cz/uploads/gallery/original/4403.jpg" onclick="myPopImage('http://www.linuxexpres.cz/uploads/gallery/original/4403.jpg','Pohled na jednu z tabulek v pgAdmin III','1679','1028'); return false;"><img alt="Pohled na jednu z tabulek v pgAdmin III" class="ph_detail" height="273" src="http://www.linuxexpres.cz/uploads/gallery/detail/4403.jpg" width="446" /></a> <span class="ph_title">Pohled na jednu z tabulek v pgAdmin III</span></p>
<p class="ph_center"><a href="http://www.linuxexpres.cz/uploads/gallery/original/4404.jpg" onclick="myPopImage('http://www.linuxexpres.cz/uploads/gallery/original/4404.jpg','Jednoduchý SQL dotaz v pgAdmin III','1678','1027'); return false;"><img alt="Jednoduchý SQL dotaz v pgAdmin III" class="ph_detail" height="273" src="http://www.linuxexpres.cz/uploads/gallery/detail/4404.jpg" width="446" /></a> <span class="ph_title">Jednoduchý SQL dotaz v pgAdmin III</span></p>
<p>Tento nástroj je běžně dostupný v repozitářích linuxových distribucí, v Debianu se jedná o balíček <code>pgadmin3</code>.</p>
<p class="ph_center"><a href="http://www.linuxexpres.cz/uploads/gallery/original/4405.jpg" onclick="myPopImage('http://www.linuxexpres.cz/uploads/gallery/original/4405.jpg','Grafické sestavení dotazu v pgAdmin III','1678','1027'); return false;"><img alt="Grafické sestavení dotazu v pgAdmin III" class="ph_detail" height="273" src="http://www.linuxexpres.cz/uploads/gallery/detail/4405.jpg" width="446" /></a> <span class="ph_title">Grafické sestavení dotazu v pgAdmin III</span></p>
<p>Samotné připojení ke vzdálené databázi je možné provést řadou způsobů. Pro správce je patrně nejrychlejší použít SSH tunel, jehož vytvoření je popsáno v <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-uvod-do-ssh-pro-spravce">Úvodu do SSH pro správce</a>. Je samozřejmě také možné nastavit Postgres, aby přijímal spojení ze sítě a umožňoval přihlášení uživatele či uživatelů z určité IP adresy. K tomu slouží konfigurační soubor <code>pg_hba.conf</code>, který v Debianu Squeeze s Postgresem 8.4 naleznete v <code>/etc/postgresql/8.4/main/</code>.</p>
<h3>Zálohování Postgresu</h3>
<p>K zálohování konkrétní databáze se používá nástroj <code>pg_dump</code>, který má stejné parametry jako interaktivní klient <code>psql</code>. Zálohování databáze <code>postfix</code> dostupné na místním serveru a na standardním portu by se tedy s použitím uživatele <code>postgres</code> provedlo takto:</p>
<pre>pg_dump -U postgres -h localhost -p 5432 postfix &gt; zaloha_postfix.sql</pre>
<p>Výstupem je obsah tabulky v SQL, který by se vypsal na standardní výstup (tedy obvykle přímo do konzole), proto bylo v tomto případě použito přesměrování do souboru <code>zaloha_postfix.sql</code>. V případě větší databáze by bylo vhodnější zapojit kompresi, například takto:</p>
<pre>pg_dump -U postgres -h localhost -p 5432 postfix | gzip &gt; zaloha_postfix.sql.gz</pre>
<p>Chcete-li zazálohovat celý databázový cluster, použijete nástroj <code>pg_dumpall</code>, prakticky totožným způsobem jako <code>pg_dump</code>, pouze neuvedete název konkrétní databáze pro zálohování (zde už raději uvádím pouze příklad s kompresí):</p>
<pre>pg_dump -U postgres -h localhost -p 5432 | gzip &gt; zaloha_clusteru.sql.gz</pre>
<h3>Obnova ze záloh</h3>
<p>Tento článek začal představením klienta <code>psql</code> a tímto nástrojem také skončí. Jelikož záloha DB/DBMS má podobu sady SQL příkazů uložených v určitém souboru, není nic jednoduššího než vzít klienta <code>psql</code> a všechny SQL příkazy postupně provést, takto:</p>
<pre>psql -U postgres -h localhost -p 5432 &lt; zaloha.sql</pre>
<p>V případě komprimovaného archívu si můžete pomoci rourou, takto:</p>
<pre>gzip -c -d zaloha_clusteru.sql.gz | psql -U postgres -h localhost -p 5432</pre>
<p class="box">Nezapomeňte se přečíst náš <a href="http://www.linuxexpres.cz/praxe/optimalizace-databaze-postgresql">seriál o optimalizaci PostgreSQL</a>.</p>

<pre id="links">http://postgres.cz Český portál/wiki o Postgresu
http://www.postgresql.org/docs/8.4/interactive/app-psql.html psql
http://www.postgresql.org/docs/8.4/static/backup.html Backup and Restore</pre>
