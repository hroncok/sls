<meta http-equiv="content-type" content="text/html;charset=utf-8" />


<h1>Správa linuxového serveru: Praxe šifrování s dm-crypt/LUKS</h1>

<p>Minule jsem vás uvedl to teorie diskového šifrování, dnes se na toto téma
podívám z praktického hlediska.</p>

<h3>dm-crypt/LUKS</h3>

<p><a href="http://en.wikipedia.org/wiki/Dm-crypt">dm-crypt</a> je specifický
subsystém linuxového jádra, který využívá infrastrukturu device mapperu a
linuxového CryptoAPI, a vytváří transparentní vrstvu pro online šifrování a
dešifrování blokových zařízení. Dodávám, že <code>dm-crypt</code> je možné
využívat samostatně, bez LUKS nadstavby, a to prostřednictvím stejného nástroje
- <code>cryptsetup</code>. V tomto článku se však plně zaměřím právě na LUKS.</p>

<p><a href="http://code.google.com/p/cryptsetup/">LUKS</a> je nadstavba
dm-cryptu, která, vezmu-li to zjednodušeně, přidává dvouúrovňové šifrování,
správu klíčů a funkci pro posílení uživatelského hesla <b>PBKDF2</b>.
Specifikace LUKS je multiplatformní a je možné s jeho pomocí vytvářet šifrované
kontejnery, které lze otevřít i v jiných operačních systémech (třeba s pomocí
aplikace pro MS Windows s názvem <a
href="http://www.freeotfe.org/">FreeOTFE</a>).</p>

<p>Dvouúrovňové šifrování v případě LUKS znamená, že samotný svazek je šifrován
tzv. hlavním klíčem (master key), který je následně zašifrován uživatelským
heslem a uložen do jednoho z úložišť (slotů). Z toho vyplývá jak na jedné
straně velká výhoda v podobě nezávislosti šifrování na uživatelském hesle, a
tudíž možnost bezproblémové revokace (či změny) existujícího přístupového
hesla, tak na straně druhé nevýhoda spočívající v potenciální ztrátě dat, je-li
nezálohovaná hlavička s úložištěm klíčů přepsána.</p>

<h3>Příprava budoucího šifrovaného svazku</h3>

<p>Ještě než začnete s vytvářením šifrovaného svazku, je dobré příslušné
blokové zařízení zaplnit co nejkvalitnějšími náhodnými daty. Je to z toho
důvodu, aby případný kryptoanalytik viděl na daném blokovém zařízení jednu
celistvou oblast a neměl možnost uhodnout, které bloky jsou opravdu šifrované a
které ne (zašifrovaná data by měla být neodlišitelná od náhodných dat), což by
mu mělo o něco více zkomplikovat jeho práci. Tento krok sice není nutný, ale
bývá vhodné ho provést.</p>

<p>Zcela ideální k zaplnění svazku náhodnými daty by bylo použít generátor
náhodných čísel <code>/dev/random</code>. Tento generátor vytváří kvalitní
náhodná čísla, ale je neuvěřitelně pomalý. Z tohoto důvodu je podstatně
vhodnější použít zařízení <code>/dev/urandom</code>, které sice generuje méně
"kvalitní" náhodná čísla, ale generuje je neporovnatelně rychleji.</p>

<p>K samotnému zaplnění zvoleného svazku náhodnými daty použijte nástroj
<code>dd</code>:</p>

<pre>dd if=/dev/urandom of=/dev/svazek</pre>

<p>Tato procedura bude obvykle trvat velmi dlouho, řádově hodiny až dny.
Existují sice metody, jak tuto fázi uspíšit, ale jejich důsledkem je
zaplnění svazku méně kvalitními náhodnými daty, které patrně může zkušený 
kryptoanalytik rozeznat od šifrovaných dat, což by činilo celý tento krok
zbytečným.</p>

<p>Já osobně používám následující urychlovací metodu. Dodávám však, že nejsem
kryptolog ani kryptoanalytik, tudíž nejsem schopen odhadnout, zda-li je to
správný postup nebo naopak z nějakého důvodu velmi špatný.</p>

<p>Můj postup je následující - vytvořím šifrovaný svazek (viz další bod),
následně použiji nástroj <code>badblocks</code> k zaplnění svazku nekvalitními
náhodnými daty, která by ovšem po zašifrování měla být nerozeznatelná od
kvalitních (nebo od skutečných zašifrovaných dat):</p>

<pre>badblocks -v -s -w -t random /dev/mapper/desifrovany_svazek</pre>

<p>Následně svazek odpojím pomocí <code>luksClose</code> (viz níže) a přepíšu
ještě začátek oddílu s LUKS hlavičkou pomocí <code>/dev/urandom</code>:</p>

<pre>dd if=/dev/urandom of=/dev/zarizeni bs=1M count=32</pre>

<h3>Vytvoření šifrovaného svazku</h3>

<p>Ke všem operacím se šifrovanými svazky budeme využívat nástroje
<code>cryptsetup</code>. Ten byste měli mít k dispozici v repositářích vaší
distribuce (v případě Debianu se tento nástroj nachází ve stejnojmeném
balíčku). Vytvoření šifrovaného svazku provedete s použitím šifrovacího
algoritmu AES a módu XTS takto:</p>

<pre>cryptsetup -c aes-xts-benbi -s 512 -y luksFormat /dev/svazek</pre>

<p>Povšimněte si parametru <code>-c</code>, kde je na prvním místě šifrovací
algoritmus, na druhém, oddělen pomlčkou, šifrovací mód a na třetím způsob
generování inicializačního vektoru (v případě XTS máte na výběr mezi 32-bitovým
"plain" a 64-bitovým "benbi"). Parametr <code>-s</code> udává délku klíče,
<code>-y</code> vám umožní zadat heslo pro kontrolu dvakrát a
<code>luksFormat</code> označuje LUKS operaci, tedy inicializaci daného
svazku.</p>

<p>V případě, že máte k dispozici starší systém, který nezná XTS, použijte mód
<code>cbc-essiv</code>:</p>

<pre>cryptsetup -c aes-cbc-essiv:sha256 -s 256 -y luksFormat /dev/svazek</pre>

<h3>Otevření zašifrovaného svazku</h3>

<p>Po tom, co zašifrujete nějaký svazek, budete jistě chtít svazek otevřít a
přistupovat k němu jako k nešifrovanému, abyste na něm mohli vytvořit souborový
systém, ten připojit a nahrát na něj nějaká data. Za tímto účelem použijete
LUKS operaci <code>open</code>:</p>

<pre>cryptsetup luksOpen /dev/svazek odsifrovano</pre>

<p>Prvním parametrem je samotné zařízení, druhým pak název, pod kterým bude k
dispozici dešifrované zařízení umístěné v <code>/dev/mapper</code>. Po této
operaci byste tedy měli mít (za předpokladu zadání správného hesla) k dispozici
dešifrované zařízení <code>/dev/mapper/odsifrovano</code>, na kterém pak pomocí
<code>mkfs</code> vytvoříte souborový systém a zařízení připojíte.</p>

<h3>Zrušení mapování</h3>

<p>Jakmile skončíte práci s namapovaným dešifrovaným svazkem, bývá dobré příslušné
mapování zrušit. K tomu slouží LUKS operace <code>close</code>:</p>

<pre>cryptsetup luksClose odsifrovano</pre>

<p>Předpokladem je, že před tím odpojíte příslušný souborový systém. Povšimněte
si také, že <code>luksClose</code> operuje s názvy dešifrovaných svazků,
nikoliv s původními zařízeními.</p>

<h3>Správa klíčů</h3>

<p>Jelikož LUKS oplývá vlastností dvouúrovňového šifrování, máte možnost
nastavit více klíčů, přičemž každý pak bude schopen daný svazek dešifrovat. Ke
správě klíčů slouží operace <code>luksAddKey</code> (přidá nový klíč) a
<code>luksRemoveKey</code> (odstraní stávající klíč).</p>

<p>Po vytvoření šifrovaného svazku pomocí <code>luksFormat</code> již svazek
bude mít definováno jeho heslo. Pokud budete chtít později přidat další klíč,
zadáte:</p>

<pre>cryptsetup luksAddKey /dev/svazek</pre>

<p>LUKS vás vyzve k zadání jakéhokoliv jiného hesla (aby mohl získat hlavní
klíč), a pak vás nechá zadat heslo nové. Tím pak hlavní klíč zašifruje a
uloží do některého z volných "slotů" v úložišti pro klíče.</p>

<p>Všimněte si, že se zde používá název původního zařízení, není tedy nutné
před přidáním či odebráním klíče svazek dešifrovat pomocí
<code>luksOpen</code>.</p>

<p>Analogicky, budete-li chtít některý z existujících klíčů odebrat,
použijete:</p>

<pre>cryptsetup luksRemoveKey /dev/svazek</pre>

<p>Operace pro odebrání klíče je naštěstí dostatečně inteligentní, aby uživateli
zabránila odebrat poslední klíč nebo odebrat klíč bez znalosti nějakého dalšího
klíče.</p>

<p>Kromě hesel můžete samozřejmě používat i klíčové soubory (keyfile). V
případě operací <code>luksAddKey</code> a <code>luksRemoveKey</code> postačí
uvést klíčový soubor za názvem operace, takto:</p>

<pre>cryptsetup luksAddKey /cesta/ke/keyfile</pre>

<p>A analogicky pro odebrání klíče:</p>

<pre>cryptsetup luksRemoveKey /cesta/ke/keyfile</pre>

<p>Jelikož klíčový soubor postačí sám o sobě k dešifrování daného svazku, je
třeba věnovat zvýšenou pozornost jeho bezpečnému uložení. V ideálním případě by
se měl nacházet na jiném šifrovaném svazku.</p>

<p>Tím bych tento díl ukončil. Příště proberu zálohu LUKS hlavičky, začlenění
šifrovaných svazků do systému a šifrování celého systému.</p>

<pre id="links">http://wiki.archlinux.org/index.php/System_Encryption_with_LUKS_for_dm-crypt System Encryption with LUKS for dm-crypt (Arch Linux Wiki)
http://en.wikipedia.org/wiki/Disk_encryption_theory Wikipedia: Disk encryption theory
http://code.google.com/p/cryptsetup/ Linux unified key setup (LUKS)
http://en.wikipedia.org/wiki/Dm-crypt Dm-crypt</pre>
