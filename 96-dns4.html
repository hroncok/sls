<meta http-equiv="content-type" content="text/html;charset=utf-8" />


<h1>Správa linuxového serveru: Bind v roli autoritativního serveru</h1>

<p>Dnešní díl popisuje správu domén na vlastním DNS serveru, tedy tvorbu autoritativního DNS serveru a tvorbu zónových souborů.</p>

<p>Na úvod předpokládám, že máte nainstalovaný DNS server Bind (balíček <code>bind9</code> v Debianu). Stejně tak předpokládám, že jste si prošli <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-uvod-do-dns" title="Úvod do DNS">posledních</a> <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-dns-a-dhcp-server-dnsmasq" title="DNS a DHCP server dnsmasq">pár</a> <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-unbound-a-bind" title="Unbound a Bind">dílů</a>, které se věnují problematice DNS serverů.</p>
<p>Jak bylo řečeno minule, Bind umí zastat jak roli resolvujícího DNS serveru, který za klienty vyřizuje libovolné DNS žádosti, tak roli autoritativního serveru, který vrací autoritativní údaje o částech DNS stromu, jež jsou mu delegovány.</p>
<p>Pokud si zaregistrujete doménu, můžete registrátorovi sdělit, jaké jsou vaše autoritativní servery, a mít DNS informace spojené s příslušnou doménou (nebo se všemi vašimi doménami) na vlastních DNS serverech. Servery jsou potřeba alespoň dva, jeden primární a jeden sekundární. Primární poskytuje vždy aktuální autoritativní informace, sekundární přebírá ve specifikovaných intervalech data z primárního serveru a kešuje je. Pokud primární server vypadne, budou se klienti dotazovat sekundárního, dokud platnost jeho dat nevyprší.</p>
<p>DNS servery představují součást klíčové infrastruktury, a jako takové by měly být maximálně spolehlivé. Výpadek obou DNS serverů povede k nemožnosti klientů převádět vaše domény na IP adresy. I když budou v takové situaci vaše servery běžet, klienti se na ně nedostanou. Pokud budete provozovat vlastní DNS servery, měli byste je provozovat na spolehlivých strojích u spolehlivých poskytovatelů. Ideálně by to měly být servery ve dvou různých datacentrech (jinak hrozí, že výpadek konektivity datacentra zruší oba vaše DNS servery naráz).</p>
<h3>Příklad zónového souboru</h3>
<p>Vytvořte soubor někde v úložišti konfigurace pro Bind, tedy např. <code>/etc/bind/db.example.cz</code>, který poslouží k uložení záznamů o dané zóně. Příklad může vypadat třeba takto:</p>
<pre>$TTL    3h      ; default expiration time
@       IN      SOA     ns1.example.cz. spravce.example.cz. (
                          20120820 ; serial
                          4h       ; slave refresh
                          2h       ; slave retry interval
                          2w       ; slave data expiration
                          1h )     ; maximum caching time when lookups fail
;
@       IN      NS      ns1.example.cz.
@       IN      NS      ns2.example.cz.


example.cz.    IN      MX      10      mujmailserver1.cz.
example.cz.    IN      MX      20      mujmailserver2.cz.
example.cz.    IN      A       1.2.3.5
ns1                     IN      A       1.2.3.4
ns2                     IN      A       1.2.3.3
www                     IN      CNAME   example.cz.
subdomena1              IN      A       1.2.3.4
subdomena2              IN      CNAME   example.cz.</pre>
<p>Jak je patrno, není to úplně procházka růžovým sadem, ale není to zase příliš složité. Vezměme to jedno po druhém:</p>
<ul>
<li>
<p><code><strong>$TTL 3h</strong></code> – nastaví dobu existence (time-to-live, TTL) všech záznamů, které nemají definovanou TTL někde jinde v zónovém souboru</p>
</li>
<li>
<p><code><strong>IN SOA</strong></code> – definuje SOA záznam (Start of Authority), který obsahuje základní informace o doméně (viz dále) – tento záznam musí zónový soubor bezpodmínečně obsahovat</p>
</li>
<li>
<p><code><strong>ns1.example.cz. spravce.example.cz.</strong></code> – první údaj ve specifikaci SOA záznamu náleží DNS serveru obsahujícímu autoritativní informace o dané zóně, druhý pak e-mailu správce zóny (všimněte si tečky místo zavináče)</p>
</li>
<li>
<p><code><strong>20120820</strong></code> – první číslo u SOA záznamu udává sériové číslo zónového souboru – <strong>při jakékoliv změně zónového souboru musí být povýšeno</strong>; často se bere (jak je naznačeno v tomto případě) numerická reprezentace aktuálního data, ale můžete používat jakékoliv číslo – jen jej nezapomeňte při úpravách povyšovat</p>
</li>
<li>
<p><code><strong>4h</strong></code> – druhý údaj u SOA záznamu udává dobu, za kterou si sekundární (slave) server stáhne data z primárního (master) serveru – v tomto případě to jsou 4 hodiny (tzn. sekundární server si stáhne data každé čtyři hodiny)</p>
</li>
<li>
<p><code><strong>2h</strong></code> – třetí údaj u SOA záznamu udává dobu, za kterou se má sekundární server znovu pokusit stáhnout data z primárního, pokud mu nevyšel první pokus (bude-li tedy primární server nedostupný, sekundární bude pokusy o získání dat opakovat po dvou hodinách</p>
</li>
<li>
<p><code><strong>2w</strong></code> – čtvrtý údaj u SOA záznamu udává dobu, za kterou data na sekundárním serveru definitivně vyprší, pokud se mu nepodaří spojit s primárním DNS serverem; v tomto případě jsou to dva týdny</p>
</li>
<li>
<p><code><strong>1h</strong></code> – pátý údaj u SOA záznamu udává dobu, jak dlouho si mají kešovací DNS servery pamatovat, že nějaký záznam neexistuje</p>
</li>
<li>
<p><code><strong>IN NS</strong></code> – záznamy udávající autoritativní DNS servery pro danou zónu, primární a sekundární (může jich být samozřejmě i více); všimněte si, že k těmto serverům jsou doplněny jejich A záznamy; NS záznamy se uvádí na dvou místech, jednak v dané zóně, a jednak v zóně vyšší úrovně (tyto záznamy obvykle definujete u registrátora domény) – pokud DNS servery patří do stejné domény, kterou spravují (jako v tomto případě), musí být bezpodmínečně v zóně vyšší úrovně definováno jak jméno, tak IP adresa (A záznam) daného DNS serveru (tato dvojice tvoří tzv. GLUE záznam), jinak vám doména nebude fungovat (vznikne kruhová závislost)</p>
</li>
<li>
<p><code><strong>IN A</strong></code> – na šestém řádku zespodu je uveden hlavní A záznam pro doménu, překládající doménu na IP adresu</p>
</li>
<li>
<p><code><strong>CNAME</strong></code> – záznam typu CNAME je alias, tzn. <em>www.example.cz</em> bude ukazovat na A záznam <em>example.cz</em></p>
</li>
<li>
<p><code><strong>MX</strong></code> – zóna obsahuje specifikaci dvou poštovních (MX, Mail eXchange) serverů, a to <em>mujmailserver1.cz</em> s prioritou 10 (vyšší) a <em>mujmailserver2.cz</em> s prioritou 20 (nižší)</p>
</li>
</ul>
<p>Všimněte si také teček za doménovými jmény. Ty označují kořenovou zónu a musí být uváděny. Aby váš DNS server začal distribuovat záznamy z tohoto zónového souboru, musíte jej zařadit do nastavení Bindu, tzn. vložit do souboru <code>/etc/bind/named.conf.local</code> následující:</p>
<pre>zone "example.cz" {
       type master;
       file "/etc/bind/db.example.cz";
};</pre>
<p>Je zde specifikován nejen soubor, ale také typ „master“, který určuje váš DNS server jako primární vzhledem k tomuto zónovému souboru.</p>
<p>Před samotným restartem Bindu je vhodné konfiguraci prověřit automatizovaným nástrojem, a vyhnout se tak situaci, kdy server znovu nenastartuje kvůli chybě v definici zóny, čímž nastane výpadek. Bind obsahuje nástroj <code>named-checkconf</code>, který stačí bez parametrů spustit:</p>
<pre>named-checkconf</pre>
<p>Dle unixové tradice, pokud tento příkaz nevrátí žádný text, znamená to, že nastavení Bindu je v pořádku, a vy jej můžete v klidu restartovat:</p>
<pre>service bind9 restart</pre>
<p>Nyní můžete server otestovat:</p>
<pre>dig example.cz @1.2.3.4

;; QUESTION SECTION:
;example.cz.                     IN      A

;; ANSWER SECTION:
example.cz.             10800   IN      A       1.2.3.4

;; AUTHORITY SECTION:
example.cz.             10800   IN      NS      ns1.example.cz.
example.cz.             10800   IN      NS      ns2.example.cz

;; ADDITIONAL SECTION:
ns1.example.cz.          10800   IN      A       1.2.3.4
ns2.example.cz.          10800   IN      A       1.2.3.3</pre>
<p>Všimněte si TTL u jednotlivých záznamů, které udává 10 800 sekund, tedy 3 hodiny, což je přesně hodnota, kterou jste specifikovali v proměnné <code>$TTL</code>.</p>
<p>Otestovat můžete i další záznamy (<code>dig -t mx</code>, <code>dig -t soa</code>) atd.</p>
<h3>Sekundární DNS servery</h3>
<p>Přenos dat zóny (tzv. zónový transfer, zone transfer) je třeba na <strong>primárním</strong> serveru autorizovat, což můžete provést specifikací příslušné IP adresy u direktivy <code>allow-transfer</code>, takto:</p>
<pre>   zone "example.cz" {
         type master;
         file "/etc/bind/db.example.cz";
         allow-transfer { @4.3.2.1; };
   };</pre>
<p>Následně je třeba na sekundárním serveru vytvořit specifikaci zóny typu <em>slave</em> se specifikací primárního (<em>master</em>) serveru, takto:</p>
<pre>   zone "example.cz" {
         type slave;
         file "/var/cache/bind/db.example.cz";
         masters { @1.2.3.4; };
   };</pre>
<p>Nezapomeňte oba servery restartovat, nejprve primární, pak sekundární, a následně otestovat, jestli vše funguje.</p>
<p>Tím bych tento díl ukončil. Příště budou probrány reverzní záznamy a také český, pouze autoritativní server KnotDNS pocházející z laboratoří CZ.NIC.</p>

<pre id="links">https://cs.wikipedia.org/wiki/Domain_Name_System Česká Wikipedie, Domain Name System
https://en.wikipedia.org/wiki/Zone_file Anglická Wikipedie, Zone file
http://linuxconfig.org/linux-dns-server-bind-configuration Linux DNS server BIND configuration
http://www.wallpaperama.com/forums/how-to-manually-create-zone-files-for-domain-names-in-linux-server-t1698.html How To Manually Create Zone Files For Domain Names In Linux Server
https://help.ubuntu.com/community/BIND9ServerHowto BIND9 Server Howto
http://www.dns-info.cz/dns/zaznam-soa.html Záznam typu SOA – DNS</pre>
