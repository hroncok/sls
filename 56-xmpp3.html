<meta http-equiv="content-type" content="text/html;charset=utf-8" />


<h1>Správa linuxového serveru: Konfigurace XMPP serveru ejabberd</h1>

<p>Minulý díl se věnoval zprovoznění serveru ejabberd a naprosto základnímu nastavení. Tento díl bude v konfiguraci ejabberdu pokračovat, zmíní propojení ejabberdu s jinou než vestavěnou databází, nastavení traffic shapingu a registrace uživatelů.</p>

<h3>Použití MySQL a PostgreSQL s ejabberdem</h3>
<p>Jak už tušíte z <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-jabber-xmpp-server-ejabberd">předchozího dílu</a> seriálu, ejabberd využívá jednoduchý databázový systém Mnesia napsaný pro jazyk Erlang (v tom je ejabberd napsán). Pokud chcete, je možné využít i jiný databázový systém, a to jak MySQL a PostgreSQL, tak i jiné databáze (v tomto článku budou popsány pouze tyto dvě).</p>
<p>Zprovoznění ovšem není úplně triviální, alespoň ne v Debianu, neboť zde chybí moduly pro propojení ejabberdu s MySQL či PostgreSQL.</p>
<h4>Krok 1: Kompilace modulů pro propojení s databází</h4>
<p>Jelikož je třeba provádět kompilaci, potřebujete mít k dispozici nástroje pro její provedení. V Debianu lze vše potřebné jednoduše nainstalovat pomocí metabalíku <code>build-essential</code>, který v závislostech přitáhne kompilátory i ostatní nezbytné nástroje. Kromě těchto nástrojů je třeba mít k dispozici hlavičkové soubory Erlangu (balík <code>erlang-dev</code>) a příslušné nástroje Erlangu (balík <code>erlang-nox</code> se svými závislostmi). A jelikož budete samotné moduly stahovat ze SVN repozitáře, potřebujete ještě navíc Subversion:</p>
<pre>aptitude install build-essential erlang-dev erlang-nox subversion</pre>
<p>Poté je třeba stáhnout, zkompilovat a umístit příslušné moduly. Postup se liší dle použité databáze. Nejprve stáhněte ejabberd moduly ze SVN. Z bezpečnostního hlediska doporučuji jak stažení, tak kompilaci provádět s právy neprivilegovaného uživatele:</p>
<pre>svn co https://svn.process-one.net/ejabberd-modules</pre>
<p>V závislosti na vámi zvolené databázi zvolte správný adresář se zdrojovými kódy:</p>
<pre>cd ejabberd-modules/mysql/trunk/
cd ejabberd-modules/pgsql/trunk/</pre>
<p>Pak spusťte skript, který potřebné moduly sestaví:</p>
<pre>./build.sh</pre>
<p>Posledním krokem je umístění modulů do správného adresáře. Pokud jste výše uvedený postup realizovali s právy uživatele, nyní je potřeba získat oprávnění roota:</p>
<pre>cp ebin/* /usr/lib/ejabberd/ebin/</pre>
<p>Instalace potřebných modulů je nyní hotová. Zřejmou nevýhodou je v tomto případě umístění souborů mimo balíčkovací systém. Ideální by bylo vytvořit <code>deb</code> balíček pro dané moduly a instalovat jej pomocí <code>dpkg</code>, ale to už je mimo záběr tohoto dílu.</p>
<h4>Krok 2: Vytvoření databáze</h4>
<p>Tvorba databáze i uživatele je závislá na typu databázového systému, následují tedy instrukce pro jednotlivé DBMS.</p>
<h5>MySQL</h5>
<p>Nejprve je třeba získat administrátorská oprávnění databáze, tedy přihlásit se jako <code>root</code>:</p>
<pre>mysql -u root -p</pre>
<p>Druhým krokem je vytvoření databáze a uživatele pomocí následujících SQL příkazů:</p>
<pre>CREATE DATABASE jmeno_databaze DEFAULT CHARACTER SET utf8 COLLATE utf8_czech_ci;
GRANT ALL PRIVILEGES ON jmeno_databaze.* TO 'uzivatel'@'localhost' IDENTIFIED BY 'heslo';</pre>
<p>Poté je třeba v databázi vytvořit příslušné schéma, tj. naplnit ji tabulkami. Toto schéma je k dispozici v adresáři <code>/usr/share/doc/ejabberd/examples</code>. Následující sada příkazů jej zkopíruje do aktuálního adresáře, dekomprimuje a poté importuje příslušné schéma (po poskytnutí správného hesla):</p>
<pre>cp /usr/share/doc/ejabberd/examples/mysql.sql.gz .
gzip -d mysql.sql.gz
mysql -u uzivatel -p jmeno_databaze &lt; mysql.sql</pre>
<h5>PostgreSQL</h5>
<p>Získání oprávnění databázového správce a spuštění konzole s jeho právy lze v případě Postgresu provést takto:</p>
<pre>su postgres -
psql</pre>
<p>Následují SQL příkazy k vytvoření uživatele a databáze:</p>
<pre>CREATE ROLE uzivatel WITH LOGIN PASSWORD 'heslo';
CREATE DATABASE "jmeno_databaze" OWNER "uzivatel" TEMPLATE template0 LC_COLLATE 'cs_CZ.UTF8' LC_CTYPE 'cs_CZ.UTF8';</pre>
<p>Posledním krokem je import databázového schématu (poslední příkaz předpokládá běžící Postgres server na localhostu):</p>
<pre>cp /usr/share/doc/ejabberd/examples/pg.sql.gz .
gzip -d pg.sql.gz
psql -W -h localhost -U uzivatel jmeno_databaze &lt; pg.sql</pre>
<h4>Krok 3: Úprava konfigurace ejabberdu</h4>
<p>Nyní je třeba adekvátně upravit <code>/etc/ejabberd/ejabberd.conf</code>. Ještě předtím, než začnete s úpravami, je vhodné tento soubor zazálohovat. Jelikož je to přímo zdroják v Erlangu, je dobré mít funkční verzi bokem pro případ, že byste někde udělali nějakou chybu.</p>
<p>V první řadě je třeba zakomentovat řádku využívající interní identifikační metodu (řádek zakomentujete tak, že na začátek řádku umístíte dva znaky procenta):</p>
<pre>%% {auth_method, internal}.</pre>
<p>Pak odkomentujte řádku určující <code>odbc</code> jako autentikační metodu:</p>
<pre>{auth_method, odbc}.</pre>
<p>V tuto chvíli, dle použité databáze, odkomentujte a nastavte řádku s přihlašovacími údaji do databáze:</p>
<pre>{odbc_server, {mysql, "127.0.0.1", "jmeno_databaze", "uzivatel", "heslo"}}.
{odbc_server, {pgsql, "127.0.0.1", "jmeno_databaze", "uzivatel", "heslo"}}.</pre>
<p>U následujících položek je třeba přidat k jejich názvu přídomek <code>_odbc</code>, tedy např. z <code>mod_roster</code> udělat <code>mod_roster_odbc</code>. Tím zajistíte zpracování dat příslušného modulu databází. Seznam modulů následuje:</p>
<ul>
<li>
<p><code>mod_last</code> (datum, kdy odpojený uživatel naposledy přistupoval k serveru)</p>
</li>
<li>
<p><code>mod_offline</code> (uložené zprávy pro nepřipojené uživatele)</p>
</li>
<li>
<p><code>mod_private</code> (uložená soukromá XML data, např. konfigurace klientů atd.)</p>
</li>
<li>
<p><code>mod_privacy</code> (pravidla soukromí uživatelů)</p>
</li>
<li>
<p><code>mod_pubsub</code> (veřejné služby)</p>
</li>
<li>
<p><code>mod_roster</code> (seznamy kontaktů)</p>
</li>
<li>
<p><code>mod_vcard</code> (profily uživatelů)</p>
</li>
</ul>
<p>Poté restartujte ejabberd a zkuste, jestli běží:</p>
<pre>ejabberdctl status</pre>
<p>Pokud ne, podívejte se do logů ve <code>/var/log/ejabberd</code>, tam by se měla objevit případná chybová hláška, od které se pak můžete odrazit. Většinu chyb způsobí asi chyby syntaxe, tudíž by mohlo pomoci porovnat zálohu (kterou jsem doporučoval vytvořit) s aktuální verzí. K tomu lze použít nástroj <code>diff</code>:</p>
<pre>diff -u /etc/ejabberd/ejabberd.cfg ejabberd_zaloha.cfg</pre>
<p>Pokud se ejabberd spustí, můžete vyzkoušet vytvořit prvního uživatele, zdali se to povede (můžete se i poté přesvědčit náhledem do databáze, zdali se vytvořil příslušný záznam uživatele v tabulce <code>users</code>, čímž ověříte, že ejabberd používá váš DBMS místo vestavěného DBMS Erlangu – Mnesia):</p>
<pre>ejabberdctl register jmeno_uzivatele domena.cz heslo</pre>
<h3>Traffic shaping</h3>
<p>V rámci síťového provozu ejabberdu je možné nastavovat omezení toku (shapery). V současné době je k dispozici jediný typ shaperu – <code>maxrate</code>, který omezuje maximální rychlost průtoku dat na určitý počet bytů za sekundu. Zvýší-li se průměrný průtok nad tuto hodnotu, přeruší se čtení ze socketu na tak dlouho, dokud se průměrná rychlost nesníží pod tuto hodnotu.</p>
<p>Ve výchozí konfiguraci jsou definovány dva shapery, <code>normal</code> a <code>fast</code>:</p>
<pre>{shaper, normal, {maxrate, 1000}}.
{shaper, fast, {maxrate, 50000}}.</pre>
<p>Jejich rychlosti (v bytech za sekundu) si můžete upravit podle libosti, popřípadě přidat další shapery. Jejich použití je pak zakotveno v sekci <code>access rules</code>:</p>
<pre>%% For all users except admins used "normal" shaper
{access, c2s_shaper, [{none, admin},
                      {normal, all}]}.

%% For all S2S connections used "fast" shaper
{access, s2s_shaper, [{fast, all}]}.</pre>
<p>Shaper <code>normal</code> je automaticky přiřazen všem uživatelům s výjimkou správců. Komunikace mezi servery (S2S) má nastavený shaper <code>fast</code>.</p>
<h3>Veřejný Jabber server: Povolení registrace uživatelů</h3>
<p>Ve výchozí konfiguraci není povolena registrace uživatelů, takže registrovat uživatele lze ručně, způsobem naznačeným o kousek výše nebo v <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-jabber-xmpp-server-ejabberd">minulém díle</a> seriálu. Chcete-li postavit veřejný Jabber server, budete patrně chtít registraci uživatelů povolit. Za tímto účelem nalezněte následující řádku s pravidlem přístupu:</p>
<pre>{access, register, [{deny, all}]}.</pre>
<p>V ní změňte <code>deny</code> na <code>allow</code>. To k samotnému povolení registrace stačí, ale je ještě několik věcí, kterým byste měli věnovat pozornost. V první řadě je to omezení frekvence registrací na jednu IP adresu, aby vám nějaký zlý robot najednou nevytvořil kvanta uživatelských účtů. Ejabberd umožňuje omezit frekvenci registrace pomocí ochranné lhůty, tj. po provedené registraci jsou další pokusy zablokovány na určitou dobu. Tuto dobu (v sekundách) můžete nastavit následujícím parametrem:</p>
<pre>{registration_timeout, 600}.</pre>
<p>Výchozí hodnota je nastavena na šest set sekund, tedy deset minut. K úplnému odstranění ochranné lhůty použijte hodnotu <code>infinity</code>.</p>
<p>Samotné nastavení <code>mod_register</code> obsahuje dvě podstatné položky. První je <code>welcome_message</code>, tedy uvítací zpráva, kterou uživatel dostane po registraci. Chcete-li ji upravit, najděte a upravte položku <code>welcome_message</code>:</p>
<pre>{welcome_message, {"Welcome!",
          "Welcome to a Jabber service powered by Debian. "
          "For information about Jabber visit "
          "http://www.jabber.org"}},</pre>
<p>A konečně za poslední, a sice možnost specifikovat účet, kterému budou chodit zprávy o registraci všech uživatelů:</p>
<pre>{registration_watchers, ["<span class="eaddress">admin@example<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />cz</span>"]},</pre>

<pre id="links">http://www.ejabberd.im/ ejabberd (stránka projektu)
http://www.process-one.net/docs/ejabberd/guide_en.html Oficiální dokumentace ejabberd
http://www.codernotes.com/2011/176/ejabberd-mysql-on-debian-6-squeeze/ Ejabberd + MySQL on Debian 6 (Squeeze)
http://www.planeterlang.org/en/planet/article/How_to_install_ejabberd_2.0.0_with_PostgreSQL_support/ How to install ejabberd 2.0.0 with PostgreSQL support</pre>
