<meta http-equiv="content-type" content="text/html;charset=utf-8" />


<h1>Správa linuxového serveru: Softwarový RAID prakticky</h1>

<p>Co je to RAID, jaké jsou jeho typy a pro který byste se měli rozhodnout, jste se již dozvěděli v minulých dílech. Nyní se na něj podíváme z praktického hlediska. Vytváření nového a modifikace stávajícího pole pro vás bude hračkou.</p>

<p class="box">O RAIDu teoreticky: <span class="mw_field">### link article=2857 text=Správa linuxového serveru: RAID teoreticky title=Správa linuxového serveru: RAID teoreticky mode=inline ###</span></p>
<h3>Průzkum existujícího pole</h3>
<p>Informace o všech diskových polích spravovaných Linuxem naleznete v souboru <code>/proc/mdstat</code>. Výpis tohoto souboru může vypadat třeba takto:</p>
<pre>debian:~# cat /proc/mdstat<br />Personalities : [raid1] <br />md2 : active raid1 sdb2[0] sda2[1]<br />      975763866 blocks super 1.2 [2/2] [UU]<br />      bitmap: 5/466 pages [20KB], 1024KB chunk<br /><br />md0 : active raid1 sdb1[0] sda1[1]<br />      995904 blocks [2/2] [UU]<br />      <br />unused devices: &amp;ls;none&gt;</pre>
<p>V tomto výpisu jsou vidět dvě pole, RAID 1 pole <code>md0</code> o přibližné velikosti 1GB složené ze zařízení <code>sdb1</code> a <code>sda1</code> a RAID 1 pole <code>md2</code> o přibližné velikosti 1TB složené ze zařízení <code>sdb2</code> a <code>sda2</code>. Obě dvě pole jsou aktivní se dvěma ze dvou zařízení (viz <code>[2/2]</code>).</p>
<p>Zkusme se podívat na jiný výpis:</p>
<pre>debian:~# cat /proc/mdstat<br />Personalities : [raid1] <br />md0 : active raid1 hda1[0] hdd1[3](F) hdb1[1]<br />      1172608 blocks [3/2] [UU_]<br />      <br />unused devices: &amp;ls;none&gt;</pre>
<p>Zde je patrný problém se zařízením <code>hdd1</code>, které bylo označeno jako poruchové. Proto je u něj písmeno <strong>F</strong> (f jako faulty). Pole je aktivní, ale pouze se dvěma ze tří zařízení (viz <code>[3/2]</code>). Povšimněte si ve výpisu posloupnosti označující stav jednotlivých zařízení seřazených podle jejich pořadí v poli - <code>[UU_]</code>. Zde značí písmeno <code>U</code> aktivní zařízení v poli a podtržítko značí chybějící aktivní zařízení.</p>
<p>V momentě, kdy chybné zařízení vyřadíme z pole a zařadíme jeho náhradu, začne rekonstrukce pole:</p>
<pre>debian:~# cat /proc/mdstat<br />Personalities : [raid1] <br />md0 : active raid1 hdd1[3] hda1[0] hdb1[1]<br />      1172608 blocks [3/2] [UU_]<br />      [=====&gt;...............]  recovery = 28.0% (328768/1172608) finish=0.7min speed=18264K/sec<br />      <br />unused devices: &amp;ls;none&gt;</pre>
<p>Detailnější výpis informací o diskovém poli můžeme získat pomocí nástroje <code>mdadm</code>:</p>
<pre>debian:~# mdadm -D /dev/md2<br />/dev/md2:<br />        Version : 01.02<br />  Creation Time : Mon Nov  9 13:53:36 2009<br />     Raid Level : raid1<br />     Array Size : 975763866 (930.56 GiB 999.18 GB)<br />  Used Dev Size : 1951527732 (1861.12 GiB 1998.36 GB)<br />   Raid Devices : 2<br />  Total Devices : 2<br />Preferred Minor : 2<br />    Persistence : Superblock is persistent<br /><br />  Intent Bitmap : Internal<br /><br />    Update Time : Sat Jan  9 16:07:04 2010<br />          State : active<br /> Active Devices : 2<br />Working Devices : 2<br /> Failed Devices : 0<br />  Spare Devices : 0<br /><br />           Name : 'debian':2<br />           UUID : 2e2fd27c:aa6c8143:b3829f5b:2e325dd8<br />         Events : 12<br /><br />    Number   Major   Minor   RaidDevice State<br />       0       8       18        0      active sync   /dev/sdb2<br />       1       8        2        1      active sync   /dev/sda2</pre>
<p>Pomocí nástroje <code>mdadm</code> můžeme zkoumat i jednotlivá zařízení v poli:</p>
<pre>debian:~# mdadm -E /dev/sda2<br />/dev/sda2:<br />          Magic : a92b4efc<br />        Version : 1.2<br />    Feature Map : 0x1<br />     Array UUID : 2e2fd27c:aa6c8143:b3829f5b:2e325dd8<br />           Name : 'debian':2<br />  Creation Time : Mon Nov  9 13:53:36 2009<br />     Raid Level : raid1<br />   Raid Devices : 2<br /><br /> Avail Dev Size : 1951527733 (930.56 GiB 999.18 GB)<br />     Array Size : 1951527732 (930.56 GiB 999.18 GB)<br />  Used Dev Size : 1951527732 (930.56 GiB 999.18 GB)<br />    Data Offset : 272 sectors<br />   Super Offset : 8 sectors<br />          State : clean<br />    Device UUID : 998eca59:96570811:c1661b8e:93707a76<br /><br />Internal Bitmap : 8 sectors from superblock<br />    Update Time : Sat Jan  9 16:09:05 2010<br />       Checksum : 3860e005 - correct<br />         Events : 12<br /><br /><br />    Array Slot : 1 (0, 1)<br />   Array State : uU</pre>
<h3>Vytvoření nového pole</h3>
<p>Veškerá správa <a href="http://raid.wiki.kernel.org/">linuxového softwarového RAIDu</a> se provádí pomocí nástroje <code>mdadm</code>. Pokud byste chtěli vytvořit RAID 5 pole se třemi zařízeními (<code>sda1</code>, <code>sdb1</code> a <code>sdc1</code>) a jednou náhradou (spare) v podobě zařízení <code>sdd1</code>, můžete použít následující příkaz:</p>
<pre>mdadm --create /dev/md0 --level=5 --raid-devices=3 /dev/sda1 /dev/sdb1 /dev/sdc1 --spare-devices=1 /dev/sdd1</pre>
<p>Může se stát, že při sestavování pole nebudete mít hned k dispozici všechny disky, v takovém případě můžete místo chybějícího disku použít klíčové slovo <code>missing</code> (chybějící):</p>
<pre>mdadm --create /dev/md0 --level=5 --raid-devices=3 /dev/sda1 missing /dev/sdc1 --spare-devices=1 /dev/sdd1</pre>
<p>Ačkoliv je možné sestavit pole v degradovaném režimu (s chybějícími redundantními aktivními zařízeními), tento postup se nedoporučuje. Zejména pak, pokud potřebujete na takové pole přesunout data ještě před tím, než doplníte zbývající zařízení.</p>
<h3>Modifikace existujícího pole</h3>
<p>Zařízení lze z pole odebírat a nová zařízení do pole vkládat. Vložení nového zařízení do pole je velmi jednoduché:</p>
<pre>mdadm --manage /dev/md0 --add /dev/sde1</pre>
<p>Každé pole má určitý definovaný počet aktivních zařízení (raid devices). Tento počet se nastavuje při vytvoření pole. Pokud je tento počet vyšší než momentální počet aktivních zařízení v poli (tj. nějaké aktivní zařízení v poli chybí, a pole je tudíž degradované), použije se nově přidané zařízení jako aktivní zařízení v poli, tedy jako náhrada za chybějící aktivní zařízení. V takové situaci dojde po zařazení daného zařízení do pole k zahájení jeho rekonstrukce.</p>
<p>Pokud je aktuální počet aktivních zařízení roven počtu aktivních zařízení v poli (žádné aktivní zařízení nechybí, pole tedy není degradované), pak se použije jako náhrada (spare). Náhradní zařízení sice v poli figurují, ale nejsou aktivní (nejsou na nich data). Teprve pokud některé z aktivních zařízení selže, pak bude náhrada automaticky zařazena do pole jako aktivní zařízení a začne jeho rekonstrukce.</p>
<p>Průběh rekonstrukce můžete sledovat třeba příkazem:</p>
<pre>watch -n 1 'cat /proc/mdstat'</pre>
<p>Odebrání zařízení z pole je trošku složitější. Záleží na tom, jestli je příslušné zařízení aktivní nebo ne. Pokud není aktivní (bylo označeno jako vadné nebo se jedná o náhradní zařízení), pak jej lze odebrat rovnou. Pokud se jedná o aktivní zařízení, je třeba jej nejdříve vyřadit z pole, což lze provést tak, že jej označíte jako vadné:</p>
<pre>mdadm --manage /dev/md0 --set-faulty /dev/sde1</pre>
<p>A následně je možné jej odebrat:</p>
<pre>mdadm --manage /dev/md0 --remove /dev/sde1</pre>
<p>Tím bych tento díl ukončil. Příště se podíváme na pokročilejší témata správy diskových polí jako řešení krizových situací, monitorování pole, atd.</p>

<pre id="links">http://raid.wiki.kernel.org/ Linux Raid Wiki</pre>
