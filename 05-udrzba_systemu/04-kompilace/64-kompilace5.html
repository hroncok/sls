<meta http-equiv="content-type" content="text/html;charset=utf-8" />


<h1>Správa linuxového serveru: Kompilace jádra a modulů prakticky</h1>

<p>Minule byla probrána kompilace jádra a modulů teoreticky, dnes se na ni budete moci podívat z praktického pohledu a zjistit, jak při kompilaci jádra nebo modulů postupovat.</p>

<p class="box">Na úvod opět připomenu, že byste si měli projít přinejmenším <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-uvod-do-kompilace-jadra-a-modulu">minulý díl</a>. Dozvíte se v něm mnoho podstatného a užitečného pro díl dnešní.</p>
<h3>Kompilace modulů</h3>
<p>Jaderný modul představuje obvykle určitou funkcionalitu. Ve většině případů se jedná o ovladač zařízení, ale stejně tak se může jednat o modul zpřístupňující určitý souborový systém, upravující či přidávající bezpečnostní model jádra, nějakou vlastnost atd. Pokud se dostanete do situace, kdy se vám nějaký modul zalíbí, ale ve vašem distribučním jádře nebude, naštěstí nebudete muset projít kompilací jádra – postačí zkompilovat jen samotný modul a ušetřit si tak práci. Předesílám však, že bude nutné tento proces opakovat při každé změně jádra (např. po aktualizaci na novou či opravenou verzi).</p>
<p>Abyste mohli zkompilovat jaderný modul, potřebujete hlavičkové soubory jádra. Pokud je nemáte, musíte je nainstalovat. V Debianu se příslušný balíček jmenuje linux-headers, ale musíte vybrat ten, který patří vašemu jádru. Můžete také použít metabalík, který zajistí automatickou instalaci hlavičkových souborů, ale i těchto metabalíků je více v závislosti na architektuře, kterou využíváte. Pro 32bitové systémy bude přicházet v úvahu:</p>
<pre>aptitude install linux-headers-2.6-686</pre>
<p>Pro 64bitové pak:</p>
<pre>aptitude install linux-headers-2.6-amd64</pre>
<p>Potřebujete také nástroje pro kompilaci, popřípadě další nástroje a komponenty, které daný modul vyžaduje (dokumentace napoví). Nástroje pro kompilaci v Debianu nainstalujete prostřednictvím metabalíku <code>build-essentail</code>:</p>
<pre>aptitude install build-essential</pre>
<p>Samotný proces kompilace modulu představuje rozbalení zdrojového balíčku a jeho kompilaci:</p>
<pre>tar xvf jaderny_modul.tar.gz
cd jaderny_modul
make</pre>
<p>V některých případech je třeba specifikovat verzi jádra, ke které chcete modul sestavit, jinde se automaticky použije aktuálně běžící jádro. Specifikace jiného jádra má pak obvykle podobu nastavení příslušné proměnné, kterou stačí nastavit pro nástroj <code>make</code>, např. takto:</p>
<pre>KVER=2.6.32-5-amd64 make</pre>
<p>Posledním krokem je instalace modulu a aktualizace závislostí mezi moduly:</p>
<pre>make install
depmod -a</pre>
<p>Modul se obvykle usadí v <code>/lib/modules/verze_jádra</code>. Zavést jej můžete pomocí <code>modprobe</code>:</p>
<pre>modprobe modul</pre>
<p>Odstranit jej z běžícího jádra můžete příkazem:</p>
<pre>modprobe -r modul</pre>
<p>Chcete-li, aby se modul zaváděl při každém spuštění počítače, přidejte jeho název na prázdný řádek do souboru <code>/etc/modules</code> (platí pro Debian).</p>
<p>Proces kompilace modulu se může lišit a mít svá specifika u každého jednotlivého modulu, tudíž určitě nejprve nahlédněte do dokumentace. Samozřejmě až potom, co se podíváte do repozitářů, jestli tam už váš modul není k dispozici. V Debianu naleznete dva typy balíků příslušejících jaderným modulům, a sice balíček se zdrojovým kódem, který můžete využít ke kompilaci (takový má přídomek <code>-source</code>), nebo <code>-dkms</code> balíček, který se o kompilaci pro aktuální jádro postará sám, a postará se i v případě aktualizace jádra (předpokladem je dostupnost hlavičkových souborů nového jádra).</p>
<p>Debian také obsahuje nástroj <em>Module assistant</em> (balíček <code>module-assistant</code>), který usnadňuje kompilaci a instalaci řady modulů.</p>
<h3>Kompilace jádra</h3>
<p>Jestli nemáte všechny nástroje potřebné pro sestavení jádra, tak si je nainstalujte:</p>
<pre>aptitude install kernel-package libncurses5-dev fakeroot wget bzip2</pre>
<p>Jako první je třeba, abyste si opatřili zdrojové kódy jádra. To můžete učinit buď prostřednictvím balíčkovacího systému (balíček <code>linux-source</code>), nebo si je stáhnout přímo ze zdroje na <a href="http://www.kernel.org/">kernel.org</a>. Bohužel, tento server se v době psaní článku stále zotavuje z bezpečnostního incidentu, tudíž pokud vám tato stránka momentálně nefunguje, budete si muset zdrojové kódy jádra opatřit jinde, třeba na <a href="https://github.com/mirrors/linux-2.6">GitHubu</a>.</p>
<p>Zdrojové kódy rozbalte:</p>
<pre>tar xvf linux-2.6.32.tar.gz</pre>
<p>Následně (pro jistotu) zdroj vyčistěte:</p>
<pre>cd linux-2.6.32
make mrproper</pre>
<h4>Aplikace patchů</h4>
<p>Chcete-li aplikovat nějaký patch (pro příslušnou teorii vás odkazuji na <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-uvod-do-kompilace-jadra-a-modulu">minulý díl</a>), nyní je vhodná doba. Patch můžete po rozbalení aplikovat nejlépe podle instrukcí na webu příslušného projektu, nebo pomocí nástroje <code>patch</code>, nějak takto:</p>
<pre>patch -p1 &lt; muj_patch.patch</pre>
<p>Při zadávání tohoto příkazu byste se měli nacházet v adresáři s rozbaleným zdrojovým kódem jádra.</p>
<h4>Konfigurace jádra</h4>
<p>Dalším krokem je konfigurace jádra. Ta zahrnuje jak nastavení řady parametrů, tak určení toho, co se zakompiluje přímo do jádra a co zůstane jako modul, který lze do jádra za běhu nahrát nebo vyjmout. Tento proces je velmi komplikovaný a není vůbec těžké zapomenout na nějaký modul, bez kterého se jádro na příslušném hardwaru nerozběhne. Pokud začnete s konfigurací jádra od začátku, prozkoumejte důkladně veškerý hardware (<code>lshw</code>) a nahrané moduly (<code>lsmod</code>, <code>modinfo</code>), a volte příslušné moduly v nastavení jádra podle toho. Modul zakompilovaný do jádra bude fungovat, jakmile jádro naběhne. To, co bude k dispozici jako externí modul, musí přijít do iniciálního ramdisku, je-li to důležité pro zavedení systému.</p>
<p>Pomocnou ruku vám v této situaci poskytne aktuální konfigurace jádra, kterou můžete použít jako vzor. Konfigurace aktuálního jádra bývá k dispozici v <code>/proc/config.gz</code> (je-li tato funkčnost zakompilována do jádra). Toho pak můžete využít:</p>
<pre>cd linux-2.6.32
cp /proc/config.gz .config.gz
gzip -d .config.gz
make oldconfig</pre>
<p>V Debianu zrovna prohlížení nastavení jádra prostřednictvím <code>/proc/config.gz</code> dostupné není, je tedy třeba zvolit alternativní postup:</p>
<pre>cd linux-2.6.32
cp /boot/config-`uname -r` ./.config
make oldconfig</pre>
<p>Poslední příkaz přizpůsobí konfigurační soubor aktuálnímu jádru, což bude nejspíše zahrnovat mnoho dotazů, na které budete muset odpovědět. Poté bude konfigurace hotova a vy ji následně můžete upravit:</p>
<pre>make menuconfig</pre>
<p>Výše zmíněným příkazem spustíte textový konfigurační nástroj jádra. Těchto nástrojů je více, nemusíte tedy nutně používat <code>menuconfig</code>, můžete použít <code>xconfig</code> nebo jiné varianty (dostupné možnosti zjistíte pomocí <code>make help</code>). Pomocí těchto nástrojů vytvořte nebo upravte nastavení jádra. Až budete hotovi, uložte nastavení a opusťte nástroj.</p>
<h4>Pojmenování vámi upravené verze jádra</h4>
<p>Abyste odlišili svou verzi jádra od jádra, které máte nainstalované, v nastavení jádra <code>General setup</code> - <code>local version</code> vyplňte příponu, kterou chcete použít, např. <code>-custom</code>. Pokud tak neučiníte a jádro budete instalovat ručně bez správce balíčků, hrozí, že si přepíšete distribuční jádro!</p>
<h3>Sestavení jádra</h3>
<p>Nechcete-li využívat správce balíčků, zkompilujte jádro následujícím příkazem:</p>
<pre>make all</pre>
<p>Následně nainstalujte zkompilované externí moduly do <code>/lib/modules</code>:</p>
<pre>make modules_install</pre>
<p>Poté zkopírujte obraz jádra do <code>/boot</code>:</p>
<pre>cp arch/x86/boot/bzImage /boot/vmlinuz-verze_jadra</pre>
<p>Zde musíte řetězec <code>verze_jadra</code> nahradit za celý název verze jádra (můžete se orientovat dle názvu adresáře v <code>/lib/modules</code>, který odpovídá vámi zkompilovanému jádru).</p>
<p>Následně vygenerujte iniciální ramdisk:</p>
<pre>mkinitramfs -o /boot/initrd.img-verze_jadra verze_jadra</pre>
<p>Zde nahraďte řetězec <code>verze_jadra</code> za stejný řetězec, který jste použili v příkazu pro zkopírování obrazu jádra do <code>/boot</code>.</p>
<p>Posledním krokem je úprava zavaděče:</p>
<pre>update-grub</pre>
<p>Budete-li chtít zužitkovat zbylé zdrojové kódy (např. pro pozdější kompilaci modulů), pusťte v adresáři s nimi toto:</p>
<pre>make clean</pre>
<p>Pokud jste kompilovali jádro někde bokem a ne v adresáři, kde byste chtěli zdrojáky ponechat, pak po jejich přemístění nezapomeňte upravit symbolický odkaz <code>/lib/modules/verze_jadra/build</code> tak, aby ukazoval na jejich nové umístění.</p>
<h4>Sestavení jádra v Debianu</h4>
<p>Debian má vlastní nástroje, které vám pomohou sestavit jádro a začlenit jej do balíčkovacího systému. Místo výše uvedeného postupu tedy můžete použít následující. Po konfiguraci jádra proveďte:</p>
<pre>make-kpkg clean
fakeroot make-kpkg --initrd --append-to-version=-custom kernel_image kernel_headers</pre>
<p>V příkazu výše upravte parametr <code>--append-to-version</code> podle toho, jakou příponu pro název vámi sestaveného jádra chcete použít. Až kompilace skončí, podívejte se do <code>/usr/src</code>, kde se měly vygenerovat příslušné balíčky. Ty pak nainstalujte pomocí <code>dpkg</code>:</p>
<pre>cd /usr/src
dpkg -i linux-image-verze_jadra.deb
dpkg -i linux-headers-verze_jadra.deb</pre>
<p>Iniciální ramdisk by se měl vygenerovat automaticky, totéž by mělo platit o nastavení zavaděče. Tím by měla být instalace nového jádra hotova.</p>

<pre id="links">http://wiki.debian.org/ModuleAssistant Debian Wiki: Module assistant
http://www.howtoforge.com/kernel_compilation_debian_etch How To Compile A Kernel - Debian Etch</pre>
