<meta http-equiv="content-type" content="text/html;charset=utf-8" />


<h1>Správa linuxového serveru: Hlídání serverů pomocí nástroje Monit</h1>

<p>Stalo se vám někdy, že vám na serveru spadl nějaký důležitý démon, popřípadě že server samotný přestal reagovat, a vy jste to nezjistili včas? Nástroj Monit umí hlídat činnost serveru i nejrůznějších démonů a nejen upozornit v případě problému, ale i provést opravnou akci. Jak na to, to je předmětem tohoto článku.</p>

<h3>Úvod</h3>
<p>Monit je komplexní nástroj na sledování služeb, a to jak služeb běžících na místním serveru, tak služeb běžících na vzdáleném. Umožňuje velmi přesně definovat, co a jak se bude kontrolovat. U místních služeb může být prospěšný jak tím, že upozorní na jejich nedostupnost či blížící se problém (např. docházející paměť apod.), tak provedením opravné akce, kterou může být restart monitorované služby, ale také jakýkoliv jiný příkaz. Monitorovat lze nejen činnost konkrétních démonů, ale také řadu systémových veličin, jako je např. zatížení systému, volná paměť, využití swapu apod.</p>
<p>Stav monitorovaných systémů či služeb je možné zjišťovat nejenom kontrolou poštovní schránky, kam přichází oznámení, ale také pomocí webového či shellového rozhraní. Tyto rozhraní umí nejenom sledovat stav veškerého monitorování, ale umožňují i provádět jisté změny přímo za běhu, tedy restart sledovaných služeb nebo pozastavení či opětovné zahájení konkrétního monitorování. Na to je dobré při případných upgradech či servisních zásazích nezapomenout, protože Monit pak třeba službu, která není aktivní, automaticky nastartuje, což v takových situacích může vadit.</p>
<h3>Instalace</h3>
<p>K instalaci postačí nainstalovat stejnojmenný balíček, v Debianu stačí zapsat následující příkaz:</p>
<pre>aptitude install monit</pre>
<p>Na rozdíl od řady jiných démonů je Monit po instalaci neaktivní, tzn. před samotným použitím je třeba jej nakonfigurovat (viz níže). Až budete mít Monit nakonfigurovaný, povolte jeho použití v <code>/etc/default/monit</code>, kde proměnné <code>startup</code> přiřaďte jedničku místo nuly:</p>
<pre>startup=1</pre>
<h3>Základní konfigurace Monitu</h3>
<p>Proces konfigurace Monitu je poměrně jednoduchý. Máte na výběr ze dvou možností - buď budete přímo měnit hlavní konfigurační soubor Monitu, tedy <code>/etc/monit/monitrc</code>, nebo si jednotlivé služby i základní konfiguraci rozdělíte do libovolně pojmenovaných souborů v <code>/etc/monit/conf.d</code>.</p>
<p>Výchozí konfigurační soubor <code>/etc/monit/monitrc</code> neobsahuje prakticky žádnou výchozí konfiguraci, ale je dobře zdokumentovaný a základní nastavení jsou v něm přítomna, pouze jsou zakomentována, takže stačí příslušné volby odkomentovat a nastavit si je podle svých představ. Základ by mohl vypadat třeba takto:</p>
<pre>set daemon 120
    with start delay 240
set logfile syslog facility log_daemon
set mailserver localhost
set mail-format { from: <span class="eaddress">monit@muj-server<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />tld</span> }
set alert root@localhost</pre>
<p>První dva řádky nastavují režim démona a dva podstatné časové údaje. Prvním z nich je doba cyklu, tedy doba mezi jednotlivými kontrolami, zde nastavena na sto dvacet sekund. V jednotlivých pravidlech (viz dále) je možné stav služeb zjišťovat i v delším časovém rozmezí a konkrétní akci pak vázat na stav, který trvá po dobu několika cyklů.</p>
<p>Na druhém řádku je nastavena úvodní čekací doba před zahájením monitorování. Tato doba se měří od spuštění Monitu a v tomto případě je nastavena na dvě stě čtyřicet sekund. Druhý řádek je samozřejmě nepovinný - je to pouze doplnění k prvnímu řádku, a pokud jej nespecifikujete, služby se začnou monitorovat okamžitě po spouštění Monitu.</p>
<p>Třetí řádek nastavuje logování, čtvrtý pak poštovní servery (<code>mailserver</code>), prostřednictvím kterých budou odesílána oznámení. Mailserverů je možné specifikovat více, jako oddělovač použijte čárku. Máte-li možnost, nelze než doporučit použít víc než jeden poštovní server, Monit pak v případě nečinnosti jednoho pošle e-mail přes jiný (je nepříjemné, pokud by přestal fungovat poštovní server a vy byste se o tom nedozvěděli, protože Monit by neměl k dispozici žádný další). Pátý řádek upravuje formát zasílaných e-mailů, resp. nastavuje pole <code>From:</code> - to bývá vhodné přizpůsobit doménovému jménu vašeho serveru.</p>
<p>Poslední řádek nastavuje příjemce upozornění. Příjemců může být pochopitelně více - potřebujete-li jich více, specifikujte <code>set alert</code> vícekrát, např. takto:</p>
<pre>set alert admin1@localhost
set alert admin2@localhost</pre>
<p>Dodám ještě, že Monit umožňuje zasílat různé typy zpráv různým uživatelům, avšak zde vás už odkážu na <a href="http://mmonit.com/monit/documentation/monit.html#alert_messages">dokumentaci</a> nebo alespoň na drobný příklad v komentovaném <code>monitrc</code>.</p>
<h3>Monitorování systému</h3>
<p>Pokud chcete monitorovat základní veličiny systému, na kterém Monit běží, můžete použít následující šablonu:</p>
<pre>check system muj-server.tld
    if loadavg (1min) &gt; 4 then alert
    if loadavg (5min) &gt; 2 then alert
    if memory usage &gt; 75% then alert
    if cpu usage (user) &gt; 70% then alert
    if cpu usage (system) &gt; 30% then alert
    if cpu usage (wait) &gt; 20% then alert</pre>
<p>Název systému a hodnoty si samozřejmě upravte podle libosti. Jak je vidět, zápis pravidel pro Monit se podobá konstrukcím programovacích jazyků, je ovšem maximálně zjednodušený a dobře čitelný. Akce „alert“ zde představuje odeslání zprávy, pokud bude daná podmínka splněna.</p>
<h3>Monitorování služeb</h3>
<p>Asi nejjednodušší je poohlédnout se po šablonách pro konkrétní služby, které chcete monitorovat. Něco málo je k dispozici v <a href="http://mmonit.com/wiki/Monit/HowTo">návodech</a>, ale obrovská spousta příkladů se nachází v <a href="http://mmonit.com/wiki/Monit/ConfigurationExamples">příkladech</a> na webu projektu. Využijete-li některé z těchto šablon, nezapomeňte si je upravit, tedy přinejmenším se ujistit, že umístění všech souborů odpovídá vašemu systému. Zde se jedná zejména o init skripty, které jsou v Debianu a mnoha distribucích umístěny v <code>/etc/init.d</code>, ale třeba Arch Linux je má v <code>/etc/rc.d</code>. Dále se jedná o umístění případných socketů či souborů s PID příslušných démonů, kde se umístění mezi distribucemi může také lišit.</p>
<p>Příklad monitorované služby by mohl vypadat třeba takto:</p>
<pre>check process denyhosts with pidfile /var/run/denyhosts.pid
      start program = "/etc/init.d/denyhosts start"
      stop program = "/etc/init.d/denyhosts stop"
      if cpu &gt; 60% for 2 cycles then alert
      if cpu &gt; 80% for 5 cycles then restart
      if totalmem &gt; 15.0 MB for 5 cycles then restart</pre>
<p>V tomto příkladu je monitorován proces <code>Denyhosts</code> (nástroj byl v tomto seriálu již <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-prakticke-rady-pro-zabezpeceni-ssh-1">představen</a>) za pomoci souboru s PID (<code>with pidfile ...</code>). Je-li specifikován PID soubor, Monit hlídá, jestli existuje proces s příslušným číslem, které je v něm uloženo. Na druhém a třetím řádku jsou specifikovány příkazy pro pro spuštění a zastavení démona, které jsou využívány pro řízení běhu služeb. Monit může příslušné služby restartovat, nastartovat nebo i zastavit za vámi specifikovaných okolností. Na čtvrtém a pátém řádku jsou podmínky vztahující se k zatížení procesoru samotným Denyhosts. Ano, Monit může sledovat využití systémových prostředků (CPU, paměti atd.) u konkrétních procesů, a na to mohou být navázány podmínky.</p>
<p>Pokud by Denyhosts během dvou cyklů (tedy dvou kontrol) zjistil, že Denyhosts využívá více než šedesát procent CPU, zaslal by e-mailem upozornění. Pokud by Denyhosts využíval více než osmdesát procent CPU během pěti cyklů, byl by poté proveden restart služby. Poslední řádek je pojistka proti případným memory leakům, tzn. v případě obsazení více než 15 MB operační paměti po dobu pěti cyklů bude proveden restart.</p>
<p>Tím bych tento díl ukončil. Příště budou následovat další příklady, budou naznačeny možnosti seskupování procesů a konfigurace a práce s webovým a konzolovým rozhraním Monitu.</p>

<pre id="links">http://mmonit.com/monit/documentation/monit.html Oficiální dokumentace
http://mmonit.com/wiki/Monit/ConfigurationExamples Příklady konfigurace
http://www.howtoforge.com/server-monitoring-with-munin-and-monit-on-debian-lenny Server Monitoring With munin And monit On Debian Lenny</pre>
