<meta http-equiv="content-type" content="text/html;charset=utf-8" />


<h1>Správa linuxového serveru: Víceuživatelský Git server s Gitolite</h1>

<p>Minulý díl představil nástroj Gitosis, který umí zprostředkovat víceuživatelský přístup k centralizovanému Git repozitáři. Gitolite pracuje podobně jako Gitosis, avšak umožňuje ještě jemnější pravidla přístupu. Více se dozvíte v článku.</p>

<h3>Úvod</h3>
<p>Na úvod vás musím upozornit na poslední tři díly tohoto seriálu, které se věnovaly SCM nástroji Git, základům jeho používání a jeho nasazení na vlastní server, počínaje těmi nejjednoduššími způsoby (OpenSSH) až po víceuživatelské řešení s Gitosis v minulém díle. Projděte si <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-git-na-vlastnim-serveru">první</a>, <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-pokrocilejsi-nasazeni-gitu">druhý</a> a <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-viceuzivatelsky-git-server-s">třetí</a> díl, abyste byli v obraze.</p>
<p>Gitolite představuje z řešení zde probíraných nejsofistikovanější nástroj pro víceuživatelský přístup k centralizovanému Git repozitáři. Oproti Gitosis umí omezit právo zápisu na konkrétní větve (branches), respektive reference (refs). Můžete kontrolovat i to, zda má uživatel právo provést „rewind“, tedy „odčinění“ commitů nebo jiné změny historie.</p>
<p>Je třeba si dát pozor na jednu věc. Gitolite neumí omezit read-only přístup na úroveň jednotlivých větví. Konkrétnímu uživateli tedy můžete zakázat read-only přístup k celému repozitáři, ale nikoliv ke konkrétním větvím. Je to dáno tím, že Git neumí rozlišit mezi jednotlivými větvemi, pokud provádí čtení. Tento problém spolu s alternativami řešení je podrobně <a href="http://sitaramc.github.com/gitolite/rpr_.html">popsán v dokumentaci</a>.</p>
<h3>Instalace</h3>
<p>Instalace Gitolite v Debianu je jako už tradičně velmi jednoduchá, neboť stačí nainstalovat příslušný balíček z oficiálních repozitářů:</p>
<pre>aptitude install gitolite</pre>
<p>Pokud při instalaci nedojde k vytvoření správcovského repozitáře, což se alespoň v mém případě nestalo, je třeba jej inicializovat ručně. Naštěstí je k tomu připraven nástroj <code>gl-setup</code>. Ten musíte spustit s právy uživatele <code>gitolite</code>, pod kterým bude Gitolite pracovat. Tento nástroj vyžaduje jeden parametr, a tím je cesta k souboru s veřejným SSH klíčem, který bude využíván pro přístup ke správcovskému repozitáři.</p>
<p>Tady pozor – jelikož tento nástroj musí běžet s právy uživatele <code>gitolite</code>, je třeba, aby k umístění souboru s klíčem měl tento uživatel přístup, čehož lze docílit např. zkopírováním souboru s veřejným SSH klíčem do <code>/tmp</code>. Následně stačí provést:</p>
<pre>su gitolite -c 'gl-setup /tmp/uzivatel.pub'</pre>
<p>Uživatelé Gitosis mají uživatelská jména shodná se jménem souboru s veřejným SSH klíčem. Proto je vhodné při provádění příkazu výše jméno souboru přizpůsobit, abyste pak neskončili s uživatelem "<code>id_rsa</code>". Vše jde však samozřejmě později upravit.</p>
<h3>Základní konfigurace</h3>
<p>V tuto chvíli byste měli být schopní naklonovat konfigurační repozitář:</p>
<pre>git clone <span class="eaddress">gitolite@server<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />example<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />org</span>:gitolite-admin</pre>
<p>Repozitář by měl obsahovat dva adresáře: adresář <code>conf</code> s konfiguračním souborem (<code>gitolite.conf</code>) a adresář <code>keydir</code> obsahující soubory s SSH klíči. Přidání nového uživatele tedy vyžaduje přidání jeho SSH klíče do adresáře <code>keydir</code> v podobě souboru se jménem ve tvaru <code>uzivatel.pub</code> a následné přidání příslušných práv v <code>conf/gitolite.conf</code>.</p>
<h3>Uživatelé a skupiny</h3>
<p>Skupiny se od uživatelů liší v tom, že jsou uvozeny zavináčem. Výchozí skupinou je skupina <code>@all</code>, zahrnující všechny uživatele. Ostatní skupiny můžete snadno nadefinovat:</p>
<pre>@vyvojari = michal ludek jana
@spravci = root admin
@personal = @vyvojari @spravci</pre>
<p>Skupina se samozřejmě může skládat z více skupin (viz definice skupiny <code>@personal</code>) a uživatelé mohou patřit do různých skupin. V systému oprávnění je možné konkrétní právo přiřadit uživateli, skupině, nebo obojímu.</p>
<h3>Systém oprávnění</h3>
<p>Základní práva, která můžete přiřadit jednotlivým uživatelům a skupinám, mají následující podobu:</p>
<table>
<tbody>
<tr><th>
<p>Oprávnění</p>
</th><th>
<p>Význam</p>
</th></tr>
<tr>
<td>
<p><code>R</code></p>
</td>
<td>
<p>read-only přístup</p>
</td>
</tr>
<tr>
<td>
<p><code>RW</code></p>
</td>
<td>
<p>právo provést <code>push</code> do existující větve a vytvořit novou větev</p>
</td>
</tr>
<tr>
<td>
<p><code>RW+</code></p>
</td>
<td>
<p>totéž co <code>RW</code>, avšak navíc právo přepisovat, resp. ničit (<code>push -f</code>)</p>
</td>
</tr>
<tr>
<td>
<p><code>-</code></p>
</td>
<td>
<p>odepřít přístup</p>
</td>
</tr>
</tbody>
</table>
<p>Příklad definice nového repozitáře tedy může vypadat takto:</p>
<pre>repo  projekt
    RW+  =   michal @spravci
    RW   =   ludek jana
    R    =   pepa</pre>
<p>Podstatnou změnou oproti Gitosisu není však pouze zjemnění práv, ale také možnost příslušná práva aplikovat na konkrétní větve, resp. na konkrétní reference (refs). Názorněji to bude vypadat na příkladu:</p>
<pre>repo  projekt
    RW  master$             =  michal @spravci
    RW  refs/heads/master$  =  michal @spravci</pre>
<p>Mezi oprávněním a rovnítkem může být regulární výraz, který definuje konkrétní referenci, k níž má dotyčný daný přístup. Neuvedete-li na začátku výrazu <code>refs/</code>, doplní si Gitolite interně na začátek <code>refs/heads/</code> – oba zápisy oprávnění v příkladu výše jsou tedy ekvivalentní. Znalci regulárních výrazů určitě tuší, že dolar na konci značí konec řádku, tj. výše uvedený zápis povolí uživateli <code>michal</code> zápis do větve <code>master</code>, ale už ne do větve nazvané např. <code>mastermind</code>. Pokud by tam dolar na konci nebyl, měl by právo zápisu i k větvi <code>mastermind</code>. Pokud vám regulární výrazy nic neříkají, bylo by dobré se na ně podívat. Pod článkem naleznete několik odkazů, které by vám měly tuto problematiku osvětlit.</p>
<p>Pokud mezi oprávněním a rovnítkem nic neuvedete, bude se příslušné oprávnění vztahovat na celý repozitář se všemi větvemi.</p>
<p>Podobně lze zacházet i s tagy – je možné uživatelům povolit nebo nepovolit přiřazovat tagy jako takové nebo tagy v určitém tvaru.</p>
<pre>repo projekt
    RW  refs/tags/rc[0-9] = michal
    -   refs/tags/rc[0-9] = ludek
    RW  refs/tags         = ludek</pre>
<p>Zde je uživateli <code>michal</code> uděleno právo vytvářet tagy ve tvaru <code>rc[číslo]</code>, je tedy možné vytvořit tag <code>rc1</code>, <code>rc10</code>, ale také <code>rc1a</code>. Uživatel <code>ludek</code> má oprávnění vytvářet libovolně pojmenované tagy, ovšem s výjimkou tagů začínajících na <code>rc[číslo]</code>. Budete-li zacházet s oprávněním pro odepření přístupu (mínusem), mějte na paměti, že záleží na pořadí prováděných pravidel. Kdybyste příklad výše otočili a dali prostřední řádek na konec, uživatel <code>ludek</code> by mohl vytvářet jakékoliv tagy a přístup by mu nikdy odepřen nebyl.</p>
<p>Tolik k základům konfigurace Gitolite. Mnohé pokročilé vlastnosti Gitolite zde nezazněly, a (nejen) proto vám doporučuji podívat se na oficiální <a href="http://sitaramc.github.com/gitolite/master-toc.html">dokumentaci ke Gitolite</a>, která je velmi podrobná a přívětivá, čtivě psaná a plná užitečných příkladů. Uživatelům Gitolite důrazně doporučuji si ji projít.</p>
<h3>Workflow</h3>
<p>Styl práce s Gitolite je velice podobný práci s Gitosis. Jakmile vytvoříte vhodnou půdu pro nový repozitář úpravou konfiguračních souborů, jejich commitem a nahráním (push) na server, stačí u místního repozitáře přidat vzdálený server:</p>
<pre>git remote add origin <span class="eaddress">gitolite@server<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />example<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />org</span>:repositar.git</pre>
<p>A následně provést push na server:</p>
<pre>git push origin master:refs/heads/master</pre>
<p>Tím by mělo dojít k vytvoření „master“ větve v repozitáři na serveru.</p>
<p>Na závěr zmíním ještě jeden tip – pokud se na server přihlásíte přes SSH, oznámí vám Gitolite, k čemu máte jaký přístup (Gitosis toto neumí):</p>
<pre>ssh <span class="eaddress">gitolite@server<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />example<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />org</span>

hello admin, the gitolite version here is 1.5.4-2+squeeze1 (Debian)
the gitolite config gives you the following access:
     R  W       gitolite-admin
     R  W       projekt
    @R @W       testing</pre>
<p>Tím bych tento díl ukončil.</p>

<pre id="links">http://blogs.gentoo.org/tampakrap/gitolite-installation-with-gitweb-and-anongit-in-gentoo-and-debian/ Gitolite installation with gitweb and anongit in Gentoo and Debian
http://progit.org/book/ch4-8.html Pro Git: Gitolite
http://sitaramc.github.com/gitolite/master-toc.html Hlavní rozcestník dokumentace projektu Gitolite
http://sitaramc.github.com/gitolite/conf_examples.html Příklady konfigurace Gitolite
http://git-scm.com/ Web projektu s odkazy na dokumentaci a videa o Gitu
http://knihy.nic.cz/ Scott Chacon, CZ.NIC: Pro Git (kniha o Gitu přeložená do češtiny)
http://book.git-scm.com/ The Git Community Book
http://www.regularnivyrazy.info/regularni-vyrazy-zaklady.html Miroslav Pecka, Základy regulárních výrazů
http://www.regularnivyrazy.info/shrnuti-syntaxe.html Miroslav Pecka, Shrnutí syntaxe regulárních výrazů</pre>
