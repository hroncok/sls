<meta http-equiv="content-type" content="text/html;charset=utf-8" />


<h1>Správa linuxového serveru: Restrictions Postfixu, blacklisty a whitelisty</h1>

<p>Dnešní díl pokračuje v tématu boje se spamem, tentokrát pomocí omezení (restrictions) Postfixu a blacklistů/whitelistů.</p>

<p>Stejně jako veškeré ostatní antispamové metody (a metody řízení přístupu), které tu byly a budou představeny, představují i „restrictions“ v Postfixu dvousečnou zbraň. Na jednu stranu pomáhají v odmítání nechtěné a nevyžádané pošty, ale stejně tak mohou zabránit v přijetí regulérního mailu – stačí ne zcela vhodně nastavený server. Vždy je třeba zvážit přínos versus náklady, kde přínosem je vliv na příjem a propouštění spamu a náklady představují podíl regulérních mailů, které jsou odmítnuty.</p>
<h3>Restrictions</h3>
<p>Jak název napovídá, restrictions jsou omezení různého typu a v různé fázi průběhu odesílání nebo příjmu pošty dle SMTP protokolu. Znalost tohoto protokolu, alespoň rámcově, je pro pochopení vítaná až nutná. Pokud SMTP protokol neznáte, přečtěte si <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-uvod-do-postovniho-serveru">první díl</a> seriálu o poštovním serveru nebo samotné <a href="https://tools.ietf.org/html/rfc5321">RFC 5321</a>. Restrictions umožňují omezit množství propuštěného spamu využitím mezer v softwaru spammerů, resp. faktu, že tento software často nerespektuje příslušná RFC nebo jejich doporučení. Problémem je, jak je již naznačeno výše, že tato omezení mohou odmítnout i regulérní e-mail přicházející z ne zcela vhodně nakonfigurovaného poštovního serveru.</p>
<p>Následují proměnné definující jednotlivá omezení:</p>
<ul>
<li>
<p><code>smtpd_client_restrictions</code> – omezení SMTP klienta</p>
</li>
<li>
<p><code>smtpd_helo_restrictions</code> – omezení vztažené k <code>HELO/HELO</code> příkazu</p>
</li>
<li>
<p><code>smtpd_sender_restrictions</code> – omezení dle původce e-mailu (příkaz <code>MAIL FROM:</code> v rámci SMTP relace)</p>
</li>
<li>
<p><code>smtpd_recipient_restrictions</code> – jediná povinná položka, omezení vztažená k <code>RCPT TO:</code></p>
</li>
<li>
<p><code>smtpd_data_restrictions</code> – omezení vztažená k příkazu <code>DATA</code></p>
</li>
<li>
<p><code>smtpd_end_of_data_restrictions</code> – omezení vztažená k příkazu ukončujícímu přenos dat</p>
</li>
<li>
<p><code>smtpd_etrn_restrictions</code> – omezení příkazu <code><a href="https://tools.ietf.org/html/rfc1985">ETRN</a></code></p>
</li>
</ul>
<p>Tyto proměnné obsahují seznam pravidel (oddělených čárkou). Některá pravidla jsou společná (např. <code>check_policy_service</code>, <code>reject</code> či <code>permit</code>), jiná jsou specifická pro daný typ omezení. Podrobný popis jednotlivých omezení a všech možných hodnot naleznete v dokumentaci Postfixu, tj. buď <a href="http://www.postfix.org/postconf.5.html">v online podobě</a>, nebo pomocí příkazu:</p>
<pre>man 5 postconf</pre>
<p>Připomínám, že tato omezení se definují v <code>/etc/postfix/main.cf</code>. Aktuálně nastavená omezení si můžete nechat vypsat příkazem:</p>
<pre>postconf | grep restrictions</pre>
<p>Aby to nebylo tak jednoduché, existují ještě další proměnné vztažené k daným omezením. Kupříkladu, <code>smtpd_helo_required</code> řídí, zda je příkaz HELO (či EHLO) vyžadován, nebo jej klient nemusí posílat. Pravidla umístěná v proměnné <code>smtpd_helo_restrictions</code> pak definují, jakým podmínkám musí příkaz HELO vyhovět (byl-li v průběhu SMTP relace zadán). Těchto proměnných je celá řada (viz dokumentace).</p>
<p>Ještě než se dostanu k samotným příkladům, zmíním jednu důležitou související proměnnou, a sice <code>smtpd_delay_reject</code>, kterou doporučuji nastavit na „yes“:</p>
<pre>smtpd_delay_reject = yes</pre>
<p>Tato volba zajistí, že v případě nevyhovění některému z pravidel nedojde k okamžitému odmítnutí, ale vyčká se s odmítnutím až na fázi po zadání <code>RCPT TO:</code>. To má jednak výhodu v kompatibilitě s některými špatně napsanými klienty, ale mnohem podstatnější je skutečnost, že díky tomu bude moci server v případě odmítnutí zaznamenat odesílatele i příjemce zprávy (což se pak dozvíte z logu).</p>
<h4>smtpd_helo_restrictions</h4>
<p>Příklad pro <code>smtpd_helo_restrictions</code>, omezení vztažená k příkazu <code>HELO</code>/<code>EHLO</code> následuje:</p>
<pre>smtpd_helo_required = yes
smtpd_helo_restrictions =
    permit_mynetworks,
    reject_invalid_helo_hostname,
    reject_non_fqdn_helo_hostname,
    permit</pre>
<p>Seznam pravidel se prochází směrem od prvního k poslednímu, jak je obvyklé. První pravidlo, <code>permit_mynetworks</code>, propustí klienta z rozsahu definovaného v proměnné <code>mynetworks</code>, aniž by musel vyhovět kterémukoliv dalšímu pravidlu.</p>
<p>Pravidlo <code>reject_invalid_helo_hostname</code> odmítne klienta, pokud je jím použitá syntaxe hostname příkazu HELO/EHLO neplatná. Pravidlo <code>reject_non_fqdn_helo_hostname</code> pak dále požaduje, aby klient uvedl jako hostname plně kvalifikované doménové jméno, jak požaduje RFC.</p>
<p>Nezachytí-li se klient u některého z předchozích pravidel, dostane se na konec seznamu, kde je pravidlo <code>permit</code>, které ho pustí dál.</p>
<p>Rozhodnete-li se nasadit tato omezení, bývá dobré také požadovat, aby klient příkaz HELO/EHLO uváděl (to je realizováno na prvním řádku příkladu, pomocí proměnné <code>smtpd_helo_required</code>).</p>
<h4>smtpd_sender_restrictions</h4>
<p>Tato omezení se vztahují k příkazu <code>MAIL FROM:</code> v rámci SMTP relace. Pozor – pole <code>From:</code> může následovat i v hlavičce mailu, kde už jeho obsah nehraje (v rámci tohoto omezení) roli.</p>
<pre>smtpd_sender_restrictions =
    permit_mynetworks,
    reject_non_fqdn_sender,
    reject_unknown_sender_domain,
    permit</pre>
<p>Struktura je podobná jako v příkladě výše. Pravidlo <code>reject_non_fqdn_sender</code> odmítne odesílatele, který nemá plně kvalifikované doménové jméno, jak je požadováno v RFC. Pravidlo <code>reject_unknown_sender_domain</code> pak odmítne klienta, který v doménové části e-mailu použije doménu, která nemá definovaný A ani MX záznam nebo která má nekorektní MX záznam. V případě dočasné chyby DNS vrací chybový kód 450 (čímž instruuje klienta, aby zkusil doručit mail později).</p>
<h4>smtpd_recipient_restrictions</h4>
<p>Tato omezení se vztahují k příkazu <code>RCPT TO:</code> v rámci SMTP relace. Jako jediné ze všech omezení je povinné a jeho výchozí hodnota je tato:</p>
<pre>smtpd_recipient_restrictions = permit_mynetworks, reject_unauth_destination</pre>
<p>Klíčové je zde pravidlo <code>reject_unauth_destination</code>, které odmítá poštu pro všechny příjemce s výjimkou těch, pro které váš poštovní server představuje konečnou. Toto pravidlo tedy zajišťuje, že server neslouží jako open relay, který je hojně využíván spammery k přeposílání spamu. Vždy se ujistěte, že toto pravidlo ve své konfiguraci máte.</p>
<p>Příklad komplexnějšího nastavení by mohl vypadat takto:</p>
<pre>smtpd_recipient_restrictions =
   reject_unauth_pipelining,
   reject_non_fqdn_recipient,
   reject_unknown_recipient_domain,
   permit_mynetworks,
   reject_unauth_destination,
   check_sender_access
         hash:/etc/postfix/sender_access,
   reject_rbl_client my_blacklist.example.org,
   permit</pre>
<p>Vezměme to pěkně popořadě. Pravidlo <code>reject_unauth_pipelining</code> odmítne klienta, který používá techniku zvanou pipelining, umožňující urychlit doručování většího množství e-mailů použitím více SMTP příkazů najednou. Tato technika vyžaduje, aby si klienti nejprve ověřili, je-li podporována. Spammeři často rovnou posílají řadu příkazů bez toho, aby prováděli ověření. A právě takového klienta Postfix v tomto případě odmítne.</p>
<p>Pravidlo <code>reject_non_fqdn_recipient</code> je díky předchozím příkladům už jasné (odmítne příjemce, který nepoužívá plně kvalifikované doménové jméno), stejně jako <code>reject_unknown_recipient_domain</code> (odmítne příjemce s neexistující doménou). Pravidla <code>permit_mynetworks</code> i <code>reject_unauth_destination</code> byla popsána výše.</p>
<p>Zbývají tedy dvě, <code>check_sender_access</code> a <code>reject_rbl_client</code>. První z nich prověří místní databázi povolených nebo zakázaných odesílatelů, zatímco <code>reject_rbl_client</code> umožňuje napojení na některý z DNS blacklistů. Více viz dále.</p>
<h5>check_sender_access</h5>
<p>Toto pravidlo vyžaduje jako parametr soubor s dodatečnými pravidly (v příkladu výše <code>/etc/postfix/sender_access</code>). Tento soubor může vypadat třeba takto:</p>
<pre>hodny_odesilatel.tld   OK
spammer.tld            REJECT
zly.spammer.tld        REJECT You have been blacklisted.
<span class="eaddress">zly@spammer<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />tld</span>        REJECT
zloun@                 REJECT
spammer@               REJECT</pre>
<p>Syntaxe by z tohoto příkladu měla být vcelku jasná. Lze specifikovat jak domény, tak jména (část před zavináčem). Tímto způsobem lze realizovat místní blacklist i whitelist, propuštění e-mailu zajistí <code>OK</code>, odmítnutí pak <code>REJECT</code>, přičemž <code>REJECT</code> můžete následovat zprávou, která se pak pošle jako součást chybové hlášky. Můžete tak například těm, kteří se na váš blacklist dostali, poskytnout nějakou metodu, jak se z něj nechat vyjmout.</p>
<p>Změny v souboru vyžadují vygenerování databáze, podobně jako v případě aliasů:</p>
<pre>postmap /etc/postfix/sender_access</pre>
<p>Existuje podobné pravidlo <code>check_recipient_access</code>, které umožňuje realizovat totéž na úrovni příjemců a pro každého příjemce (nebo skupinu příjemců) umí použít jinou politiku přístupu. Příklad využití naleznete <a href="http://www.postfix.org/RESTRICTION_CLASS_README.html">zde</a>.</p>
<h5>reject_rbl_client a blacklisty</h5>
<p>Blacklisty byly představeny v tomto seriálu již <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-agenti-e-mailu-metody-ochrany">dříve</a>, zopakuji tedy jen to nejdůležitější. Blacklist je služba, která sdružuje na základě nějaké politiky IP adresy nebo IP rozsahy a umožňuje poštovním serverům prostřednictvím specifických DNS dotazů zkontrolovat, zda se IP adresa SMTP klienta v této databázi vyskytuje, či nikoliv.</p>
<p>Blacklisty na této úrovni v Postfixu je možné využít pouze k odmítání pošty, což nebývá vždy ten nejlepší nápad. Řada správců poštovních serverů raději blacklisty zařazuje až do fáze kontroly antispamem (např. spamassassin), kde je příslušným e-mailům pouze zvýšeno skóre, ale nejsou natvrdo odmítány.</p>
<p>Úmyslně v příkladu výše neuvádím žádný známý blacklist – jednak nechci dělat reklamu zadarmo, a pak, místo slepého cut-and-paste, doporučuji blacklisty vybírat ručně, a to velmi pečlivě. Je nepříjemné, pokud zvolíte nějaký, který po správcích serverů, kteří se na blacklist třeba dostali omylem nebo ne vlastní chybou, vyžaduje poplatek za vyřazení z databáze. Stejně tak pečlivě prověřte, jaké IP adresy jsou na blacklist zařazovány, zda patří počítačům odesílajícím spam, nebo pouze majitelům IP adres specifických typů poskytovatelů (např. běžným ISP) – nejeden linuxový/unixový nadšenec má domácí poštovní server, a použitím takového blacklistu byste jej natvrdo odřízli.</p>
<p>Některé blacklisty mohou mít tak nastavená pravidla, že je lze považovat v podstatě za vyděrače (zařazují na blacklist kdekoho a za vyjmutí si nechají zaplatit).</p>
<p>Stejně tak je třeba dát si pozor na pravidla použití daného blacklistu, některé lze použít třeba pouze pro nekomerční účely a pouze pro určitý objem pošty.</p>
<p>Použití blacklistů v Postfixu je snadné, postačí daný server uvést jako parametr pravidla <code>reject_rbl_client</code>:</p>
<pre>smtpd_recipient_restrictions =
     ...
     reject_rbl_client my_blacklist.example.org,
     permit</pre>
<p>Je to asi naprosto jasné, ale pro úplnost dodám, že v tomto příkladu by se DNS dotazy vázaly na server <code>my_blacklist.example.org</code>.</p>
<h3>Závěr</h3>
<p>Restrictions umožňují definovat komplexní pravidla přístupu, mnohem komplexnější, než co zde bylo probráno. Kupříkladu, řídit přístup lze i podle obsahu hlaviček e-mailu, které lze prověřovat prostřednictvím regulárních výrazů, a na jejich základě poštu odmítat nebo přijímat. A to je jen špička ledovce. Berte tedy tento článek pouze jako úvod do tématu s tím, že další možnosti řízení přístupu se dozvíte, pokud nahlédnete do dokumentace k Postfixu. Dokumentace k Postfixu je dobře strukturována, je dostatečně podrobná, jasná a v online podobě i vhodně prolinkovaná.</p>

<pre id="links"></pre>
