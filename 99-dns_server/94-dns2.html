<meta http-equiv="content-type" content="text/html;charset=utf-8" />


<h1>Správa linuxového serveru: DNS a DHCP server dnsmasq</h1>

<p>Tento díl pokračuje v problematice DNS, věnuje se rekurzivním dotazům, PTR záznamům a DNSSEC. Představuje také server dnsmasq, který poslouží jako na zdroje nenáročný a snadno konfigurovatelný kešovací DNS a DHCP server.</p>

<h3>Rekurzivní dotazy</h3>
<p>Většina z vás bude jistě tušit (zejména po přečtení <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-uvod-do-dns">předchozího dílu</a>), že pomocí DNS můžete získat ke jménu (např. <code>wikipedia.org</code>) konkrétní IP adresu (např. <code>208.80.152.201</code>). DNS ale také podporuje „obrácené“, rekurzivní dotazy, tedy takové dotazy, které vám vrátí jméno ke konkrétní IP adrese. Využívají se k tomu záznamy typu PTR a speciální doména <code>in-addr.arpa</code> pro IPv4, <code>ip6.arpa</code> pro IPv6.</p>
<p>Zkuste si to na nějakém příkladu. Můžete využít nástroj <code>dig</code>, který byl představen v minulém díle. Nejprve získejte IP adresu k nějakému jménu (tedy A záznam), třeba <code>wikipedia.org</code>:</p>
<pre>dig wikipedia.org

;; QUESTION SECTION:
;wikipedia.org.                 IN      A

;; ANSWER SECTION:
wikipedia.org.          3516    IN      A       208.80.152.201</pre>
<p>Chcete-li provést rekurzivní DNS dotaz pomocí nástroje <code>dig</code>, použijte volbu <code>-x</code>, takto:</p>
<pre>dig -x 208.80.152.201

;; QUESTION SECTION:
;201.152.80.208.in-addr.arpa.   IN      PTR

;; ANSWER SECTION:
201.152.80.208.in-addr.arpa. 3361 IN    PTR     wikipedia-lb.pmtpa.wikimedia.org.</pre>
<p>Z odpovědi na tento dotaz by mělo být jasné, jak je vlastně rekurzivní dotaz realizován. Hledá se záznam typu <code>PTR</code> ke jménu <code>201.152.80.208.in-addr.arpa</code>, přičemž toto jméno obsahuje číselnou reprezentaci IP adresy, ovšem jednotlivé oktety jsou uvedeny v opačném pořadí. Jak víte, systém DNS je tvořen stromovou strukturou, která má počátek na konci (top-level doména), a pak se dále větví do domén druhého, třetího a dalších řádů. Každá větev nebo „podvětev“ tohoto stromu pak může být delegována jinému subjektu.</p>
<p>Jak je patrné z příkladu výše, <code>PTR</code> záznamy nemusí mít stejnou hodnotu jako <code>A</code> záznamy. Dlužno dodat, že PTR záznamů pro jednu IP adresu může být více, nicméně není to obvyklé, často z obav, že nebude správně fungovat software očekávající pouze jedno jméno na rekurzivní dotaz.</p>
<p>PTR záznamy jsou důležité zejména v oblasti pošty, jelikož některé poštovní servery předpokládají a očekávají shodu A záznamu s PTR záznamem. Pokud se záznamy shodovat nebudou, pošta může být odmítnuta, klasifikována jako spam nebo se zvýší skóre nástrojů typu spamassassin.</p>
<p>PTR záznamy obvykle nastavujete u svého ISP, který vám buď deleguje danou DNS větev na váš vlastní DNS server, nebo vám nastaví PTR záznamy na svém.</p>
<h3>Dnsmasq: Jednoduchý DNS server</h3>
<p><code>Dnsmasq</code> je vynikající nástroj, pokud potřebujete rychle nasadit kešující DNS (anebo také DHCP) server pro malou síť (dle webu projektu zvládá i tisíc klientů). <code>Dnsmasq</code> není resolver, tzn. neprovádí vyhledávání neznámých domén sám, nýbrž jen předává dotazy místním DNS resolverům (viz <code>/etc/resolv.conf</code>). Vyřešené dotazy kešuje, což snižuje zátěž hlavních DNS resolverů a také mírně zvyšuje výkon. Můžete samozřejmě přidávat vlastní DNS záznamy pro místní nebo speciální domény.</p>
<p><code>Dnsmasq</code> umí fungovat také jako jednoduchý DHCP server, IP adresy můžete přidělovat staticky nebo dynamicky. Jeho předností je nenáročnost na paměť a na konfiguraci.</p>
<p>Instalaci nástroje <code>dnsmasq </code>provedete v Debianu klasickým způsobem, instalací příslušného balíčku z oficiálních repozitářů:</p>
<pre>aptitude install dnsmasq</pre>
<h4>Konfigurace</h4>
<p>Hlavním konfiguračním souborem je <code>/etc/dnsmasq.conf</code>. Tento konfigurační soubor je bohatě komentovaný, takže není problém <code>dnsmasq</code> rychle nastavit podle vašich představ. První věc, kterou byste měli upravit, je specifikace rozhraní, kde má <code>dnsmasq</code> naslouchat. Z bezpečnostních důvodů se nehodí, aby byl dostupný z internetu (ve výchozím stavu naslouchá na všech rozhraních):</p>
<pre>interface=eth1</pre>
<p>Rozhraní můžete specifikovat více:</p>
<pre>interface=eth2
interface=eth3</pre>
<h4>DNS</h4>
<p>Kešování DNS a forwarding fungují automaticky, k tomu není třeba nic nastavovat. Můžete se sami přesvědčit tím, že se zeptáte na nějakou doménu :</p>
<pre>dig www.wikipedia.org @127.0.0.1</pre>
<p><code>Dnsmasq</code> využívá vaše resolvery (viz <code>/etc/resolv.conf</code>) a odpovědi kešuje. Integruje také informace z <code>/etc/hosts</code>, což velmi usnadňuje pojmenování místních počítačů – odpadá nutnost tvořit zónový soubor. Například, pokud do <code>/etc/hosts</code> vložíte záznam:</p>
<pre>10.0.1.15 kremilek.local</pre>
<p>...můžete se po restartu programu <code>dnsmasq</code> rovnou přesvědčit, že od něj dostanete správnou odpověď (tedy, správnou dle <code>/etc/hosts</code>):</p>
<pre>dig @127.0.0.1 kremilek.local

;; ANSWER SECTION:
kremilek.local.         10800   IN      A       10.0.1.15</pre>
<p>Výchozí hodnota pro velikost keše je sto padesát záznamů, což není mnoho. Chcete-li kešovat více záznamů, specifikujte příslušnou hodnotu v direktivě <code>cache-size</code>:</p>
<pre>cache-size=500</pre>
<p>Vlastní DNS záznamy můžete vkládat nejenom do <code>/etc/hosts</code>, ale také do konfigurace samotné:</p>
<pre>host-record=laptop,laptop.local,10.0.1.60,1234::100</pre>
<p>Výše uvedená řádka vytvoří A záznam pro jména <code>laptop</code> a <code>laptop.local</code> s IP adresou <code>10.0.1.60</code> a AAAA (IPv6) záznam s IPv6 adresou <code>1234::100</code>.</p>
<p>Potřebujete-li vložit vlastní MX záznam, můžete použít <code>mx-host</code>:</p>
<pre>mx-host=example.org,postovniserver.local,10</pre>
<p>Výše uvedený řádek nastaví MX záznam pro doménu <code>example.org</code> o váze <code>10</code> s poštovním serverem <code>postovniserver.local</code>.</p>
<p>Podobným způsobem můžete vytvářet i PTR nebo SRV záznamy. Více viz manuálová stránka a komentáře v konfiguračním souboru. Po úpravě konfigurace je třeba <code>dnsmasq</code> restartovat:</p>
<pre>service dnsmasq restart</pre>
<h4>DHCP</h4>
<p>Funkci DHCP serveru má <code>dnsmasq</code> ve výchozím stavu vypnutou. Pro její zprovoznění postačí specifikovat rozsah adres pro DHCP:</p>
<pre>dhcp-range=10.0.1.50,10.0.1.150,12h</pre>
<p>Tato řádka nastaví dynamické přidělování adres v rozsahu 10.0.1.50 až 10.0.1.150, přičemž přidělená IP adresa bude „pronajatá“ dvanáct hodin. Podobně jako v případě direktivy <code>interface</code> můžete <code>dhcp-range</code> specifikovat vícekrát, pokaždé pro jiný rozsah:</p>
<pre>dhcp-range=10.0.1.50,10.0.1.150,12h
dhcp-range=10.0.5.10,10.0.5.50,12h</pre>
<p>IP adresy můžete specifikovat i staticky, pro konkrétní MAC síťové karty:</p>
<pre>dhcp-host=11:22:33:44:55:66,10.10.10.10</pre>
<p>Tato řádka přidělí MAC adrese <code>11:22:33:44:55:66</code> IP adresu <code>10.10.10.10</code>.</p>
<p>Konkrétní rozsahy můžete přidělovat i konkrétním síťovým rozhraním:</p>
<pre>dhcp-range=eth1,10.0.1.50,10.0.1.150,12h
dhcp-range=eth2,10.0.5.10,10.0.5.50,12h</pre>
<p>Potřebujete-li specifikovat některé další volby jako router apod., můžete použít <code>dhcp-option</code>:</p>
<pre>dhcp-option=option:router,10.10.10.10
dhcp-option=option:ntp-server,10.10.10.20,10.10.10.30</pre>
<p>Výše uvedená řádka sdělí DHCP klientům, že router je na adrese <code>10.10.10.10</code> a NTP servery jsou na <code>10.10.10.20</code> a <code>10.10.10.30</code>. Další příklady naleznete v konfiguračním souboru a v manuálu.</p>
<h3>DNSSEC</h3>
<p>DNS je velmi starý protokol, který nebyl navržen s ohledem na bezpečnost (což samozřejmě neplatí jen o DNS). Existuje možnost podvržení DNS záznamů, které není možné spolehlivě zabránit, což otevírá prostor pro známý man-in-the-middle útok. Podaří-li se útočníkovi podvrhnout odpověď na váš DNS dotaz, dojde k „otrávení“ vaší DNS keše podvrženým záznamem (proto se tyto útoky označují jako <a href="http://en.wikipedia.org/wiki/DNS_cache_poisoning">DNS cache poisoning</a>). Snad nemusím zdůrazňovat, jaké důsledky může mít podvržení DNS záznamů – místo komunikace se svou bankou můžete komunikovat s útočníkem, který pak může zaútočit přímo na vaše bankovní konto.</p>
<p>Obranou vůči těmto útokům je DNSSEC, což je systém, který DNS záznamy digitálně podepisuje (používá se asymetrické šifrování), a DNS resolvery podpisy kontrolují. Digitální podpisy mají svou hierarchii (tzv. <a href="http://en.wikipedia.org/wiki/Chain_of_trust">chain of trust</a> model), která začíná u kořenové zóny (počáteční bod hierarchie se označuje jako „trust anchor“, kotva důvěry – její podpis byste měli pečlivě ověřit, jelikož s jeho důvěryhodností stojí a padá důvěryhodnost celého ověřování). Tento systém je poměrně komplexní a komplikovaný – více o principech fungování DNSSEC se dozvíte v odkazech pod článkem.</p>
<p>DNSSEC je třeba implementovat na straně resolvujících DNS serverů, které využíváte. Nepodporuje-li tedy váš ISP DNSSEC, můžete si postavit vlastní resolver se zprovozněným DNSSECem. Zda váš ISP používá DNSSEC (resp. zda vámi použité resolvující DNS servery používají DNSSEC), zjistíte dotazem na špatně podepsanou doménu, kterou je např. <code>rhybar.cz</code>:</p>
<pre>dig www.rhybar.cz

;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, <strong>status: NOERROR</strong>, id: 56068

;; QUESTION SECTION:
;www.rhybar.cz.                 IN      A

;; ANSWER SECTION:
www.rhybar.cz.          504     IN      A       217.31.205.51</pre>
<p>Pokud vám na tento dotaz vrátí server bezchybnou odpověď (<code>status: NOERROR</code>), pak DNSSEC implementovaný nemá a vy jste zranitelní. Dostane-li se vám odpovědi se statusem <code>SERVFAIL</code>:</p>
<pre>dig www.rhybar.cz

;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, <strong>status: SERVFAIL</strong>, id: 18561
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.rhybar.cz.                 IN      A</pre>
<p>...pak je všechno v pořádku a DNSSEC je aktivní. Jednoduchý test přímo z webového prohlížeče můžete realizovat třeba na stránce <a href="http://www.dnssec.cz/">www.dnssec.cz</a>. Jak si postavit vlastní resolvující a DNSSEC validující server, se dozvíte v příštím díle.</p>

<pre id="links">http://www.thekelleys.org.uk/dnsmasq/doc.html dnsmasq: web projektu
http://wiki.debian.org/HowTo/dnsmasq dnsmasq: Debian HOWTO
http://en.wikipedia.org/wiki/Reverse_DNS_lookup Anglická Wikipedie: Rekurzivní dotazy
http://www.dnssec.cz/ Český web o DNSSEC
http://www.root.cz/clanky/jak-funguje-dnssec/ Root.cz: Jak funguje DNSSEC?
http://en.wikipedia.org/wiki/DNSSEC Anglická Wikipedie: DNSSEC
http://cs.wikipedia.org/wiki/Domain_Name_System Česká Wikipedie: DNS
http://en.wikipedia.org/wiki/Domain_Name_System Anglická Wikipedie: DNS
http://www.madboa.com/geek/dig/ DiG HOWTO
http://podpora.nic.cz/page/549/dns-howto/ DNS HOWTO (česky)</pre>
