<meta http-equiv="content-type" content="text/html;charset=utf-8" />


<h1>Správa linuxového serveru: Víceuživatelský Git server s Gitosis</h1>

<p>Minulý díl byl věnován zpřístupnění Git repozitářů přes webové rozhraní pomocí webové aplikace Gitweb a také přes Git démona pro read-only přístup. V tomto dílu se dozvíte, jak zpřístupnit Git repozitáře více lidem a definovat pravidla přístupu pomocí nástroje Gitosis.</p>

<h3>Úvod</h3>
<p>Pokud jste nečetli poslední dva díly, které se věnovaly SCM nástroji Git, základům jeho používání a jeho jednoduchému nasazení na vlastní server, projděte si <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-git-na-vlastnim-serveru">první</a> díl a <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-pokrocilejsi-nasazeni-gitu">druhý</a> díl, abyste byli v obraze.</p>
<p>Představili jsme zde jednoduché techniky zprovoznění centrálního Git repozitáře. Probrali jsme v zásadě dvě možnosti – veřejný read-only přístup k repozitáři prostřednictvím Git démona a kompletní (read-write) přístup přes SSH. Obojí je velmi jednoduché na zprovoznění (je-li vůbec třeba něco zprovozňovat), avšak pro některá použití nemusí takto jednoduché techniky představovat optimální řešení, jelikož jim chybí možnost jemněji definovat pravidla přístupu a hlavně neumožňují bezpečný přístup více uživatelů k jednomu repozitáři. Gitosis je jedním z nástrojů, který umožňuje přístup k repozitářům definovat detailněji a pro více uživatelů. Lze jej integrovat s webovou aplikací Gitweb a Git démonem, i když to v Debianu nefunguje out-of-the-box (postup, jak toho docílit, bude naznačen).</p>
<p>Dodám, že Gitosis neumožňuje úplně nejjemnější dělení přístupových práv. V zásadě umožňuje víceuživatelský přístup k jednotlivým repozitářům a pro každého uživatele (nebo skupinu) umožňuje definovat oprávnění buď k read-only nebo read-write přístupu. Ačkoliv je to oproti dříve představeným metodám podstatné zlepšení, existují ještě sofistikovanější nástroje, jako např. Gitolite.</p>
<p>Gitosis používá ke svému nastavení Git. Při instalaci dojde k vytvoření správcovského repozitáře, prostřednictvím kterého je pak možné měnit nastavení a připravovat půdu pro nové repozitáře. Pro přístup je používán SSH server a veřejné klíče. Pokud vám není jasná problematika použití SSH klíčů, přečtěte si můj <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-uvod-do-ssh-pro-spravce">Úvod do SSH pro správce</a>. Ve zbytku článku předpokládám, že tuto problematiku ovládáte.</p>
<p>Gitosis je vázán na jednoho konkrétního uživatele, v Debianu je to stejnojmenný uživatel, tedy <code>gitosis</code>. Gitosis řídí přístup jednotlivých uživatelů prostřednictvím konfigurace a SSH klíčů. Žádné uživatelské účty se při práci s ním nezakládají. Z pohledu systému vše probíhá pod jedním uživatelem.</p>
<h3>Instalace a zprovoznění Gitosis</h3>
<p>Prvním krokem nemůže být nic jiného než nainstalování příslušného balíčku. V repozitářích Debianu je k dispozici stejnojmenný balíček <code>gitosis</code>, který nainstalujte takto:</p>
<pre>aptitude install gitosis</pre>
<p>Pokud se vás během instalace Debconf nezeptá na SSH klíč, který má být použit pro přístup k repozitáři správce, nedojde k vytvoření tohoto repozitáře, a bude tedy nutné jej vytvořit ručně (obvyklý trik s <code>dpkg-reconfigure gitosis</code> zde nejspíše nezabere, alespoň dle mých pokusů). Ruční vytvoření repozitáře je však velmi jednoduché:</p>
<pre>sudo -H -u gitosis gitosis-init &lt; id_rsa.pub</pre>
<p>Předpokladem je dostupnost souboru <code>id_rsa.pub</code> s veřejným SSH klíčem, který budete používat pro přístup ke správcovskému repozitáři <code>gitosis-admin</code>.</p>
<h4>Nastavení Gitosis</h4>
<p>V tuto chvíli byste měli mít možnost naklonovat správcovský repozitář na svém počítači.</p>
<pre>git clone <span class="eaddress">gitosis@server<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />example<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />org</span>:gitosis-admin.git</pre>
<p>Pokud se podíváte do obsahu repozitáře, naleznete soubor <code>gitosis.conf</code> (hlavní konfigurační soubor Gitosis) a adresář <code>keydir</code>. Ten slouží jako úložiště SSH klíčů jednotlivých uživatelů.</p>
<p>Výchozí konfigurační soubor je velmi strohý. Příklad komentovaného konfiguračního souboru pro inspiraci naleznete např. v <code>/usr/share/doc/gitosis/examples/example.conf</code> (platí pro Debian).</p>
<p>Obecné nastavení Gitosis naleznete v bloku <code>[gitosis]</code>:</p>
<pre>[gitosis]
gitweb = no
daemon = no</pre>
<p>Zde se nastavuje globální zpřístupnění repozitářů Gitwebu a Git démona (aby toto nastavení mělo kýžený účinek, je třeba provést integraci těchto dvou nástrojů s Gitosis, což je naznačeno níže). Zpřístupnění repozitářů těmto nástrojům lze nastavit jak na globální úrovni zde, tak na úrovni jednotlivých repozitářů (viz níže).</p>
<h4>Nastavení repozitáře</h4>
<p>Nastavení repozitáře není nutné, stačí jméno repozitáře přiřadit konkrétní skupině uživatelů (viz níže). Pokud však chcete nastavit některé parametry repozitáře, vytvořte nový blok s jeho definicí, takto:</p>
<pre>[repo mujprojekt]
gitweb = yes
description = Popis mého projektu
owner = Michal Dočekal
daemon = yes</pre>
<p>V definici je naznačená integrace s Gitwebem a Git démonem (viz výše). Přístupnost repozitáře přes Gitweb řídí proměnná <code>gitweb</code>, přičemž pokud ji nastavíte na <code>yes</code>, doporučuji vyplnit i proměnné <code>description</code> (popis) a <code>owner</code> (jméno vlastníka). Tyto dvě proměnné slouží primárně pro integraci s Gitwebem. Poslední proměnná, <code>daemon</code>, řídí integraci s Git démonem.</p>
<h4>Integrace s Gitwebem</h4>
<p>Za účelem integrace Gitosis s Gitwebem upravte hodnoty v konfiguračním souboru <code>/etc/gitweb.conf</code>, takto:</p>
<pre>$projectroot = "/srv/gitosis/git";
$projects_list = "/srv/gitosis/gitosis/projects.list";
$strict_export = "true";</pre>
<h4>Integrace s Git démonem</h4>
<p>Integrace s Git démonem je trošku složitější. V první řadě je potřeba upravit parametry startovacího skriptu Git démona v souboru <code>/etc/service/git-daemon/run</code>. Zde nalezněte řádku se specifikací <code>--base-path</code>:</p>
<pre>--base-path=/var/cache /var/cache/git</pre>
<p>Jak je vidět, tato cesta neukazuje do úložiště Gitosis, tudíž v tomto stavu Git démon jednotlivé repozitáře „neuvidí“. Nastavte tedy správnou cestu, takto:</p>
<pre>--base-path=/srv/gitosis/git /srv/gitosis/git</pre>
<p>Soubor uložte a následně restartujte Git démona:</p>
<pre>sv restart git-daemon</pre>
<p>Poté by povolené repozitáře mělo být možné klonovat, takto:</p>
<pre>git clone git://server.example.org/mujprojekt1.git</pre>
<h4>Nastavení uživatelů a přístupových práv</h4>
<p>Výchozí nastavení Gitosis zahrnuje skupinu <code>gitosis-admin</code>, jejíž členové mají práva k repozitáři správce:</p>
<pre>[group gitosis-admin]
writable = gitosis-admin
members = docekal</pre>
<p>Pokud byste chtěli vytvořit skupinu <code>skupina</code> obsahující uživatele <code>milan</code> a <code>jan</code> s přístupem k repozitářům <code>mujprojekt1</code>, <code>mujprojekt2</code> a <code>mujprojekt3</code> tak, aby uživatelé skupiny měli přístup k repozitářům <code>mujprojekt1</code> a <code>mujprojekt2</code> pouze pro čtení a k repozitáři <code>mujprojekt3</code> i se zápisem, vypadala by konfigurace takto:</p>
<pre>[group skupina]
writable = mujprojekt3
readonly = mujprojekt1 mujprojekt2
members = milan jan</pre>
<p>Mezi členy (<code>members</code>) může patřit i jiná skupina – tu je ovšem třeba označit zavináčem na začátku:</p>
<pre>members = @nejaka_skupina</pre>
<p>U uživatelů se předpokládá existence souborů s jejich SSH klíči. Uživatel <code>milan</code> by měl mít klíč v <code>keydir/milan.pub</code>. Po nastavení a přidání klíčů změny commitněte a nahrajte na server:</p>
<pre>git add gitosis.conf keydir
git commit -m 'nastaveni repositaru'
git push</pre>
<h3>Workflow pro jednotlivé repozitáře</h3>
<p>Ve chvíli, kdy máte hotové nastavení oprávnění a repozitářů, je konečně můžete začít tvořit a nahrávat na server. Sada příkazů od vytvoření repozitáře až k jeho prvotnímu nahrání na server by mohla vypadat takto:</p>
<pre>mkdir projekt
cd projekt
git init
git remote add origin <span class="eaddress">gitosis@server<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />example<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />org</span>:projekt.git
# vytvoření souborů a adresářů s obsahem repozitáře
git add *
git commit -m "initial commit"
git push origin master:refs/heads/master</pre>
<p>Význam většiny příkazů by měl být patrný. Jádro postupu tvoří dva příkazy. První slouží k přidání serveru s Gitosis jako vzdáleného repozitáře:</p>
<pre>git remote add origin <span class="eaddress">gitosis@server<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />example<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />org</span>:projekt.git</pre>
<p>Druhý pak v prázdném repozitáři na serveru vytvoří „master“ větev z místní „master“ větve. Příkaz nemusíte opakovat, podruhé stačí <code>git push</code>.</p>
<pre>git push origin master:refs/heads/master</pre>
<p>Tím bych tento díl ukončil.</p>

<pre id="links">https://pubmem.wordpress.com/2010/07/24/how-to-setup-git-gitosis-and-gitweb/ How to setup git, gitosis and gitweb
http://stackoverflow.com/questions/7506832/git-push-origin-masterrefs-heads-master-what-does-this-do git push origin master:refs/heads/master what does this do
http://www.frlinux.eu/?p=135 gitweb and nginx on Debian
http://git-scm.com/ Web projektu s odkazy na dokumentaci a videa o Gitu
http://knihy.nic.cz/ Scott Chacon, CZ.NIC: Pro Git (kniha o Gitu přeložená do češtiny)
http://book.git-scm.com/ The Git Community Book</pre>
