<meta http-equiv="content-type" content="text/html;charset=utf-8" />


<h1>Správa linuxového serveru: Další nastavení sítě pomocí nástroje ip</h1>

<p>Dnešní díl téma nastavení sítě pomocí nástroje ip uzavře. Představí vám směrovací pravidla, dotkne se protokolu IPv6 a možnosti zřídit si IPv6 tunel přes IPv4 protokol a řekne vám, jakým způsobem změny provedené v minulých dílech nastavit tak, aby přečkaly restart počítače.</p>

<p>Připomínám dva předchozí díly, a sice <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-nastaveni-site-pomoci-nastroje-ip">první díl</a>, který představil nástroj <code>ip</code> a základy práce s ním, zatímco <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-pokrocile-nastaveni-site-pomoci">druhý díl</a> zmínil protokol ARP, základní nastavení směrování a doplnil vše, co nezbytně potřebujete k ručnímu vytvoření připojení k internetu (výchozí bránu, nastavení resolveru a přidání alespoň jedné IP adresy síťovému rozhraní).</p>
<h3>Směrovací pravidla</h3>
<p>Nástroj <code>ip</code> (a potažmo linuxové jádro) toho umí mnohem více. Řekněme, že máte k dispozici dvě brány a chcete nějakou komunikaci směrovat přes jednu a jinou komunikaci přes druhou bránu. Něco takového je také možné, a to pomocí směrovacích pravidel (<code>ip rule</code>).</p>
<p>V minulém díle jste viděli příklady směrování. To, co jsem vám zamlčel, je skutečnost, že směrovacích tabulek může být více. Nemusíte tedy mít všechna směrovací pravidla pohromadě, ale můžete je rozdělit. Pomocí <code>ip rule</code> pak můžete definovat, kdy se použije jaká tabulka.</p>
<p>Příkladem může být následující situace. Máte směrovač, který má čtyři síťová rozhraní, přičemž dvě vedou do dvou místních sítí (192.168.0.0/24 a 192.168.1.0/24) a druhá dvě vedou ke dvěma poskytovatelům připojení. Vy chcete pakety z jedné sítě směrovat přes jednoho ISP a pakety z druhé sítě přes druhého ISP. Pro představu doplňuji malý ASCII „obrázek“:</p>
<pre>síť 192.168.0.0/24 \      / brána 10.0.0.1 --- ISP1
                    router 
síť 192.168.1.0/24 /      \ brána 10.0.2.1 --- ISP2</pre>
<p>Specifikace IP adres na routeru by vypadala takto:</p>
<pre>ip addr add 10.0.0.254/24 dev eth0
ip addr add 10.0.2.254/24 dev eth1
ip addr add 192.168.0.254/24 dev eth2
ip addr add 192.168.1.254/24 dev eth3</pre>
<p>Následuje specifikace výchozích bran do dvou oddělených tabulek, tabulky 101 a tabulky 102:</p>
<pre>ip route add default via 10.0.0.1 dev eth0 table 101
ip route add default via 10.0.2.1 dev eth1 table 102</pre>
<p>Na závěr je potřeba specifikovat pravidla, která budou posílat pakety do jednotlivých tabulek na základě příslušnosti k určité síti:</p>
<pre>ip rule add from 192.168.0.0/24 table 101
ip rule add from 192.168.1.0/24 table 102</pre>
<p>Přirozeně může nastat mnoho jiných situací. Kupříkladu, místo druhého ISP můžete mít VPN (to by se konfigurovalo velmi podobně), nebo místo dvou sítí budete chtít přes jedno připojení směrovat komunikaci, která směřuje na konkrétní počítač, např.:</p>
<pre>ip rule add to 1.2.3.4 table 101</pre>
<p>Ve spolupráci s příkladem výše by tento řádek směroval spojení s počítačem <code>1.2.3.4</code> přes tabulku 101, tedy ISP1.</p>
<p>Pokud chcete zobrazit obsah konkrétní směrovací tabulky, můžete použít <code>ip route</code> v následující syntaxi:</p>
<pre>ip route show table 101
ip route show table 102</pre>
<p>Mohu vám jen doporučit podívat se na kompletní syntax <code>ip rule</code> do manuálových stránek, nebo si alespoň rychle zobrazit nápovědu:</p>
<pre>ip rule help</pre>
<p>Zjistíte, že můžete směrovat pakety i podle značek firewallu, dle TOS apod. Zjistíte také, že určité pakety můžete odmítat, a to jak na úrovni směrovacích tabulek (<code>ip route</code>), tak na úrovni směrovacích pravidel (<code>ip route</code>).</p>
<h4>Maškaráda</h4>
<p>V příkladu se dvěma ISP výše by nastal jeden „drobný“ problém – žádný z počítačů ve vnitřních sítích by se nedostal na internet. Důvodem je použití privátních rozsahů. Počítače ve vnitřní síti totiž nejsou díky nim přímo adresovatelné. V této situaci by bylo třeba zařídit, aby router prováděl SNAT, tedy překlad zdrojové adresy (opakem je DNAT, což je překlad cílové adresy). Konkrétně vám ukážu jeho variantu zvanou maškarádu. Ta spočívá v tom, že jádro nastaví zdrojovou adresu automaticky podle toho, jakou adresu počítač na daném rozhraní má. To má tu výhodu, že pro vytvoření tohoto pravidla nemusíte předem znát IP adresu, kterou bude mít router k dispozici (např. v situaci, kdy ISP přiděluje adresu routeru z DHCP serveru).</p>
<p>Maškaráda (stejně jako SNAT a DNAT) se dají nastavit přes Netfilter, tedy pomocí nástroje <code>iptables</code>:</p>
<pre>iptables -t POSTROUTING -o eth0 -j MASQUERADE
iptables -t POSTROUTING -o eth1 -j MASQUERADE</pre>
<p>Snad nemusím dodávat, že všechno výše uvedené bude fungovat, pouze pokud bude v jádře povoleno předávání paketů (pokud nevíte, jak na to, mrkněte na poslední dva díly, kde je to popsáno). Pokud povoleno nebude, router nebude fungovat jako router a nebude pakety předávat.</p>
<h3>Protokol IPv6 a nástroj ip</h3>
<p>Víceméně všechny operace s nástrojem <code>ip</code>, které jste zde viděli, můžete provádět i v rámci IPv6 protokolu. Nástroj <code>ip</code> IPv6 adresy pozná a přizpůsobí se. Někdy se však hodí vědět, jak nástroji <code>ip</code> explicitně říci, že má brát v úvahu konkrétní protokol, buď IPv4 nebo IPv6. K tomuto účelu slouží přepínače <code>-4</code> a <code>-6</code>:</p>
<pre>ip -6 addr  # IPv6 adresy všech rozhraní
ip -6 route # IPv6 směrovací tabulka
ip -4 addr  # IPv4 adresy všech rozhraní
ip -4 route # IPv4 směrovací tabulka</pre>
<h3>IPv6 přes IPv4</h3>
<p>V datacentrech byste se neměli setkat s tím, že IPv6 připojení není k dispozici, i když raději onen podmiňovací způsob zdůrazňuji, jelikož do nedávna to ještě stále někde problém byl. Většinou se ale s absencí IPv6 konektivity setkáte spíše v domácích podmínkách než v datacentrech. Ideální je samozřejmě tlačit na ISP, aby vám poskytl nativní IPv6 konektivitu, to v každém případě. Ale do té doby, než se tak stane, můžete využít tunelování IPv6 protokolu přes IPv4 protokol.</p>
<p>K tomu samozřejmě potřebujete někoho, kdo IPv6 konektivitu poskytuje a kdo vám poskytne druhý konec tunelu, vaše IPv6 pakety vybalí z IPv4 paketů a pošle je přes IPv6 síť tam, kam mají odejít. Těchto subjektů je k dispozici celá řada, ideální je samozřejmě vybírat ten subjekt, který je vám fyzicky co nejblíže. Odkážu vás v této souvislosti na <a href="https://en.wikipedia.org/wiki/List_of_IPv6_tunnel_brokers">seznam</a> na Wikipedii.</p>
<p>Pokud naleznete schopného „brokera“, dá vám k dispozici nejenom potřebné údaje k nastavení sítě, ale i sadu příkazů podle operačního systému a vy můžete použít oblíbenou metodu copy &amp; paste do terminálu či do editoru. Konfigurace pomocí nástroje <code>ip</code> může vypadat nějak takto:</p>
<pre>ip tunnel add sestkovy-tunel mode sit remote 1.2.3.4 local 4.3.2.1 ttl 255
ip link set sestkovy-tunel up
ip addr add 2001:db8::/32 dev sestkovy-tunel
ip route add ::/0 dev sestkovy-tunel</pre>
<p>První příkaz vytvoří tunel s názvem <code>sestkovy-tunel</code> v módu <code>sit</code> (což je IPv6-přes-IPv4 tunel). Zde je třeba zmínit dvě IP adresy, a sice adresu <code>remote</code>, tedy adresu koncového bodu tunelu (to je IP adresa vašeho brokera), a adresu <code>local</code>, tedy místní adresu vašeho počítače (tam tunel začíná). Druhý příkaz pak tunel „nahodí“, třetí tunel přidá vámi poskytnutý IPv6 rozsah a následuje nastavení cesty (routy).</p>
<h4>Zpřístupnění IPv6 konektivity místní síti</h4>
<p>Pokud chcete celé své domácí síti zpřístupnit IPv6 konektivitu, mělo by vám stačit nastavit router avdertisement démona, který bude ohlašovat potřebné údaje počítačům v síti, aby mohli provést autokonfiguraci.</p>
<p>Takovým démonem je například <code>radvd</code>, jehož název může některé mírně zmást. Ne, ono DVD v názvu nemá s dévédéčky nic společného. Je to jen zkrácenina od <strong>r</strong>outer <strong>adv</strong>ertisement <strong>d</strong>aemon.</p>
<p>Ale zpět k <code>radvd</code>. Konfiguruje se v souboru <code>/etc/radvd.conf</code> a příklad konfigurace může vypadat nějak takto:</p>
<pre>interface eth1 {
    AdvSendAdvert on;
    prefix 2001:db8::/32 {
        AdvOnLink on;
    };
};</pre>
<p>Je to skutečně velmi jednoduchý příklad, nejprve se specifikuje síťové rozhraní, na kterém se mají oznámení posílat, v tomto případě <code>eth1</code>. Následuje blok s nastavením pro dané rozhraní. První volba v něm zapíná posílání samotných oznámení (tudíž musí být „on“), následuje specifikace prefixu pro danou síť a daný prefix je pak třeba také „povolit“ volbou <code>AdvOnLink</code>. Následně démona nastartujte:</p>
<pre>/etc/init.d/radvd start</pre>
<p>Pokud se vše povedlo, měly by počítače v místní síti automaticky získat IPv6 adresu i routy.</p>
<p>Více informací o nastavení <code>radvd</code> naleznete v manuálových stránkách:</p>
<pre>man radvd.conf</pre>
<h3>Uložení nastavení pro přežití restartu</h3>
<p>Pokud budete provádět nastavení sítě pomocí nástroje <code>ip</code>, asi je vám jasné, že tato nastavení nepřečkají restart, jelikož se nikam neukládají. Totéž platí pro nastavení <code>iptables</code>. Aby vaše nastavení přečkalo restart, je třeba ho někam uložit.</p>
<p>Jedním z míst pro ukládání různých procedur a nastavení, jež se mají vykonat po spuštění počítače, je skript <code>/etc/rc.local</code>, který bude spuštěn na konci bootování. Pro nastavení sítě to ale není nejvhodnější umístění, jelikož konec bootování obvykle nastává dávno po aktivaci sítě a síťových rozhraní. Ideální by tedy bylo navázat nastavení sítě na „nahození“ příslušného síťového rozhraní. Toho je možné docílit pomocí direktivy <code>up</code> v konfiguračním souboru <code>/etc/network/interfaces</code>:</p>
<pre>iface eth0 inet static
    address 1.2.3.4
    netmask 255.255.255.0
    gateway 4.3.2.1
    up ip addr add 1.2.3.5/24 dev eth0
    up ip addr add 1.2.3.6/24 dev eth0
    up ip route add 5.6.7.8 via 8.7.6.5
    up iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</pre>
<p>Můžete své nastavení vložit do skriptu a na něj se potom odkázat, nebo všechno napsat do <code>/etc/network/interfaces</code>. Toto řešení je lepší, ale není úplně čisté – ideální by bylo přidat direktivy <code>down</code>, které toto nastavení odčiní, aby se při shození a opětovném nahození rozhraní zbytečně nemnožily záznamy v tabulkách.</p>
<h3>Závěr</h3>
<p>Nástroj <code>ip</code> a nastavení sítě by se dalo probírat ještě dlouho, nicméně tímto dílem bych toto téma, alespoň prozatím, ukončil.</p>

<pre id="links">http://linux-ip.net/html/routing-rpdb.html Routing Policy Database (RPDB)
http://linux-ip.net/html/tools-ip-rule.html ip rule
http://www.wiggy.net/texts/ipv6-howto/ Simple IPv6 HOWTO
https://en.wikipedia.org/wiki/IPv6 IPv6
http://ipv6.com/articles/general/IPv6-Addressing.htm IPv6 Addressing
http://lartc.org/howto/lartc.rpdb.multiple-links.html Routing for multiple uplinks/providers
http://linux-ip.net/html/index.html Guide to IP Layer Network Administration with Linux
http://jazstudios.blogspot.com/2007/04/iproute-commands.html Iproute commands
http://www.linuxfoundation.org/collaborate/workgroups/networking/ Kernel networking
http://www.policyrouting.org/iproute2.doc.html IPROUTE2 Utility Suite Howto
http://lartc.org/howto/index.html Linux Advanced Routing & Traffic Control HOWTO
http://web.archive.org/web/20090309011121/http://www.m4r3k.org/czech/proc-nepouzivat-ifconfig/ Marek Stopka, Proč nepoužívat ifconfig?</pre>
