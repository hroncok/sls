<meta http-equiv="content-type" content="text/html;charset=utf-8" />


<h1>Správa linuxového serveru: Úvod do konfigurace Apache (moduly rewrite a chroot)</h1>

<p>V tomto dílu budou v rychlosti představeny dva moduly Apache, mod_rewrite sloužící k přepisu URL, který má široké možnosti použití počínaje „pěknými URL“, a mod_chroot představující jistou formu zabezpečení formou izolace běhu Apache v části adresářové struktury.</p>

<h3><code>mod_rewrite</code> aneb pěkná URL</h3>
<p>Jedním z nejpoužívanějších modulů pro Apache je <code>mod_rewrite</code>, komplexní systém pro přepis či manipulaci s URL. Tento doplněk je využíván, v některých případech i přímo vyžadován řadou webových aplikací. I když jsou jeho možnosti velmi široké a je možné jej použít k mnoha účelům, nejčastěji je užíván pro tvorbu „pěkných“ URL, tzn. skrývání standardních mechanismů pro předávání parametrů webové aplikaci tak, aby URL vypadalo „pěkně“ a bylo přátelské pro roboty vyhledávačů (SEO). Pro představu, URL využívající standardního mechanismu pro předávání parametrů webové aplikaci vypadá třeba takto:</p>
<pre>http://www.example.com/index.php?nazev_clanku=sprava_linuxoveho_serveru</pre>
<p>Modul <code>rewrite</code> umožňuje příslušný parametr korektně předat webové aplikaci, přičemž však navenek využívá úplně jiné URL, např.:</p>
<pre>http://www.example.com/clanky/sprava_linuxoveho_serveru.html</pre>
<p>Jak to vlastně funguje? Pravidlo pro přepis umí „přeložit“ výše uvedený příklad pěkného URL na původní, klasický tvar s parametrem pro <code>index.php</code>, kde může sídlit jádro webové aplikace. Webové aplikace se pak obvykle postarají o to, aby generovaly správná, „pěkná“ URL, přičemž spoléhají na webový server, aby tato „pěkná“ URL přeložil interně do takové podoby, kterou očekává daná webová aplikace.</p>
<p>Pravidla pro <code>mod_rewrite</code> je možné specifikovat jak v rámci konkrétního virtuálního webu, tak v souboru <code>.htaccess</code>, který umožňuje (pokud je to povoleno) upravit konfiguraci webového serveru pro daný adresář a podadresáře. Tento soubor naleznete jako součást mnoha webových aplikací.</p>
<p>Modul <code>rewrite</code> není ve výchozí konfiguraci Apache v Debianu aktivován, je tedy třeba jej nejprve povolit, takto:</p>
<pre>a2enmod rewrite
/etc/init.d/apache2 restart</pre>
<p>Pro fungování modulu <code>rewrite</code> jsou stěžejní čtyři direktivy: <code>RewriteEngine</code>, <code>RewriteBase</code>, <code>RewriteCond</code> a <code>RewriteRule</code>. Aby přepis URL fungoval, je třeba jej nejprve zapnout, buď na úrovni konfigurace daného virtuálního webu, nebo na úrovni <code>.htaccess</code>:</p>
<pre>RewriteEngine on</pre>
<p>Poté je možné použít ostatních direktiv. Při nasazení webových aplikací na server budete patrně nastavovat hodnotu direktivy <code>RewriteBase</code>, která upraví výchozí URL pro samotný přepis. Kupříkladu, pokud budete instalovat aplikaci do <code>/appl</code> na web (tzn. URL aplikace bude např. <code>http://www.example.org/appl</code>), specifikujete jako hodnotu v <code>RewriteBase</code> právě <code>/appl</code>. Toto umístění pak bude tvořit základnu pro všechny přepisy, které specifikujete pomocí <code>RewriteCond</code> a <code>RewriteRule</code>.</p>
<p>Samotný přepis URL je realizován pomocí určité podmínky (nebo podmínek), za kterých přepis nastane (ty jsou specifikovány pomocí direktivy <code>RewriteCond</code>), a jednoho nebo více pravidel pro samotný přepis (k tomu slouží direktiva <code>RewriteRule</code>). Syntax a možnosti obou direktiv jsou velice bohaté, já se omezím pouze na jediný příklad a odkážu vás v odkazech pod článkem na další zdroje, kde se dozvíte více.</p>
<pre>RewriteCond  %{HTTP_HOST}  ^([^.]+)\.([^.]+)$
RewriteRule  ^(.*)$ http://www.%{HTTP_HOST}$1 [L,R=301,QSA]</pre>
<p>Výše uvedené pravidlo demonstruje, že <code>mod_rewrite</code> můžete použít nejenom k zajištění pěkných URL, ale pro řadu jiných situací. Toto pravidlo vytvoří přesměrování na doménový tvar s „www“, pokud klient zadá do prohlížeče pouze doménu druhého řádu. Tzn. pokud klient zadá do prohlížeče třeba "<code>example.com/index.html</code>", toto pravidlo prohlížeči vrátí přesměrování (HTTP kód 301) na URL "<code>http://www.example.com/index.html</code>". V podmínce vidíte na prvním místě definici proměnné k porovnání, v tomto případě <code>HTTP_HOST</code>, serverová proměnná obsahující hostname v HTTP požadavku. Hodnota se porovnává s regulárním výrazem (v syntaxi Perlu) specifikovaným jako druhý parametr <code>RewriteCond</code>. Tento regulární výraz zachytí hostname obsahující pouze jednu tečku, tedy doménu druhého řádu. Pokud klient specifikuje libovolnou doménu třetího řádu, pak pravidlu nevyhoví a přepis se neprovede.</p>
<p>Samotné pravidlo pro přepis specifikované v <code>RewriteRule</code> obsahuje na prvním místě regulární výraz, který bude aplikován na vstupní hodnotu <code>RewriteRule</code>, což je u prvního pravidla samotná URL cesta (cesta relativní k <code>DocumentRoot</code>), u dalších pravidel by to pak byl výstup z předchozího pravidla. V příkladu výše by to bylo <code>/index.html</code> (z <code>http://example.com/index.html</code>). Na druhém místě je řetězec pro substituci, který nahrazuje původní URL cestu. Na třetím místě, v hranatých závorkách, jsou značky (flags). Ty jsou zde tři, a sice značku „L“, která označuje poslední pravidlo, tzn. po tomto přepisu se již nebudou provádět žádná další pravidla, dále značku „R=301“ označující přesměrování pomocí kódu 301 (moved permanently), a QSA (query string append), která zajistí, že se na konec URL připojí i „query string“, tj. případný kus zdrojového URL začínajícího otazníkem. Dolar a jednička v URL se vztahuje k regulárnímu výrazu, který je aplikován na vstupní hodnotu <code>RewriteRule</code>, zde bude odpovídat celé cestě relativní k <code>DocumentRoot</code>, tedy v příkladu výše <code>/index.html</code>.</p>
<h4>mod_chroot</h4>
<p>Tento modul je jednou z možností, jak do jisté míry zvýšit bezpečnost. Funguje tak, že uzavře Apache v chrootu, tedy v adresáři, který si zvolíte a který se pro Apache stane kořenovým adresářem. V takovém případě, i kdyby se útočník dostal přes nějakou zranitelnost v Apachi dál, bude uzavřen v izolované oblasti, ze které se nedostane do zbytku systému (dostane se ovšem k webovým prezentacím). Tolik teorie, i když je rozhodně nutné dodat, že bezpečnost chrootu není v žádném případě neomezená (např. proces s rootovskými právy se může z chrootu dostat).</p>
<p>Příslušný modul naleznete v balíčku <code>libapache2-mod-chroot</code>, po jehož instalaci jej aktivujte obvyklým způsobem:</p>
<pre>a2enmod mod_chroot
/etc/init.d/apache2 restart</pre>
<p>V tuto chvíli se kromě samotného zavedení modulu ještě nic nestalo, neboť chroot je potřeba nejprve nakonfigurovat, a to direktivou <code>ChrootDir</code>, kterou můžete umístit třeba do <code>/etc/apache2/httpd.conf</code>. Jejím parametrem je adresář, který se pro Apache stane kořenovým:</p>
<pre>ChrootDir /var/www</pre>
<p>Při implementaci chrootu se budete potýkat s řadou problémů, které jsou s ním spojené. Prvním problémem je umístění souboru s PID Apache, který Apache umisťuje do <code>/var/run</code>. Pokud se však kořenovým adresářem stal <code>/var/www</code>, pak se Apache snaží umístit tento soubor do <code>/var/www/var/run</code> (který ve vašem systému patrně neexistuje). Tento adresář je tedy potřeba vytvořit.</p>
<p>Dalším problémem je nutnost změny konfigurace virtuálních webů, zejména veškerých direktiv <code>DocumentRoot</code>. Možným rychlým řešením je vytvoření symbolického odkazu <code>/var/www/var/www</code>, který bude ukazovat na kořenový adresář, tedy /:</p>
<pre>ln -s / /var/www/var/www</pre>
<p>Po vyřešení těchto dvou problémů by se vám mělo podařit Apache spustit a vaše weby by měly fungovat, tedy alespoň ty statické, popřípadě ty, které využívají <code>mod_php</code>. Pokud budete chroot takto provozovat, jistě se setkáte se situací, kdy vaší webové aplikaci bude chybět něco, co se nachází mimo chroot. V té chvíli vám nezbude než potřebné soubory překopírovat do chrootu.</p>
<p>Posledním problémem, na který vás upozorním, je problém s ukončováním a restartem Apache. Je to dáno tím, že PID soubor se přesunul, ale init-skript v <code>/etc/init.d/apache2</code> jej očekává ve <code>/var/run</code>. To můžete vyřešit opět symbolickým odkazem:</p>
<pre>ln -s /var/www/var/run/apache2.pid /var/run/apache2.pid</pre>
<p>V zásadě, použití chrootu má potenciál zvýšit bezpečnost vámi provozovaného webového serveru, ale za cenu možných problémů, na které patrně narazíte, pokud neprovozujete pouze statické weby. Na úplný závěr ještě zmíním alternativy, kterými je jistě mechanismus <code>suexec</code> a bezpečnostní řešení na úrovni jádra, jako je SELinux, AppArmor, Tomoyo apod.</p>

<pre id="links">http://www.jakpsatweb.cz/server/mod-rewrite.html Jakpsátweb: Mod_rewrite
http://httpd.apache.org/docs/current/mod/mod_rewrite.html Apache Module mod_rewrite
http://httpd.apache.org/docs/current/rewrite/rewrite_guide.html URL Rewriting Guide
http://www.howtoforge.com/chrooting-apache2-with-mod_chroot-on-debian-lenny Chrooting Apache2 With mod_chroot On Debian Lenny</pre>
