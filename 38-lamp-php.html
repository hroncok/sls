<meta http-equiv="content-type" content="text/html;charset=utf-8" />


<h1>Správa linuxového serveru: Konfigurace LAMP: PHP</h1>

<p>V předchozím díle byla probrána instalace platformy LAMP (zkratka pro Linux, Apache, MySQL a PHP). Tento díl seriálu se bude věnovat základům konfigurace LAMP v prostředí Debianu, konkrétněji konfiguraci a možnostem zabezpečení PHP interpretu.</p>

<h3>Úvod</h3>
<p>Hlavním konfiguračním souborem PHP je <code>php.ini</code>, sídlící v adresáři <code>/etc/php5/apache2</code>. Všimněte si, že tento konkrétní konfigurační soubor je umístěn v podadresáři <code>apache2</code>. PHP interpret může mít odlišný konfigurační soubor pro různé typy použití, které jsou pak umístěny v podadresářích <code>/etc/php5</code>. Kupříkladu, pokud nainstalujete balíček <code>php5-cli</code>, který obsahuje interpret PHP pro příkazovou řádku, dojde k vytvoření konfiguračního souboru <code>php.ini</code> v adresáři <code>/etc/php5/cli</code>, který se použije v rámci tohoto interpretu. Jeho konfigurace tak bude oddělena od konfigurace PHP určené pro webový server Apache v umístění uvedeném výše.</p>
<p>PHP má řadu rozšíření (extensions), které jsou v Debianu k dispozici v podobě balíčků s prefixem <code>php5-</code>, popřípadě <code>php-</code>. Naleznete zde konektory k databázím (např. <code>php5-mysql</code>, <code>php5-pgsql</code> či <code>php5-sqlite</code>), rozšíření pro práci s obrázky (<code>php5-gd</code> a <code>php5-imagick</code>) a řadu dalších. Různé webové aplikace vyžadují nebo umí využít různá rozšíření, o čemž se obvykle dozvíte v jejich dokumentaci. Vhodnou strategií bývá instalovat rozšíření teprve, až když víte, že jej budete opravdu potřebovat.</p>
<h4>php.ini</h4>
<p>Konfigurační soubor <code>php.ini</code> je (nejen) v Debianu velmi dobře komentovaný, je tedy vhodné doporučit, abyste si jej celý prošli a nastavili podle svých požadavků. To platí dvojnásob, pokud konfigurujete produkční server. V souvislosti s tím vás raději znovu upozorním na to, že výchozí <code>php.ini</code> určený pro Apache je v Debianu nastavený spíše s ohledem na vývojové servery, nikoliv na produkční. Na produkčních serverech je vhodné konfiguraci upravit přinejmenším s ohledem na bezpečnost a na požadavky provozovaných aplikací. Debian Lenny nabízí <code>php.ini</code> určený pro produkční použití v <code>/usr/share/doc/php5/examples/php.ini-recommended</code>.</p>
<p>Samotná rozšíření pak naleznete jako samostatné <code>.ini</code> soubory v <code>/etc/php5/conf.d</code>, kde v některých případech naleznete kromě direktivy pro zavedení příslušného modulu i specifické konfigurační volby. V jednotlivých podadresářích s <code>php.ini</code> (např. <code>/etc/php5/apache2</code>) se pak nachází symbolický odkaz <code>conf.d</code> vedoucí na hlavní <code>/etc/php5/conf.d</code>, tzn. zavedení modulů je pro jednotlivé konfigurace společné, ale není problém symbolický odkaz nahradit adresářem, kde můžete sami rozhodnout, které moduly mají být v dané konfiguraci použity.</p>
<p>Mezi důležité konfigurační volby, kterým byste měli věnovat pozornost, patří následující:</p>
<p><code>expose_php</code> přijímá jako parametr „On“ nebo „Off“ a umožňuje „skrýt“ přítomnost PHP v HTTP hlavičkách odpovědí webového serveru. Pokud je nastavena na „On“, ohlašuje Apache přítomnost PHP i verzi takto:</p>
<pre>Server: Apache/2.2.9 (Debian) PHP/5.2.6-1+lenny9 with Suhosin-Patch</pre>
<p>Je-li volba <code>expose_php</code> nastavena na „Off“, přítomnost PHP není ohlašována vůbec:</p>
<pre>Server: Apache/2.2.9 (Debian)</pre>
<p><code>max_execution_time</code> přijímá jako parametr čas v sekundách a určuje, jak dlouho může PHP skript běžet před tím, než bude násilně ukončen. Výchozí hodnotou je 30 (vteřin).</p>
<p><code>memory_limit</code> přijímá jako parametr maximum paměti, kterou může PHP skript využít. Výchozí hodnotou je <code>128M</code>, kde M znamená MB. Pokud skript požádá o více paměti, bude ukončen s chybou. Jak v případě volby <code>max_execution_time</code>, tak v případě této platí daná hodnota pro jeden běh skriptu, tedy jeden HTTP požadavek obsluhovaný PHP skriptem. Více požadavků naráz může tedy zabrat n-krát více paměti.</p>
<p><code>display_errors</code> řídí zobrazování chyb a může nabývat dvou hodnot, „On“ nebo „Off“. Jeho výchozí hodnota je „On“, což představuje potenciální bezpečnostní problém - chyby, varování či hlášení v rámci běhu PHP skriptů se pak zobrazují v prohlížeči včetně některých možných zneužitelných informací (chybová hlášení při práci s databází atd.). Tuto volbu je tedy na produkčních serverech vhodné nastavit na „Off“. To, co se vlastně zobrazuje, tzn. zdali se zobrazují pouze chyby, nebo i varování a hlášení, řídí parametr <code>error_reporting</code>. Více k tomuto tématu naleznete např. v <a href="http://www.zaachi.com/cs/items/chybova-hlaseni-v-php.html">tomto</a> článku.</p>
<p><code>display_startup_errors</code> řídí zobrazování kritických chyb, ke kterým dochází při spouštění PHP skriptu. Nabývá stejných hodnot jako parametr <code>display_errors</code>, jeho výchozí hodnotou je „Off“ a na produkčních serverech doporučuji tuto hodnotu ponechat.</p>
<p><code>log_errors</code> vám pomůže se k chybovým hlášením dostat, pokud vypnete jejich zobrazování. Nabývá hodnot „On“ nebo „Off“, přičemž hodnota „On“ zařídí logování chybových hlášení do chybového logu webového serveru. Pokud budete logování chybových hlášení povolovat, podívejte se i na další parametry ovlivňující logování, např. parametr <code>ignore_repeated_errors</code>, kterému nastavte hodnotu „On“, aby se zbytečně neplnil váš log opakovanými chybovými hláškami, či samotný výše zmíněný parametr <code>error_reporting</code> ovlivňující typy hlášení, na které se bude brát zřetel.</p>
<p><code>disable_functions</code> umožňuje zakázat provádění jistých PHP funkcí ve skriptech, což může posloužit jako jedno z bezpečnostních opatření. Příkladem seznamu funkcí k zakázání může být tento:</p>
<pre>disable_functions = shell_exec, exec, system, passthru, proc_close, proc_open, proc_get_status, proc_nice, proc_open, proc_terminate, shell_exec, dl, popen, pclose, chown, disk_free_space, disk_total_space, diskfreespace, fileinode, max_execution_time, set_time_limit, highlight_file, show_source, phpinfo, chgrp, symlink</pre>
<p>Pokud budete tento parametr používat, dejte si pozor na funkce s obdobnou funkcionalitou, ale jiným názvem. Stejně tak doporučuji bezpečnostní dopad jednotlivých funkcí zvážit - v seznamu výše může být považována za diskutabilní např. funkce <code>phpinfo</code>, která „pouze“ umožňuje zobrazit podrobnou konfiguraci PHP.</p>
<p><code>allow_url_fopen</code> a <code>allow_url_include</code> jsou vhodnými kandidáty na hodnotu „Off“. Umožňují v rámci některých funkcí určených pro práci se soubory získávat data z externích zdrojů (specifikováním URL místo cesty k souboru), což může posloužit k nejrůznějším útokům, pokud není v PHP aplikacích správně ošetřen uživatelský vstup (na což nebývá dobré se spoléhat).</p>
<p><code>open_basedir</code> je Debianem označeno jako „defektní“ (broken) bezpečnostní opatření, a je tudíž v rámci Debianu nepodporované. <code>open_basedir</code> slouží k omezení operací se soubory na seznam adresářů uvedených jako hodnota této volby (adresáře je třeba oddělovat dvojtečkou). Pokud je tato volba ponechána jako neprázdná, nebude možné v rámci korektně ošetřených PHP funkcí použít cestu vedoucí mimo tyto adresáře (resp. použití takové cesty vyvolá chybu). Lepším (resp. jistějším) způsobem zabezpečení může být chroot na úrovni webového serveru (Apache má k tomuto účelu připraven modul <code>chroot</code> v balíčku <code>libapache2-mod-chroot</code>).</p>
<p>Na závěr výčtu důležitých voleb dodávám, že některé z výše uvedených navrhovaných změn mohou mít negativní dopad na některé PHP aplikace. Dodám také, že veškeré změny v <code>php.ini</code> se projeví teprve až se znovunačtením konfigurace webového serveru, tedy v případě Apache po vykonání příkazu:</p>
<pre>/etc/init.d/apache2 reload</pre>
<h5>Staré a nepodporované volby</h5>
<p>Ve výčtu důležitých konfiguračních voleb jsem vynechal dvě, které jsou obecně považovány za zastaralé (deprecated), nepodporované či dokonce za nebezpečné. Jejich výchozí hodnoty jsou obvykle nastaveny na „Off“ a bývá doporučeno je tak ponechat. Jedná se o volby <code>register_globals</code> a <code>safe_mode</code>. První z uvedených je dobře známá a historicky velmi kontroverzní funkce stojící za řadou bezpečnostních zranitelností, zatímco ta druhá je pokusem o zvýšení bezpečnosti na sdíleném hostingu, který se neujal, má některé problémy. Řada webových aplikací jej nemá ráda a je momentálně považován za zastaralý (deprecated) a nepodporovaný.</p>
<h4>Dodatečné zabezpečení PHP: suhosin a suexec</h4>
<p>Mezi dvě dodatečné možnosti zabezpečení PHP patří projekt Suhosin a nástroj (resp. modul) <code>suexec</code>. Projekt Suhosin se sestává jednak z bezpečnostního patche jádra PHP, který se snaží PHP interpret obrnit vůči některým typům útoků, a jednak z rozšíření PHP, které nabízí další možnosti zabezpečení. Interpret PHP v Debianu v sobě již Suhosin patch integruje, ale samotné rozšíření ve výchozí instalaci není. Toto rozšíření je k dispozici v balíku <code>php5-suhosin</code>. Po jeho instalaci budete mít k dispozici jeho konfiguraci v <code>/etc/php5/conf.d/suhosin.ini</code>. Samotnou konfigurací Suhosinu se tento díl zabývat nebude - pokud o toto téma máte zájem, podívejte se na odkazy v závěru článku.</p>
<p>Suexec je modul Apache určený k tomu, aby PHP skript běžel s oprávněními vlastníka daného webu. Tím je řešen bezpečnostní problém v konfiguraci s řadou webů (virtualhostů), kde průnik přes jeden z nich umožní útočníkovi dostat se i k ostatním. Suexec vyžaduje běh PHP v rámci Apache prostřednictvím CGI, tedy přesněji FastCGI. Toto řešení je popsáno třeba v <a href="http://www.root.cz/clanky/oddelte-od-sebe-uzivatele-serveru-apache-a-php/">tomto</a> článku.</p>

<pre id="links">http://www.zaachi.com/cs/items/chybova-hlaseni-v-php.html Chybová hlášení v PHP
http://www.phpfreaks.com/tutorial/hardening-php-with-suhosin/ Hardening PHP with Suhosin
http://www.hardened-php.net/suhosin/configuration.html Suhosin configuration
http://www.debian-administration.org/articles/138 Tightening PHP security
http://www.root.cz/clanky/oddelte-od-sebe-uzivatele-serveru-apache-a-php/ Oddělte od sebe uživatele serveru Apache a PHP</pre>
