<meta http-equiv="content-type" content="text/html;charset=utf-8" />


<h1>Správa linuxového serveru: Nastavení DNS, SPF a Postfix</h1>

<p>Po převážně teoretických dílech následuje díl, ve kterém se dozvíte, jak nainstalovat poštovní server Postfix a provést jeho základní nastavení. Článek také osvětlí nastavení DNS pro poštovní server a SPF, tedy Sender Policy Framework.</p>

<p>Minulé dva díly (<a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-uvod-do-postovniho-serveru">první díl</a>, <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-agenti-e-mailu-metody-ochrany">druhý díl</a>) se věnovaly převážně teorii, nicméně je vhodné si je projít před tímto článkem.</p>
<h3>Nastavení DNS</h3>
<p>Předpokladem pro funkci poštovního serveru je správně nastavené a fungující DNS. U příslušných domén, kterým chcete dělat pošťáka, byste měli mít nastaveny MX záznamy (pokud je nastaveny nemáte, využijí poštovní servery pro doručování pošty A záznam pro danou doménu).</p>
<p>Pomocí MX záznamu můžete specifikovat nejenom jeden nebo více poštovních serverů pro danou doménu, ale také jejich priority (nižší číslo značí vyšší prioritu). Tímto způsobem si můžete vytvářet záložní poštovní servery pro případ, že vám ten hlavní přestane na nějakou dobu fungovat.</p>
<p>Kromě MX záznamu bývá vhodné definovat reverzní záznam pro IP adresu poštovního serveru tak, aby odpovídal jeho plně kvalifikovanému doménovému jménu serveru. Bez toho se vystavujete možnosti, že vaši poštu budou některé servery penalizovat (a možná klasifikovat jako spam) nebo odmítat.</p>
<p>Existují různá dodatečná rozšíření (zpravidla využívající DNS), která pomáhají garantovat původ pošty a omezit šíření spamu. Mezi ty patří zejména SPF, popřípadě DKIM. Jejich implementace není nutná, ale přinejmenším SPF bych implementovat doporučil. Nevyžaduje to žádné úpravy konfigurace, pouze nastavení DNS záznamu.</p>
<h4>SPF</h4>
<p>SPF je zkratka pro Sender Policy Framework. Představuje mechanismus, jímž můžete definovat servery, které mají oprávnění odesílat poštu z vaší domény. Díky tomu mohou ostatní poštovní servery automaticky odmítat poštu, která jako odesílatele (buď v <code>MAIL FROM:</code> v rámci SMTP komunikace, nebo v poli <code>From:</code> v hlavičce e-mailu) specifikuje uživatele z vaší domény, ale posílá ji neautorizovaný server (nejspíše spammer).</p>
<p>Nasazením SPF si také můžete pomoci u antispamu některých poštovních serverů, které mohou vašemu mailu přidat nějaké bodíky k dobru. SPF nastavení se umisťuje do TXT záznamu pro danou doménu.</p>
<p>Informace o SPF můžete nalézt na <a href="http://www.openspf.org/Introduction">webu openspf.org</a> nebo na <a href="http://en.wikipedia.org/wiki/Sender_Policy_Framework">Wikipedii</a>. Nejprostší nastavení může vypadat takto:</p>
<pre>v=spf1 a mx -all</pre>
<p>Záznam je uvozen specifikací verze SPF, tedy <code>v=spf1</code>, následuje specifikace všech počítačů, které jsou nebo nejsou oprávněny odesílat poštu pro danou doménu. Zde je specifikován počítač odpovídající A záznamu domény (identifikátor <code>a</code>) a všechny počítače specifikované v MX záznamech pro danou doménu (identifikátor <code>mx</code>). Ostatní počítače (<code>all</code>) jsou považovány za neautorizované a jejich pošta by se měla odmítat.</p>
<p>U každého prvku můžete znaménkem určit, jak je či není oprávněn odesílat poštu (nespecifikujete-li žádné znaménko, předpokládá se, že daný prvek je povolen):</p>
<ul>
<li>
<p><code>+</code> odesílání pošty je povoleno, zprávy z těchto počítačů by měly být přijaty</p>
</li>
<li>
<p><code>-</code> odesílání pošty je zakázáno, zprávy z těchto počítačů by měly být odmítnuty</p>
</li>
<li>
<p><code>~</code> odesílání pošty je polozakázáno (softfail) – taková pošta by měla projít, ale současně by měla být adekvátně označena</p>
</li>
<li>
<p><code>?</code> neutrální, pro daný prvek není definována žádná politika</p>
</li>
</ul>
<p>Syntax SPF je velmi dobře popsána na <a href="http://www.openspf.org/SPF_Record_Syntax">openspf.org</a>.</p>
<h3>Instalace Postfixu</h3>
<p>Jako téměř vždy, stačí nainstalovat jediný balíček, shodný s názvem nástroje, který chcete nainstalovat. V Debianu byste Postfix nainstalovali takto:</p>
<pre>aptitude install postfix</pre>
<p>Používáte-li standardní, čistou instalaci Debianu, nejspíše budete mírně překvapeni tím, že instalace Postfixu vyžaduje odstranění některých balíčků, konkrétně pak Eximu. Exim je v Debianu výchozím poštovním serverem a nemůže fungovat vedle Postfixu, je tedy třeba jej odstranit.</p>
<p>Během instalace budete dotázáni na variantu nastavení poštovního serveru. V úvahu přichází následující:</p>
<ul>
<li>
<p>Internetový počítač – poštovní server je připojen k internetu, přijímá a odesílá poštu sám</p>
</li>
<li>
<p>Internet se smarthostem – poštovní server je připojen k internetu, poštu přijímá přes SMTP, odesílá ji však přes jiný počítač (např. centrální mailserver ve firmě, mailserver vašeho ISP apod.)</p>
</li>
<li>
<p>Satelitní systém – poštovní server běží pouze na localhostu (není tedy možné na něj doručovat poštu zvenčí) a veškerou poštu odesílá přes jiný počítač</p>
</li>
<li>
<p>Pouze tento počítač – pouze lokální doručování, server není připojen k internetu</p>
</li>
</ul>
<p>Budete také dotázáni na plně kvalifikované doménové jméno vašeho poštovního serveru (FQDN) a některé další otázky v závislosti na tom, které nastavení jste si zvolili. Tyto parametry jsou probrány níže.</p>
<p>Tato nastavení máte kdykoli možnost změnit buď ruční úpravou konfiguračních souborů, nebo opětovným spuštěním konfigurátoru (debconf), což můžete provést příkazem:</p>
<pre>dpkg-reconfigure postfix</pre>
<h3>Základní nastavení Postfixu</h3>
<p>Konfigurace Postfixu je uložena v <code>/etc/postfix</code>, přičemž hlavní konfigurační soubor je <code>/etc/postfix/main.cf</code>. V dalších dílech vás provedu pokročilejší konfigurací, během které se patrně dostaneme i k řadě jiných souborů, ale pro základní nastavení vám stačí výše uvedený hlavní konfigurační soubor.</p>
<p>Základní nastavení Postfixu může vypadat nějak takto:</p>
<pre>myhostname = mail.example.net
mydomain = example.net
myorigin = /etc/mailname
mydestination = example.net, example.org, localhost.localdomain, localhost
relay_domains = $mydestination
relayhost = 
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128
inet_interfaces = all
inet_protocols = all</pre>
<p>Jednotlivé volby by bylo dobré osvětlit jednu po druhé:</p>
<pre>myhostname = mail.example.net</pre>
<p>Toto by mělo být plně kvalifikované doménové jméno (FQDN) vašeho poštovního serveru, tedy v příkladě výše <code>mail.example.net</code>.</p>
<pre>mydomain = example.net</pre>
<p>Proměnná <code>mydomain</code> by měla obsahovat doménovou část vašeho <code>myhostname</code>. V případě <code>mail.example.net</code> to bude <code>example.net</code>.</p>
<pre>myorigin = /etc/mailname</pre>
<p>Doménové jméno, které bude použito pro poštu, která je odesílána lokálně. Pokud tedy jako uživatel přihlášený na server třeba přes SSH odešlete e-mail z příkazové řádky, např. takto:</p>
<pre>echo 'Ahoj, světe.' | mail -s 'Pozdrav' <span class="eaddress">prijemce@mail<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />example<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />eu</span></pre>
<p>bude se v takovém případě jako odesílatel brát <code>uzivatel@myorigin</code>, kde <code>myorigin</code> je hodnota dané proměnné, tj. v příkladu výše to bude hodnota obsažená v souboru <code>/etc/mailname</code>.</p>
<pre>mydestination = example.net, example.org, localhost.localdomain, localhost</pre>
<p><code>mydestination</code> obsahuje seznam domén, pro které bude Postfix poštu přijímat a doručovat do poštovních schránek. Pro tyto domény bude poštovní server cílovým bodem. Všimněte si, že v tomto případě je specifikováno více domén, konkrétně dvě (<code>example.net</code> a <code>example.org</code>).</p>
<pre>relay_domains = $mydestination</pre>
<p>Tato proměnná určuje, pro které domény se bude pošta přeposílat, resp. předávat (relay). Můžete ji ponechat prázdnou, nebo sem dosadit hodnotu proměnné <code>$mydestination</code>, což lze provést způsobem naznačeným výše. Toto je poměrně zajímavá vlastnost nastavení Postfixu – jako součást hodnoty nějaké proměnné můžete použít hodnotu jiné proměnné.</p>
<p>Je klíčové, aby váš poštovní server nefungoval jako „open relay“, tedy server, který ochotně převezme a doručuje jakoukoliv poštu, která k němu přijde a není v <code>mydestination</code>. Takový server se velmi rychle ocitne v blacklistech. Na webu je dostupná množina nástrojů, které vám umožní svůj server otestovat, a já vám důrazně doporučuji některý z těchto nástrojů použít (hledejte „open relay test“), protože pokud to neuděláte vy, spammeři to určitě zkusí.</p>
<pre>relayhost = </pre>
<p>Tato proměnná umožňuje specifikovat cizí poštovní server, kterému bude váš server předávat veškerou poštu, která nebude doručována lokálně. Pošta směřující „ven“ tedy nebude při použití tohoto parametru doručována přímo vaším poštovním serverem, ale odeslána na počítač specifikovaný jako parametr této proměnné.</p>
<pre>mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128</pre>
<p>Počítače specifikované v <code>mynetworks</code> smějí přes váš server odesílat poštu. Je velmi vhodné zde specifikovat pouze místní rozsahy nebo opravdu důvěryhodné sítě.</p>
<pre>inet_interfaces = all</pre>
<p>Tato proměnná určuje, na kterých rozhraních (resp. IP adresách a rozsazích) bude Postfix naslouchat. Pokud zde specifikujete <code>127.0.0.1</code>, váš poštovní server bude k dispozici pouze lokálně a nebude naslouchat na síti. To se hodí, pokud daný počítač neslouží pro příjem pošty. Hodnota <code>all</code> zajistí, že Postfix bude naslouchat na všech dostupných IP adresách.</p>
<pre>inet_protocols = all</pre>
<p>Zde můžete specifikovat, jaké verze IP protokolu bude Postfix používat. V úvahu přichází <code>ipv4</code>, <code>ipv6</code> nebo <code>all</code>. Jsou-li použity oba protokoly, mějte na paměti, že IPv6 v tomto případě dostává přednost, tj. pokud bude moci Postfix doručit poštu na IPv4 i IPv6 adresu, zkusí nejprve IPv6 adresu.</p>
<p>Tolik k základnímu nastavení. Po změně nastavení je vhodné server restartovat:</p>
<pre>/etc/init.d/postfix restart</pre>
<p>Funkčnost serveru můžete otestovat pomocí znalostí z minulých dílů:</p>
<pre>telnet server.example.org 25</pre>
<p>Připomínám, že byste měli určitě otestovat, zda váš server není open relay (viz výše).</p>
<p>Postfix je velmi komplexní nástroj a má široké možnosti nastavení. V odkazech pod článkem naleznete jak odkazy na dokumentaci Postfixu, tak odkazy na wiki různých distribucí, ve kterých existují záznamy o Postfixu.</p>
<p>Tím bych tento díl ukončil. Příště vás provedu podrobnějším nastavením Postfixu.</p>

<pre id="links"></pre>
