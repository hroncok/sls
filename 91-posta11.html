<meta http-equiv="content-type" content="text/html;charset=utf-8" />


<h1>Správa linuxového serveru: Poštovní server a více domén</h1>

<p>Ve chvíli, kdy máte k dispozici více domén, vám už patrně ta nejjednodušší konfigurace poštovního serveru vázaná na unixové účty nebude stačit a začnete se poohlížet po možnostech tvorby virtuálních účtů pro jednotlivé domény. V tomto díle představíme jedno z takových řešení, postavené na webové aplikaci Postfixadmin.</p>

<p>Dosavadní konfigurace poštovního serveru představená v tomto seriálu počítala výhradně s vazbou poštovní schránky na unixové účty. Toto řešení je sice velmi jednoduché na implementaci, ale má několik nevýhod. V první řadě je to nutnost vytvořit unixový účet všem majitelům poštovních schránek. Pokud byste takovému uživateli nechtěli poskytnout přístup k shellu nebo jiným službám vázaným na unixové účty (což je z bezpečnostních důvodů více než rozumné), museli byste to nějakým způsobem ošetřit všude tam, kde se unixové účty používají.</p>
<p>Obsluhuje-li váš server více domén, mohli jste narazit na problém se stejnými jmény na různých doménách. Představte si, že máte unixového uživatele <code>michal</code> a domény <code>example.com</code> a <code>example.net</code>, přičemž poštovní schránky <code><span class="eaddress">michal@example<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />com</span></code> a <code><span class="eaddress">michal@example<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />net</span></code> mají mít jiné vlastníky. Ve výchozí konfiguraci Postfixu by pošta z obou adres směřovala do schránky uživatele <code>michal</code>. Jedno z řešení tohoto problému, spočívající ve vytvoření virtuálních aliasů, které ukazují na různé unixové účty (tedy např. <code><span class="eaddress">michal@example<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />com</span></code> by ukazoval na <code>michal1</code> a <code><span class="eaddress">michal@example<img src="http://www.linuxexpres.cz/modules/marwel/images/tecka.gif" alt="_" />net</span></code> by ukazoval na účet <code>michal2</code>), bylo představeno v <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-aliasy-a-zalozni-postovni-server">tomto</a> dílu. Takové řešení lze použít, dokud nemáte větší množství uživatelů nebo domén.</p>
<p>Jinou možností řešení tohoto problému jsou plně virtuální účty, tzn. zcela izolované účty pro poštu, s vlastním heslem (nezávislým na unixovém) pro každou schránku. Existuje mnoho způsobů, jak takové řešení implementovat. Často se jako úložiště nepoužívají textové soubory, nýbrž databáze (což bude i případ tohoto návodu). Postavíte-li si vlastní řešení, budete si muset ošetřit zakládání, rušení a nastavování účtů. V tomto díle bude uvedeno připravené řešení s využitím Postfixadminu, který správu účtů a domén usnadňuje.</p>
<h3>Postfixadmin</h3>
<p>Postfixadmin je webová aplikace napsaná v PHP, určená pro správu virtuálních poštovních účtů. Má bohaté možnosti konfigurace a poměrně jednoduché rozhraní. Postfixadmin není zázračný nástroj, který vám zpřístupní úplně všechny možnosti nastavení Postfixu v tomto ohledu, ale umožní vám celkem snadnou správu virtuálních účtů.</p>
<h3>Virtuální účty, Postfix a Postfixadmin</h3>
<p>Možnosti Postfixu a jeho nastavení jsou nepřeberné, což by mělo jít částečně poznat i na tomto seriálu, jelikož poštovnímu serveru se věnovalo předchozích deset dílů, což je mnohem více, než bylo věnováno jakémukoliv jinému tématu, a to byly probírány stále spíše jen základy. Řešení popsané v tomto dílu lze také považovat za základní řešení, od kterého se můžete odrazit, přičemž pokročilejší funkce typu kvót či automatické odpovědi v případě nepřítomnosti jsou ponechány na vašem dalším zkoumání Postfixadminu a Postfixu.</p>
<p>Zatímco nastavit Postfixadmin je relativně jednoduché, ke zprovoznění celého řešení bude třeba upravit konfiguraci Postfixu a IMAP/POP3 démona, které nejsou úplně triviální a není těžké v nich udělat chybu. Proto tentokrát více než kdy jindy důrazně nedoporučuji provádět podobné úpravy na produkčních serverech. Doporučuji si toto řešení vyzkoušet někde nanečisto před nasazením.</p>
<h3>Instalace</h3>
<p>Předpokladem pro instalaci Postfixadminu jsou následující komponenty:</p>
<ul>
<li>
<p>webový server (optimálně Apache nebo Lighttpd – tyto dva servery Postfixadmin automaticky nastaví při instalaci)</p>
</li>
<li>
<p>databázový server (MySQL nebo PostgreSQL, návod bude počítat s MySQL)</p>
</li>
<li>
<p>PHP interpret (balíček <code>php5</code> s příslušným konektorem k databázovému serveru, tj. <code>php5-mysql</code> nebo <code>php5-pgsql</code>)</p>
</li>
<li>
<p>Postfix s podporou vámi zvolené databáze (balíček <code>postfix-mysql</code> nebo <code>postfix-pgsql</code>)</p>
</li>
<li>
<p>IMAP/POP3 server (Dovecot či Courier, návod bude počítat s Dovecotem)</p>
</li>
</ul>
<p>Nemáte-li výše uvedené komponenty nainstalované, učiňte tak před instalací Postfixadminu.</p>
<p>Podstatnou informací je, že Postfixadmin není součástí repozitářů Debianu Squeeze. K dispozici je až pro Debian 7.0 s označením Wheezy. Používáte-li Debian Squeeze, stáhněte si <code>deb</code> balíček ze <a href="http://postfixadmin.sourceforge.net/">stránek projektu</a> a nainstalujte jej pomocí nástroje <code>dpkg</code>:</p>
<pre style="margin-bottom: 0.5cm;">dpkg -i balicek.deb</pre>
<p>Používáte-li Debian Wheezy, mělo by stačit použít Aptitude:</p>
<pre style="margin-bottom: 0.5cm;">aptitude install postfixadmin</pre>
<p>Pozor – budete-li využívat Postfixadmin na Debianu Squeeze, budete muset řešit aktualizace Postfixadminu ručně. Naopak, používáte-li Debian Wheezy, berte na vědomí, že návod je otestován pouze v Debianu Squeeze. Zní to komplikovaně, ale není :)</p>
<p>Během instalace vás Debconf vyzve, abyste vybrali webový server pro automatickou konfiguraci a abyste vybrali databázový server. Následující text bude předpokládat MySQL jako databázový server. Chcete-li používat PostgreSQL, nahlédněte do dokumentace (některé databázové dotazy se budou lišit, nestačí tedy jen přepsat <code>mysql</code> za <code>pgsql</code>). Návod pro PostgreSQL naleznete i v odkazech pod článkem.</p>
<h3>Integrace s webovým serverem</h3>
<p>Po instalaci by měl být váš webový server pro Postfixadmin nastavený, tedy za předpokladu, že jste použili některý z výše uvedených (Apache nebo Lighttpd). Používáte-li Apache, naleznete jeho konfigurační soubor v <code>/etc/postfixadmin/apache.conf</code> (v případě Lighttpd je to <code>/etc/postfixadmin/lighttpd.conf</code>). Vzhledem k povaze aplikace lze důrazně doporučit omezení přístupu k ní jednak na nějaký SSL virtuální web, aby hesla neputovala k serveru nešifrovaná, a jednak libovolným dalším způsobem dle vlastního uvážení (omezení na IP adresy, HTTP autentifikace atd.).</p>
<p>Úprava je jednoduchá – nejprve odstraňte symbolický odkaz <code>/etc/apache2/conf.d/postfixadmin</code>, který vkládá daný alias do všech vašich virtuálních webů (virtual host). Následně si vyberte některý z vašich existujících virtuálních webů (ideálně takový, který je chráněn SSL), popřípadě si vytvořte nový a doplňte do něj vyznačenou řádku:</p>
<pre>&lt;VirtualHost 1.2.3.4:443&gt;

        ServerName www.example.cz
        ServerAlias example.cz

        <strong>Alias /postfixadmin /usr/share/postfixadmin</strong>

        DocumentRoot /var/www/example.cz/www
        &lt;Directory "/var/www/example.cz/www"&gt;
                Order allow,deny
                Allow from all
        &lt;/Directory&gt;

        SSLEngine On
        SSLCertificateFile /etc/apache2/example-cz-certifikat.pem
        SSLCACertificateFile /etc/apache2/ssl-ca.pem

&lt;/VirtualHost&gt;
Volitelně pak doplňte omezení k přístupu na daný web. Alias si samozřejmě můžete upravit a místo <code>/postfixadmin</code> zvolit něco jiného, kratšího.</pre>
<p class="poznámka-na-okraj">Dodám, že nastavení Apache, tvorbě virtuálních webů, práci s aliasy, SSL a omezení přístupu k webům na základě IP adres se věnoval <em>Úvod do konfigurace Apache</em> (<a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-uvod-do-konfigurace-apache">1. díl</a> a <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-uvod-do-konfigurace-apache-1">2. díl</a>). Budete-li pracovat se SSL, hodí se vám ještě <a href="http://www.linuxexpres.cz/praxe/sprava-linuxoveho-serveru-sni-webove-servery-a-prohlizece">díl o SNI</a>.</p>
<h3>Nastavení Postfixadminu</h3>
<p>Webový server byste v tuto chvíli měli mít nastavený a k Postfixadminu byste měli být schopni se dostat prostřednictvím aliasu <code>/postfixadmin</code>. Jako první byste měli spustit <code>setup.php</code>:</p>
<pre style="margin-bottom: 0.5cm;">https://server.example.org/postfixadmin/setup.php</pre>
<p>Nejprve budete požádáni o správcovské heslo. Jakmile jej zadáte, vygeneruje se vám řádka, kterou vložíte do <code>/etc/postfixadmin/config.inc.php</code>, resp. kde nahradíte existující proměnnou <code>$CONF['setup_password']</code>. Následně si vytvořte administrátorský účet (podmínkou je platný e-mail a správcovské heslo, které jste si nastavili dříve).</p>
<p>Nyní byste měli ještě jednou upravit <code>/etc/postfixadmin/config.inc.php</code>, projít si jej a přizpůsobit si jeho obsah. Přinejmenším si upravte následující proměnné:</p>
<ul>
<li>
<p><code>$CONF['admin_email']</code> e-mail, ze kterého se bude odesílat e-mail do nově založených poštovních schránek</p>
</li>
<li>
<p><code>$CONF['default_aliases']</code> výchozí aliasy, které bude Postfixadmin vytvářet pro novou doménu, pokud jej o to požádáte</p>
</li>
<li>
<p><code>$CONF['footer_link']</code> kam povede odkaz v patičce</p>
</li>
<li>
<p><code>$CONF['footer_text']</code> jaký bude mít odkaz v patičce text</p>
</li>
</ul>
<p>Dokumentace k Postfixadminu je po instalaci k dispozici v <code>/usr/share/doc/postfixadmin</code>.</p>
<h3>Logika ovládání Postfixadminu</h3>
<p>Hlavním uživatelem je správce, kterého jste si vytvořili výše. Správce může definovat další správce, kteří pak budou mít na starost nějaké domény (které, to můžete specifikovat). Zatímco hlavní správce může pořizovat zálohu databáze (karta <strong>Backup</strong>), tvořit domény a další správce, správci konkrétních domén tato privilegia nemají, jsou omezeni na konkrétní domény. V podobném duchu jsou omezené aliasy – alias vytvořený hlavním správcem nelze upravovat nebo mazat s právy správce domény. U poštovních schránek to však neplatí. Pro jednotlivé domény je možné specifikovat omezení v počtu schránek a aliasů, které jsou pak pro správce domén závazné.</p>
<p>Jednotlivé účty jsou samozřejmě vázány ke konkrétním doménám. Autentifikační údaje tedy tvoří login, což je celý e-mail včetně doménové části, a heslo, které je definováno v příslušné databázové tabulce spravované Postfixadminem.</p>
<p>Operace realizované v prostředí Postfixadminu se logují a jak hlavní správce, tak správci domén mají přehled, které operace byly kdy provedeny.</p>
<p>Postfixadmin umožňuje také nadefinovat automatické stahování pošty z cizích POP3/IMAP serverů do konkrétních poštovních schránek. Tato funkčnost je však vázána na příslušná nastavení, která v tomto seriálu probrána nebudou. V odkazech pod článkem však naleznete návod, jak tuto funkčnost zprovoznit.</p>
<p>Tímto bych tento díl ukončil. Propojení s Postfixem a Dovecotem bude probráno v příštím dílu.</p>

<pre id="links">http://postfixadmin.sourceforge.net/ Postfixadmin: web projektu
http://codepoets.co.uk/2009/postfixadmin-setupinstall-guide-for-virtual-mail-users-on-postfix/ Postfixadmin – setup/install guide for virtual mail users on Postfix
http://postfix.wiki.xs4all.nl/index.php?title=Virtual_Users_and_Domains_with_Courier-IMAP_and_MySQL Virtual Users and Domains with Courier-IMAP and MySQL
http://wiki.dovecot.org/HowTo/DovecotLDAPostfixAdminMySQL Howto Setup a Mail Server with Virtual Users and Domains
http://postfixmail.com/blog/index.php/postfixadmin-and-fetchmail/ PostfixAdmin and Fetchmail</pre>
