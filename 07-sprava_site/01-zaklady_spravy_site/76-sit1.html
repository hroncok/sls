<meta http-equiv="content-type" content="text/html;charset=utf-8" />


<h1>Správa linuxového serveru: Nastavení sítě pomocí nástroje ip</h1>

<p>V tomto dílu vám představím nástroj ip, který již dlouho nabízí alternativu k zastaralému, avšak stále rozšířenému a používanému nástroji ifconfig.</p>

<h3>Úvod a ifconfig</h3>
<p>V knihách, článcích, návodech a dokumentaci se často setkáte s nástrojem <code>ifconfig</code> (a dále nástroji <code>arp</code> a <code>route</code>, které jeho funkčnost doplňují). Možná jste si jej díky tomu osvojili a aktivně jej používáte. Tyto nástroje jsou však již dlouhou dobu považovány za zastaralé, jelikož nerespektují změny v síťovém subsystému linuxového jádra, a to už od řady 2.2. Jejich použití může být kvůli tomu za určitých okolností problematické až potenciálně nebezpečné, pokud si nejste případných úskalí dobře vědomi.</p>
<p>Jistě tušíte, jak nahodit síťové rozhraní a IP adresu. Pomocí nástroje <code>ifconfig</code> byste to provedli takto:</p>
<pre>ifconfig eth0 down # shození rozhraní eth0
ifconfig eth0 up # nahození rozhraní eth0
ifconfig eth0 192.168.12.12 netmask 255.255.255.0 # nastavení IP adresy a masky</pre>
<p>Co když ale chcete přiřadit jednomu rozhraní více IP adres? Na serveru je to celkem častý požadavek (např. více IP adres pro SSL virtuální weby). Linux to samozřejmě umí, avšak <code>ifconfig</code> nikoliv. V jeho případě si musíte pomoci jistou obezličkou:</p>
<pre>ifconfig eth0 192.168.12.12 netmask 255.255.255.0
ifconfig eth0:0 192.168.13.13 netmask 255.255.255.0
ifconfig eth0:1 192.168.14.14 netmask 255.255.255.0</pre>
<p>V tomto případě je třeba zdůraznit, že rozhraní <code>eth0:0</code> a <code>eth0:1</code> jsou sice někde označovaná jako „virtuální“, ale ve skutečnosti se jedná o aliasy daných IP adres, tedy aliasy původního rozhraní.</p>
<p>V případě nástroje <code>ip</code> je možné přidávat IP adresy bez jakýchkoliv obezliček:</p>
<pre>ip addr add 192.168.12.12/24 brd + dev eth0
ip addr add 192.168.13.13/24 brd + dev eth0</pre>
<p>Problém nastane tehdy, pokud vy (nebo nějaký skript) použije některé z pokročilejších (nebo se starými nástroji nekompatibilních) funkcí nástroje <code>ip</code>. <code>ifconfig</code> vám pak může lhát nebo nasekat neplechu, když přepíše vaše nastavení. Příkladem může být i výše uvedené nastavení více IP adres jednomu rozhraní pomocí nástroje <code>ip</code>. Jelikož nástroj <code>ip</code> běžně k IP adresám aliasy nedefinuje, pak, pokud pomocí něj přiřadíte nějakému rozhraní více IP adres, <code>ifconfig</code> vám je u daného rozhraní nezobrazí:</p>
<pre>root@debian ~# ip addr add 192.168.12.12/24 brd + dev eth1
root@debian ~# ip addr add 192.168.13.13/24 brd + dev eth1
root@debian ~# ifconfig eth1

eth1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500  metric 1
        inet <strong>192.168.12.12</strong>  netmask 255.255.255.0  broadcast 192.168.12.255
        inet6 fe80::20a:aff:febc:1c20  prefixlen 64  scopeid 0x20&lt;link&gt;
        ether 00:0a:0a:bc:1c:20  txqueuelen 1000  (Ethernet)
        RX packets 629  bytes 42106 (41.1 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 11  bytes 678 (678.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

root@debian ~# ip addr show eth1
3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UNKNOWN qlen 1000
    link/ether 00:0a:0a:bc:1c:20 brd ff:ff:ff:ff:ff:ff
    inet <strong>192.168.12.12/24</strong> brd 192.168.12.255 scope global eth1
    inet <strong>192.168.13.13/24</strong> brd 192.168.13.255 scope global eth1
    inet6 fe80::20a:aff:febc:1c20/64 scope link 
       valid_lft forever preferred_lft forever</pre>
<p>Jak je vidět (IP adresy ve výpisech jsou zvýrazněny tučně), <code>ifconfig</code> v tomto příkladu zobrazuje pouze první nastavenou IP adresu, druhou úspěšně ignoruje. Nástroj <code>ip</code> zobrazuje obě.</p>
<p>V zásadě, pokud budete používat výhradně starší nástroje <code>ifconfig</code>, <code>arp</code> a <code>route</code>, a zároveň budete využívat pouze tu funkcionalitu, kterou tyto nástroje umí, neměli byste narazit na problém. Pokud však budete používat nástroj <code>ip</code>, načež si usmyslíte, že použijete <code>ifconfig</code>, můžete v určitých situacích narazit na problém.</p>
<p>Nástroj <code>ip</code> umí nejenom to, co umí nástroje <code>ifconfig</code>, <code>arp</code> a <code>route</code> dohromady, ale také řadu dalších věcí. Kromě toho nástroj <code>ip</code> respektuje současný návrh síťového subsystému jádra Linuxu a jeho možnosti.</p>
<h3>Instalace</h3>
<p>Nástroj <code>ip</code> bývá součástí moderních distribucí. Pokud ho ve své instalaci nenajdete, pak vám stačí nainstalovat balíček <code>iproute2</code>, což v Debianu provedete takto:</p>
<pre>aptitude install iproute2</pre>
<p>Dlužno dodat, že ve standardní instalaci Debianu Squeeze je již tento balíček obsažen.</p>
<h3>Úvod do nástroje ip</h3>
<p>Syntaxe nástroje <code>ip</code> je poměrně odlišná od nástroje <code>ifconfig</code> (a jeho dvou bratrů), avšak umí toho hodně a podporuje krátké zápisy, které vám šetří ruce, pokud je zadáváte ručně.</p>
<p>Prvním parametrem příkazu <code>ip</code> je vždy „modul“, se kterým chcete pracovat. To může být síťové rozhraní, IP adresa, směrovací tabulka, ARP tabulka apod.:</p>
<pre>ip link       # operace se síťovými rozhraními
ip addr       # operace s IP adresami
ip route      # operace se směrovací tabulkou
ip neigh      # operace s ARP tabulkou
ip rule       # operace se směrovacími pravidly</pre>
<p>Těchto „modulů“ je o několik více, nicméně tyto je možné považovat za nejběžnější. Jednotlivé parametry mají samozřejmě svoje zkrácené varianty:</p>
<pre>ip li         # operace se síťovými rozhraními
ip a          # operace s IP adresami
ip r          # operace se směrovací tabulkou
ip n          # operace s ARP tabulkou
ip ru         # operace se směrovacími pravidly</pre>
<p>Každý z těchto modulů má svou specifickou syntax. V rychlosti si ji můžete nechat vypsat, pokud budete tápat:</p>
<pre>ip help
ip addr help</pre>
<p>Pokud vám nápověda nestačí, můžete použít manuálové stránky:</p>
<pre>man ip</pre>
<p>Pro rychlý výpis např. IP adres nemusíte zadávat kromě modulu žádné další parametry:</p>
<pre>root@debian ~# ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000
    link/ether 64:31:50:74:1e:c6 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::6631:50ff:fe74:1ec6/64 scope link 
       valid_lft forever preferred_lft forever</pre>
<h3>Práce se síťovými rozhraními</h3>
<p>Základní operace se síťovými rozhraními jsou určitě jejich nahození a shození:</p>
<pre>ip link set dev eth0 up     # nahození rozhraní
ip link set dev eth0 down   # shození rozhraní</pre>
<p>To je trošku nešťastný začátek, jelikož zrovna v tomto případě je syntaxe nástroje <code>ifconfig</code> úspornější:</p>
<pre>ifconfig eth0 up
ifconfig eth0 down</pre>
<p class="box">Při této práci s rozhraními si dejte pozor, abyste nebyli na server připojeni přes SSH, protože pokud shodíte rozhraní, přes které jste připojeni, pak ho už nenahodíte.</p>
<p>Ale zpět k nástroji <code>ip</code>. Ten umí měnit nejenom stav rozhraní, ale také řadu jejich parametrů. Mnoho z nich se dočtete v manuálu, já zmíním dva nejběžnější. Prvním je MAC adresa, kterou můžete změnit i bez nástroje <code>ethtool</code>, takto:</p>
<pre>ip link set dev eth0 address 11:22:33:44:55:66</pre>
<p>Dalším parametrem, který můžete chtít někdy změnit, je <a href="http://cs.wikipedia.org/wiki/Maximum_transmission_unit">MTU</a>, tedy maximální velikost IP datagramu, kterou dané rozhraní zpracuje. V případě ethernetu je to nejčastěji 1500 bytů:</p>
<pre>ip link set dev eth0 mtu 1500</pre>
<p>Jednotlivá rozhraní si samozřejmě můžete nechat vypsat:</p>
<pre>root@debian ~# ip link show
1: lo:  mtu 16436 qdisc noqueue state UNKNOWN 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: eth0:  mtu 1400 qdisc pfifo_fast state UP qlen 1000
    link/ether 64:31:50:74:1f:c7 brd ff:ff:ff:ff:ff:ff
3: eth1:  mtu 1500 qdisc pfifo_fast state UNKNOWN qlen 1000
    link/ether 00:0a:0a:bc:1c:20 brd ff:ff:ff:ff:ff:ff
4: wlan0:  mtu 1500 qdisc mq state UP qlen 1000
    link/ether e0:2a:82:45:f4:56 brd ff:ff:ff:ff:ff:ff</pre>
<p>Můžete si nechat vypsat konkrétní rozhraní:</p>
<pre>root@debian ~# ip link show dev eth0
2: eth0:  mtu 1400 qdisc pfifo_fast state UP qlen 1000
    link/ether 64:31:50:74:1f:c7 brd ff:ff:ff:ff:ff:ff</pre>
<p>Nebo si můžete nechat vypsat pouze aktivní rozhraní:</p>
<pre>ip link show up</pre>
<h3>Práce s IP adresami</h3>
<p>Jak víte, na síti je každý počítač identifikován IP adresou. Abyste tedy mohli komunikovat po síti, musíte nastavit nějakému dostupnému síťovému rozhraní IP adresu. Přidání IP adresy konkrétnímu rozhraní se tu již objevilo:</p>
<pre>ip addr add 10.0.4.16/24 dev eth1</pre>
<p>Tato syntaxe přidá danou IP adresu s maskou v CIDR notaci (tzn. <code>/24</code> je ekvivalentem masky <code>255.255.255.0</code>). Není potřeba nějaký zvláštní parametr pro přidání další IP adresy. Jednomu rozhraní můžete přiřadit tolik IP adres, kolik chcete. Na serverech bývá obvyklé mít více IP adres, ať již IPv4, nebo IPv6.</p>
<p>Připomínám, že můžete použít kratší zápis:</p>
<pre>ip a a 10.0.4.16/24 dev eth1</pre>
<p>Chcete-li specifikovat konkrétní broadcast adresu, můžete použít tuto syntaxi:</p>
<pre>ip addr add 10.0.4.16/24 brd 10.0.4.255 dev eth1</pre>
<p>Adresu pro broadcast můžete specifikovat v kratší podobě, nejspíše pomocí <code>+</code>, kde se jako broadcast nastaví adresa s jedničkami v těch bitech, které odpovídají síťovému rozhraní v dané síťové masce:</p>
<pre>ip addr add 10.0.4.16/24 brd + dev eth1</pre>
<p>IP adresu samozřejmě můžete i zrušit:</p>
<pre>ip addr del 10.0.4.16/24 dev eth1</pre>
<p>Máte-li přiřazeno více IP adres jednomu rozhraní a chcete-li je smazat všechny, můžete použít parametr <code>flush</code>:</p>
<pre>ip a flush dev eth1</pre>
<h4>Příklad: vytvoření jednoduché místní sítě mezi dvěma počítači</h4>
<p>Pro ilustraci, pokud byste měli dva počítače, propojili je kříženým síťovým kabelem a chtěli si vytvořit jednoduchou síť, postupovali byste tak, že byste nejprve nahodili příslušná rozhraní (obvykle <code>eth0</code>), a poté byste jednotlivým rozhraním na každém počítači přiřadili IP adresu, samozřejmě u každého počítače jinou, ale se stejnou síťovou maskou. Tudíž byste na jednom počítači zadali tyto dva příkazy:</p>
<pre>ip link set dev eth0 up
ip addr add 10.0.1.1/24 dev eth0</pre>
<p>A na druhém pak tyto:</p>
<pre>ip link set dev eth0 up
ip addr add 10.0.1.2/24 dev eth0</pre>
<p>Poté byste měli být schopni komunikovat:</p>
<pre>ping 10.0.1.1</pre>
<p>Tím bych tento díl ukončil. Příště se dozvíte více o práci s ARP tabulkami a o směrování.</p>

<pre id="links">http://linux-ip.net/html/index.html Guide to IP Layer Network Administration with Linux
http://jazstudios.blogspot.com/2007/04/iproute-commands.html Iproute commands
http://www.linuxfoundation.org/collaborate/workgroups/networking/ Kernel networking
http://www.policyrouting.org/iproute2.doc.html IPROUTE2 Utility Suite Howto
http://lartc.org/howto/index.html Linux Advanced Routing & Traffic Control HOWTO
http://web.archive.org/web/20090309011121/http://www.m4r3k.org/czech/proc-nepouzivat-ifconfig/ Marek Stopka, Proč nepoužívat ifconfig?
http://www.faqs.org/docs/Linux-mini/IP-Alias.html Setting up IP Aliasing on A Linux Machine Mini-HOWTO</pre>
