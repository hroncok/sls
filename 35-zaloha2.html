<meta http-equiv="content-type" content="text/html;charset=utf-8" />


<h1>Správa linuxového serveru: Jednoduché zálohování pomocí rdiff-backup</h1>

<p>V tomto dílu vám ukáži, jak využít nástroje rdiff-backup k zálohování dat a k případné obnově.</p>

<h3>Úvod</h3>
<p>Nástroj <code>rdiff-backup</code> je napsaný v Pythonu, umí rozdílové zálohování a umí pracovat jak lokálně, tak vzdáleně. Unikátní vlastností tohoto nástroje je podoba zálohy. Nástroj totiž vytváří de facto „zrcadlový“ obraz původních dat, který uchovává v aktuální podobě, zatímco rozdíly si zaznamenává do speciálního adresáře. To znamená, že máte vždy k dispozici aktuální verze souborů přístupné přímo z cílového souborového systému, a to bez nutnosti použít nástroj <code>rdiff-backup</code>. K obnovení dat z poslední zálohy tak stačí pouhé překopírování. Oproti jiným nástrojům (např. <code>duplicity</code>) naopak <code>rdiff-backup</code> neumí ani kompresi dat, ani šifrování. Jediné, co se komprimuje, jsou samotné rozdíly.</p>
<p>Ačkoliv je <code>rdiff-backup</code> schopen pracovat vzdáleně, doporučuje se, je-li to možné, použít stejnou verzi nástroje na obou počítačích. V případě nesouladu verzí vypíše nástroj varování.</p>
<p><code>Rdiff-backup</code> umí využívat přenosové pásmo podobně efektivně jako nástroj <code>rsync</code> (tomuto nástroji se věnuje článek <a href="http://www.linuxexpres.cz/praxe/zalohuj-sva-data-tolikrat-kolikrat-je-mas-rad">Zálohuj svá data tolikrát, kolikrát je máš rád</a>), takže při následných zálohách se vždy přenáší pouze rozdíly a nikoliv znovu veškerá data.</p>
<h3>Archfs</h3>
<p>Nasazení nástroje <code>rdiff-backup</code> může vhodně doplnit FUSE modul <code>archfs</code>, který umí připojit adresář se zálohami jako souborový systém, přes který je možné snadno prohlížet data jednotlivých záloh (ty jsou pak dostupné jako adresáře, jejichž název odpovídá datu pořízení). Bohužel tento FUSE modul není k dispozici v oficiálních repozitářích Debianu pro vydání Lenny ani Squeeze, který je momentálně na spadnutí. K dispozici je až ve větvi Sid (unstable), kterou ovšem rozhodně nelze doporučit k používání na serveru.</p>
<h3>Místní záloha</h3>
<p>Nejjednodušší příklad použití nástroje <code>rdiff-backup</code> je místní záloha, tzn. záloha v rámci jednoho počítače. V takovém případě je už z principu velmi vhodné zálohovat na jiné médium, než na kterém se nachází zdrojová data. Pokud by byla data k zálohování v adresáři <code>/home/data</code> a připojený externí disk v /mnt/extdisk, záloha by se provedla takto:</p>
<pre>rdiff-backup /home/data /mnt/extdisk</pre>
<p>Každé provedení tohoto příkazu způsobí aktualizaci souborů zálohy do stejného stavu jako ve zdrojovém adresáři, přičemž informace o rozdílech se ukládají do speciálního adresáře pojmenovaného <code>rdiff-backup-data</code>.</p>
<p>Ne vždy je ale žádoucí zálohovat veškerá data ve zdrojovém adresáři. Proto má nástroj <code>rdiff-backup</code> bohaté možnosti pro specifikaci dat, která nemají být zálohována ze zdrojového adresáře. Nejjednodušší metodou je použít parametr <code>--exclude</code>:</p>
<pre>rdiff-backup --exclude /home/data/vyradit /home/data /mnt/extdisk</pre>
<p>Všimněte si, že parametry a volby předcházejí specifikaci zdroje a cíle – toto pořadí je nutné dodržovat. Potřebujete-li vyřadit více souborů či adresářů, použijte parametr <code>--exclude</code> vícekrát za sebou:</p>
<pre>rdiff-backup --exclude /home/data/vyradit1 --exclude /home/data/vyradit2 /home/data /mnt/extdisk</pre>
<p>Možné je i vyřadit určité typy souborů, třeba zařízení (device files), symbolické linky, sokety apod., např. takto:</p>
<pre>rdiff-backup --exclude-device-files /home/chroot /mnt/extdisk</pre>
<p>Výše uvedený příkaz nebude zálohovat soubory zařízení (device files). <code>Rdiff-backup</code> nabízí řadu dalších možností filtrování souborů včetně regulárních výrazů. Ty naleznete popsané v manuálové stránce.</p>
<h3>Vzdálená záloha</h3>
<p>Vzdálené zálohování je řešeno prostřednictvím SSH. Jak již bylo řečeno, dalším předpokladem je dostupnost nástroje <code>rdiff-backup</code> na cílovém počítači, pokud možno ve stejné verzi jako na zdrojovém. Zálohování na vzdálený počítač pak může vypadat třeba takto:</p>
<pre>rdiff-backup /home/data uzivatel@server::/cilovy/adresar</pre>
<p>Problémem, na který můžete při vzdáleném zálohování narazit, je problém s metadaty souborů, tzn. s vlastnictvím a oprávněními. Dojde k tomu třeba v situaci, kdy zálohujete data vlastněná uživatelem, který na cílovém systému neexistuje, nebo třeba v situaci, kdy zálohujete data vlastněná uživatelem root, zatímco na cílový systém se hlásíte s právy obyčejného uživatele. <code>Rdiff-backup</code> si naštěstí metadata zapisuje zvlášť, takže pokud k obnově použijete právě tento nástroj, informace o vlastnictví a oprávněních se přenese korektně. Pokud byste ale obnovovali prostým překopírováním, data by se obnovila se špatnými právy, vlastníkem či skupinou.</p>
<h3>Obnova dat</h3>
<p>Pokud dojde k nějakému problému a potřebujete provést obnovu, můžete aktuální data rovnou zkopírovat (pozor ale na problém s metadaty souborů – viz výše) nebo použít příkaz níže, kde na pozici zdroje uvedete zálohu a na pozici cíle adresář, kam se mají data obnovit. Nutné je také specifikovat čas, ke kterému budou data ze záloh obnovena, pomocí parametru <code>-r</code>. Pokud vám stačí nejnovější data, můžete použít časovou značku <code>now</code>, takto:</p>
<pre>rdiff-backup -r now uzivatel@server::/zaloha /tmp/obnova</pre>
<p>Jelikož <code>rdiff-backup</code> provádí rozdílové zálohování, můžete obnovit i stav k určitému datu nebo stav k určité provedené záloze. Můžete také specifikovat relativní čas (např. stav před dvaceti dny), takto:</p>
<pre>rdiff-backup -r 20D /zaloha /tmp/obnova</pre>
<p>Stav k určitému datu můžete obnovit takto:</p>
<pre>rdiff-backup -r 2010-12-30 /zaloha /tmp/obnova</pre>
<p>Je také možné obnovit stav k určité provedené záloze, tzn. chcete-li obnovit stav k sedmé nejnovější záloze, použijete následující příkaz:</p>
<pre>rdiff-backup -r 7B /zaloha /tmp/obnova</pre>
<p>Vývojáři nástroje <code>rdiff-backup</code> se snaží, aby bylo jeho použití bezpečné. Proto vám tento nástroj standardně neumožní např. přepsat existující data při obnově či jiné potenciálně rizikové operace. Pokud jste si opravdu jisti, že chcete danou operaci provést, i když vás nástroj tímto způsobem varuje, můžete použít parametr <code>--force</code>.</p>
<h3>Zajištění pravidelného zálohování</h3>
<p>Abyste zajistili pravidelné zálohování, postačí přidat příslušný příkaz do cronu, popřípadě si vytvořit skript, přidat mu právo ke spuštění a umístit jej do vhodného adresáře (pro spouštění každý den by to byl adresář <code>/etc/cron.daily</code>). Pokud by v rámci běhu nástroje došlo k chybě, měl by cron informovat uživatele root mailem.</p>
<h3>Čištění úložiště od starých záloh</h3>
<p>Jelikož zálohovaná data se časem nahromadí a začnou zabírat nemalý prostor, je dobré vědět, jakým způsobem stará data bezpečně odmazat. K tomuto slouží parametr <code>--remove-older-than</code>, jehož hodnotou je buď absolutní, nebo relativní čas. Drobným problémem je, že v jednom volání nástroje <code>rdiff-backup</code> není možné současně mazat stará data a spolu s tím i zálohovat. Musíte tedy provádět čištění záloh zvlášť, třeba takto:</p>
<pre>rdiff-backup /home/data /mnt/extdisk
rdiff-backup --remove-older-than 30D /mnt/zaloha</pre>
<p>Kromě relativního nebo absolutního času je možné specifikovat i počet záloh, které se mají nechat, tzn. pokud chcete nechat pouze deset posledních záloh a ostatní smazat, použijete následující příkaz:</p>
<pre>rdiff-backup --remove-older-than 10B /mnt/zaloha</pre>

<pre id="links">http://www.nongnu.org/rdiff-backup/ Web projektu rdiff-backup</pre>
